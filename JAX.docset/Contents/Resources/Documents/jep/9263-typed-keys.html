
<!DOCTYPE html>

<html data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>JEP 9263: Typed keys &amp; pluggable RNGs â€” JAX  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css?v=a746c00c" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/sphinx-book-theme.css?v=384b581d" rel="stylesheet" type="text/css"/>
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css"/>
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css?v=02ed413a" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/documentation_options.js?v=9eb32ce0"></script>
<script src="../_static/doctools.js?v=9a2dae69"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../_static/copybutton.js?v=f281be69"></script>
<script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
<script src="../_static/design-tabs.js?v=36754332"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'jep/9263-typed-keys';</script>
<link href="../_static/favicon.png" rel="icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="9407-type-promotion.html" rel="next" title="Design of Type Promotion Semantics for JAX"/>
<link href="4410-omnistaging.html" rel="prev" title="Omnistaging"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<a class="skip-link" href="#main-content" id="pst-skip-link">Skip to main content</a>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar">
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="../index.html">
<img alt="JAX  documentation - Home" class="logo__image only-light" src="../_static/jax_logo_250px.png"/>
<script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
</a></div>
<div class="sidebar-primary-item">
<script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">ðŸ”ª JAX - The Sharp Bits ðŸ”ª</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guide.html">Advanced Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiffâ€™s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../contributor_guide.html">Developer Documentation</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="index.html">JAX Enhancement Proposals (JEPs)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">JAX Glossary of Terms</a></li>
</ul>
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<a class="btn btn-sm btn-source-repository-button" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/google/jax" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../_sources/jep/9263-typed-keys.md" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.md</span>
</a>
</li>
<li>
<button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>JEP 9263: Typed keys &amp; pluggable RNGs</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-does-this-mean-for-users">What does this mean for users?</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detecting-new-style-typed-keys">Detecting new-style typed keys</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-annotations-for-prng-keys">Type annotations for PRNG Keys</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notes-for-jax-library-authors">Notes for JAX library authors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#customizing-prng-implementations">Customizing PRNG implementations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#safe-prng-key-use">Safe PRNG key use</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-buffer-indexing">Key buffer indexing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-arithmetic">Key arithmetic</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inadvertent-transposing-of-key-buffers">Inadvertent transposing of key buffers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-reuse">Key reuse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-of-typed-prng-keys">Design of typed PRNG keys</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-dtypes">Extended dtypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prng-dtypes">PRNG dtypes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#progress">Progress</a></li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<section class="tex2jax_ignore mathjax_ignore" id="jep-9263-typed-keys-pluggable-rngs">
<a class="dashAnchor" name="//apple_ref/cpp/Section/JEP 9263: Typed keys &amp; pluggable RNGs"></a><span id="jep-9263"></span><h1>JEP 9263: Typed keys &amp; pluggable RNGs<a class="headerlink" href="#jep-9263-typed-keys-pluggable-rngs" title="Link to this heading">#</a></h1>
<p><em>Jake VanderPlas, Roy Frostig</em></p>
<p><em>August 2023</em></p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Going forward, RNG keys in JAX will be more type-safe and customizable.
Rather than representing a single PRNG key by a length-2  <code class="docutils literal notranslate"><span class="pre">uint32</span></code> array,
it will be represented as a scalar array with a special RNG dtype that
satisfies <code class="docutils literal notranslate"><span class="pre">jnp.issubdtype(key.dtype,</span> <span class="pre">jax.dtypes.prng_key)</span></code>.</p>
<p>For now, old-style RNG keys can still be created with
<a class="reference internal" href="../_autosummary/jax.random.PRNGKey.html#jax.random.PRNGKey" title="jax.random.PRNGKey"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.PRNGKey()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">Array([0, 0], dtype=uint32)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(2,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">dtype('uint32')</span>
</pre></div>
</div>
<p>Starting now, new-style RNG keys can be created with
<a class="reference internal" href="../_autosummary/jax.random.key.html#jax.random.key" title="jax.random.key"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.key()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">Array((), dtype=key&lt;fry&gt;) overlaying:</span>
<span class="go">[0 0]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="o">.</span><span class="n">shape</span>
<span class="go">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">key&lt;fry&gt;</span>
</pre></div>
</div>
<p>This (scalar-shaped) array behaves the same as any other JAX array, except
that its element type is a key (and associated metadata). We can make
non-scalar key arrays as well, for example by applying <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a> to
<a class="reference internal" href="../_autosummary/jax.random.key.html#jax.random.key" title="jax.random.key"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.key()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key_arr</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key_arr</span>
<span class="go">Array((4,), dtype=key&lt;fry&gt;) overlaying:</span>
<span class="go">[[0 0]</span>
<span class="go"> [0 1]</span>
<span class="go"> [0 2]</span>
<span class="go"> [0 3]]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key_arr</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(4,)</span>
</pre></div>
</div>
<p>Aside from switching to a new constructor, most PRNG-related code should
continue to work as expected. You can continue to use keys in
<a class="reference internal" href="../jax.random.html#module-jax.random" title="jax.random"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.random</span></code></a> APIs as before; for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># split</span>
<span class="n">new_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># random number generation</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
</pre></div>
</div>
<p>However, not all numerical operations work on key arrays. They now
intentionally raise errors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span>
<span class="go">ValueError: dtype=key&lt;fry&gt; is not a valid dtype for JAX type promotion.</span>
</pre></div>
</div>
<p>If for some reason you need to recover the underlying buffer
(the old-style key), you can do so with <a class="reference internal" href="../_autosummary/jax.random.key_data.html#jax.random.key_data" title="jax.random.key_data"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.key_data()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key_data</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="go">Array([0, 0], dtype=uint32)</span>
</pre></div>
</div>
<p>For old-style keys, <a class="reference internal" href="../_autosummary/jax.random.key_data.html#jax.random.key_data" title="jax.random.key_data"><code class="xref py py-func docutils literal notranslate"><span class="pre">key_data()</span></code></a> is an identity operation.</p>
</section>
<section id="what-does-this-mean-for-users">
<h2>What does this mean for users?<a class="headerlink" href="#what-does-this-mean-for-users" title="Link to this heading">#</a></h2>
<p>For JAX users, this change does not require any code changes now, but we hope
that you will find the upgrade worthwhile and switch to using typed keys. To
try this out, replace uses of jax.random.PRNGKey() with jax.random.key(). This
may introduce breakages in your code that fall into one of a few categories:</p>
<ul class="simple">
<li><p>If your code performs unsafe/unsupported operations on keys (such as indexing,
arithmetic, transposition, etc; see Type Safety section below), this change
will catch it. You can update your code to avoid such unsupported operations,
or use <a class="reference internal" href="../_autosummary/jax.random.key_data.html#jax.random.key_data" title="jax.random.key_data"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.key_data()</span></code></a> and <a class="reference internal" href="../_autosummary/jax.random.wrap_key_data.html#jax.random.wrap_key_data" title="jax.random.wrap_key_data"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.wrap_key_data()</span></code></a>
to manipulate raw key buffers in an unsafe way.</p></li>
<li><p>If your code includes explicit logic about <code class="docutils literal notranslate"><span class="pre">key.shape</span></code>, you may need to update
this logic to account for the fact that the trailing key buffer dimension is
no longer an explicit part of the shape.</p></li>
<li><p>If your code includes explicit logic about <code class="docutils literal notranslate"><span class="pre">key.dtype</span></code>, you will need to
upgrade it to use the new public APIs for reasoning about RNG dtypes, such as
<code class="docutils literal notranslate"><span class="pre">dtypes.issubdtype(dtype,</span> <span class="pre">dtypes.prng_key)</span></code>.</p></li>
<li><p>If you call a JAX-based library which does not yet handle typed PRNG keys, you
can use <code class="docutils literal notranslate"><span class="pre">raw_key</span> <span class="pre">=</span> <span class="pre">jax.random.key_data(key)</span></code> for now to recover the raw buffer,
but please keep a TODO to remove this once the downstream library supports
typed RNG keys.</p></li>
</ul>
<p>At some point in the future, we plan to deprecate <a class="reference internal" href="../_autosummary/jax.random.PRNGKey.html#jax.random.PRNGKey" title="jax.random.PRNGKey"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.PRNGKey()</span></code></a> and
require the use of <a class="reference internal" href="../_autosummary/jax.random.key.html#jax.random.key" title="jax.random.key"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.key()</span></code></a>.</p>
<section id="detecting-new-style-typed-keys">
<h3>Detecting new-style typed keys<a class="headerlink" href="#detecting-new-style-typed-keys" title="Link to this heading">#</a></h3>
<p>To check whether an object is a new-style typed PRNG key, you can use
<code class="docutils literal notranslate"><span class="pre">jax.dtypes.issubdtype</span></code> or <code class="docutils literal notranslate"><span class="pre">jax.numpy.issubdtype</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">typed_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">typed_key</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">prng_key</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">raw_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">raw_key</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">prng_key</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
</section>
<section id="type-annotations-for-prng-keys">
<h3>Type annotations for PRNG Keys<a class="headerlink" href="#type-annotations-for-prng-keys" title="Link to this heading">#</a></h3>
<p>The recommended type annotation for both old and new-style PRNG keys is <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code>.
A PRNG key is distinguished from other arrays based on its <code class="docutils literal notranslate"><span class="pre">dtype</span></code>, and it is not
currently possible to specify dtypes of JAX arrays within a type annotation.
Previously it was possible to use <code class="docutils literal notranslate"><span class="pre">jax.random.KeyArray</span></code> or <code class="docutils literal notranslate"><span class="pre">jax.random.PRNGKeyArray</span></code>
as type annotations, but these have always been aliased to <code class="docutils literal notranslate"><span class="pre">Any</span></code> under type checking,
and so <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> has much more specificity.</p>
<p><em>Note: <code class="docutils literal notranslate"><span class="pre">jax.random.KeyArray</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.random.PRNGKeyArray</span></code> were deprecated in JAX
version 0.4.16, and removed in JAX version 0.4.24</em>.</p>
</section>
<section id="notes-for-jax-library-authors">
<h3>Notes for JAX library authors<a class="headerlink" href="#notes-for-jax-library-authors" title="Link to this heading">#</a></h3>
<p>If you maintain a JAX-based library, your users are also JAX users. Know that JAX
will continue to support â€œrawâ€ old-style keys in <a class="reference internal" href="../jax.random.html#module-jax.random" title="jax.random"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.random</span></code></a> for now, so
callers may expect them to remain accepted everywhere. If you prefer to require
new-style typed keys in your library, then you may want to enforce them with a
check along the following lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">dtypes</span>

<span class="k">def</span> <span class="nf">ensure_typed_key_array</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">prng_key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"New-style typed JAX PRNG keys required"</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>Two major motivating factors for this change are customizability and safety.</p>
<section id="customizing-prng-implementations">
<h3>Customizing PRNG implementations<a class="headerlink" href="#customizing-prng-implementations" title="Link to this heading">#</a></h3>
<p>JAX currently operates with a single, globally configured PRNG algorithm. A
PRNG key is a vector of unsigned 32-bit integers, which jax.random APIs consume
to produce pseudorandom streams. Any higher-rank uint32 array is interpreted as
an array of such key buffers, where the trailing dimension represents keys.</p>
<p>The drawbacks of this design became clearer as we introduced alternative PRNG
implementations, which must be selected by setting a global or local
configuration flag. Different PRNG implementations have different size key
buffers, and different algorithms for generating random bits. Determining this
behavior with a global flag is error-prone, especially when there is more than
one key implementation in use process-wide.</p>
<p>Our new approach is to carry the implementation as part of the PRNG key type,
i.e. with the element type of the key array. Using the new key API, here is an
example of generating pseudorandom values under the default threefry2x32
implementation (which is implemented in pure Python and compiled with JAX), and
under the non-default rbg implementation (which corresponds to a single XLA
random-bit generation operation):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">'threefry2x32'</span><span class="p">)</span>  <span class="c1"># this is the default impl</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">Array((), dtype=key&lt;fry&gt;) overlaying:</span>
<span class="go">[0 0]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
<span class="go">Array([0.9653214 , 0.31468165, 0.63302994], dtype=float32)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="s1">'rbg'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span>
<span class="go">Array((), dtype=key&lt;rbg&gt;) overlaying:</span>
<span class="go">[0 0 0 0]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
<span class="go">Array([0.39904642, 0.8805201 , 0.73571277], dtype=float32)</span>
</pre></div>
</div>
</section>
<section id="safe-prng-key-use">
<h3>Safe PRNG key use<a class="headerlink" href="#safe-prng-key-use" title="Link to this heading">#</a></h3>
<p>PRNG keys are really only meant to support a few operations in principle,
namely key derivation (e.g. splitting) and random number generation. The PRNG
is designed to generate independent pseudorandom numbers, provided keys are
properly split and that every key is consumed once.</p>
<p>Code that manipulates or consumes key data in other ways often indicates an
accidental bug, and representing key arrays as raw uint32 buffers has allowed
for easy misuse along these lines. Here are a few example misuses that weâ€™ve
encountered in the wild:</p>
<section id="key-buffer-indexing">
<h4>Key buffer indexing<a class="headerlink" href="#key-buffer-indexing" title="Link to this heading">#</a></h4>
<p>Access to the underlying integer buffers makes it easy to try and derive keys
in non-standard ways, sometimes with unexpectedly bad consequences:</p>
<div class="red-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incorrect</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="n">new_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># identical to the original key!</span>
</pre></div>
</div>
<div class="green-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="n">key</span><span class="p">,</span> <span class="n">new_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>If this key were a new-style typed key made with <code class="docutils literal notranslate"><span class="pre">random.key(999)</span></code>, indexing
into the key buffer would error instead.</p>
</section>
<section id="key-arithmetic">
<h4>Key arithmetic<a class="headerlink" href="#key-arithmetic" title="Link to this heading">#</a></h4>
<p>Key arithmetic is a similarly treacherous way to derive keys from other keys.
Deriving keys in a way that avoids <a class="reference internal" href="../_autosummary/jax.random.split.html#jax.random.split" title="jax.random.split"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.split()</span></code></a> or
<a class="reference internal" href="../_autosummary/jax.random.fold_in.html#jax.random.fold_in" title="jax.random.fold_in"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.random.fold_in()</span></code></a> by manipulating key data directly produces a batch
of keys thatâ€”depending on the PRNG implementationâ€”might then generate
correlated random numbers within the batch:</p>
<div class="red-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incorrect</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">batched_keys</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
<div class="green-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">batched_keys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>New-style typed keys created with <code class="docutils literal notranslate"><span class="pre">random.key(0)</span></code> address this by disallowing
arithmetic operations on keys.</p>
</section>
<section id="inadvertent-transposing-of-key-buffers">
<h4>Inadvertent transposing of key buffers<a class="headerlink" href="#inadvertent-transposing-of-key-buffers" title="Link to this heading">#</a></h4>
<p>With â€œrawâ€ old-style key arrays, itâ€™s easy to accidentally swap batch (leading)
dimensions and key buffer (trailing) dimensions. Again this possibly results in
keys that produce correlated pseudorandomness. A pattern that weâ€™ve seen over
time boils down to this:</p>
<div class="red-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incorrect</span>
<span class="n">keys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">keys</span><span class="p">)</span>
</pre></div>
</div>
<div class="green-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct</span>
<span class="n">keys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">keys</span><span class="p">)</span>
</pre></div>
</div>
<p>The bug here is subtle. By mapping over <code class="docutils literal notranslate"><span class="pre">in_axes=1</span></code>, this code makes new keys by
combining a single element from each key buffer in the batch. The resulting
keys are different from one another, but are effectively â€œderivedâ€ in a
non-standard way. Again, the PRNG is not designed or tested to produce
independent random streams from such a key batch.</p>
<p>New-style typed keys created with <code class="docutils literal notranslate"><span class="pre">random.key(0)</span></code> address this by hiding the
buffer representation of individual keys, instead treating keys as opaque
elements of a key array. Key arrays have no trailing â€œbufferâ€ dimension to
index, transpose, or map over.</p>
</section>
<section id="key-reuse">
<h4>Key reuse<a class="headerlink" href="#key-reuse" title="Link to this heading">#</a></h4>
<p>Unlike state-based PRNG APIs like <a class="reference external" href="https://numpy.org/doc/stable/reference/random/index.html#module-numpy.random" title="(in NumPy v1.26)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy.random</span></code></a>, JAXâ€™s functional PRNG
does not implicitly update a key when it has been used.</p>
<div class="red-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incorrect</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,))</span>  <span class="c1"># Identical values!</span>
</pre></div>
</div>
<div class="green-background highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,))</span>
</pre></div>
</div>
<p>Weâ€™re actively working on tools to detect and prevent unintended key reuse.
This is still work in progress, but it relies on typed key arrays. Upgrading
to typed keys now sets us up to introduce these safety features as we build
them out.</p>
</section>
</section>
</section>
<section id="design-of-typed-prng-keys">
<h2>Design of typed PRNG keys<a class="headerlink" href="#design-of-typed-prng-keys" title="Link to this heading">#</a></h2>
<p>Typed PRNG keys are implemented as an instance of extended dtypes within JAX,
of which the new PRNG dtypes are a sub-dtype.</p>
<section id="extended-dtypes">
<h3>Extended dtypes<a class="headerlink" href="#extended-dtypes" title="Link to this heading">#</a></h3>
<p>From the user perspective, an extended dtype dt has the following user-visible
properties:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.dtypes.issubdtype(dt,</span> <span class="pre">jax.dtypes.extended)</span></code> returns <code class="docutils literal notranslate"><span class="pre">True</span></code>: this is the
public API that should be used to detect whether a dtype is an extended dtype.</p></li>
<li><p>It has a class-level attribute <code class="docutils literal notranslate"><span class="pre">dt.type</span></code>, which returns a typeclass in the
hierarchy of <code class="docutils literal notranslate"><span class="pre">numpy.generic</span></code>. This is analogous to how <code class="docutils literal notranslate"><span class="pre">np.dtype('int32').type</span></code>
returns <code class="docutils literal notranslate"><span class="pre">numpy.int32</span></code>, which is not a dtype but rather a scalar type, and a
subclass of <code class="docutils literal notranslate"><span class="pre">numpy.generic</span></code>.</p></li>
<li><p>Unlike numpy scalar types, we do not allow instantiation of <code class="docutils literal notranslate"><span class="pre">dt.type</span></code> scalar
objects: this is in accordance with JAXâ€™s decision to represent scalar values
as zero-dimensional arrays.</p></li>
</ul>
<p>From a non-public implementation perspective, an extended dtype has the
following properties:</p>
<ul class="simple">
<li><p>Its type is a subclass of the private base class <code class="docutils literal notranslate"><span class="pre">jax._src.dtypes.ExtendedDtype</span></code>,
the non-public base class used for extended dtypes. An instance of
<code class="docutils literal notranslate"><span class="pre">ExtendedDtype</span></code> is analogous to an instance of <code class="docutils literal notranslate"><span class="pre">np.dtype</span></code>, like
<code class="docutils literal notranslate"><span class="pre">np.dtype('int32')</span></code>.</p></li>
<li><p>It has a private <code class="docutils literal notranslate"><span class="pre">_rules</span></code> attribute which allows the dtype to define how it
behaves under particular operations. For example,
<code class="docutils literal notranslate"><span class="pre">jax.lax.full(shape,</span> <span class="pre">fill_value,</span> <span class="pre">dtype)</span></code> will delegate to
<code class="docutils literal notranslate"><span class="pre">dtype._rules.full(shape,</span> <span class="pre">fill_value,</span> <span class="pre">dtype)</span></code> when <code class="docutils literal notranslate"><span class="pre">dtype</span></code> is an extended dtype.</p></li>
</ul>
<p>Why introduce extended dtypes in generality, beyond PRNGs? We reuse this same
extended dtype mechanism elsewhere internally. For example, the
<code class="docutils literal notranslate"><span class="pre">jax._src.core.bint</span></code> object, a bounded integer type used for experimental work
on dynamic shapes, is another extended dtype. In recent JAX versions it satisfies
the properties above (See <a class="reference external" href="https://github.com/google/jax/blob/jax-v0.4.14/jax/_src/core.py#L1789-L1802">jax/_src/core.py#L1789-L1802</a>).</p>
</section>
<section id="prng-dtypes">
<h3>PRNG dtypes<a class="headerlink" href="#prng-dtypes" title="Link to this heading">#</a></h3>
<p>PRNG dtypes are defined as a particular case of extended dtypes. Specifically,
this change introduces a new public scalar type class jax.dtypes.prng_key,
which has the following property:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">prng_key</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">extended</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>PRNG key arrays then have a dtype with the following properties:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">extended</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">prng_key</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>And in addition to <code class="docutils literal notranslate"><span class="pre">key.dtype._rules</span></code> as outlined for extended dtypes in
general, PRNG dtypes define <code class="docutils literal notranslate"><span class="pre">key.dtype._impl</span></code>, which contains the metadata
that defines the PRNG implementation. The PRNG implementation is currently
defined by the non-public <code class="docutils literal notranslate"><span class="pre">jax._src.prng.PRNGImpl</span></code> class. For now, <code class="docutils literal notranslate"><span class="pre">PRNGImpl</span></code>
isnâ€™t meant to be a public API, but we might revisit this soon to allow for
fully custom PRNG implementations.</p>
</section>
</section>
<section id="progress">
<h2>Progress<a class="headerlink" href="#progress" title="Link to this heading">#</a></h2>
<p>Following is a non-comprehensive list of key Pull Requests implementing the
above design. The main tracking issue is <a class="reference external" href="https://github.com/google/jax/issues/9263">#9263</a>.</p>
<ul class="simple">
<li><p>Implement pluggable PRNG via <code class="docutils literal notranslate"><span class="pre">PRNGImpl</span></code>: <a class="reference external" href="https://github.com/google/jax/issues/6899">#6899</a></p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">PRNGKeyArray</span></code>, without dtype: <a class="reference external" href="https://github.com/google/jax/issues/11952">#11952</a></p></li>
<li><p>Add a â€œcustom elementâ€ dtype property to <code class="docutils literal notranslate"><span class="pre">PRNGKeyArray</span></code> with <code class="docutils literal notranslate"><span class="pre">_rules</span></code>
attribute: <a class="reference external" href="https://github.com/google/jax/issues/12167">#12167</a></p></li>
<li><p>Rename â€œcustom element typeâ€ to â€œopaque dtypeâ€: <a class="reference external" href="https://github.com/google/jax/issues/12170">#12170</a></p></li>
<li><p>Refactor <code class="docutils literal notranslate"><span class="pre">bint</span></code> to use the opaque dtype infrastructure: <a class="reference external" href="https://github.com/google/jax/issues/12707">#12707</a></p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">jax.random.key</span></code> to create typed keys directly: <a class="reference external" href="https://github.com/google/jax/issues/16086">#16086</a></p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">impl</span></code> argument to <code class="docutils literal notranslate"><span class="pre">key</span></code> and <code class="docutils literal notranslate"><span class="pre">PRNGKey</span></code>: <a class="reference external" href="https://github.com/google/jax/issues/16589">#16589</a></p></li>
<li><p>Rename â€œopaque dtypeâ€ to  â€œextended dtypeâ€ &amp; define <code class="docutils literal notranslate"><span class="pre">jax.dtypes.extended</span></code>:
<a class="reference external" href="https://github.com/google/jax/issues/16824">#16824</a></p></li>
<li><p>Introduce <code class="docutils literal notranslate"><span class="pre">jax.dtypes.prng_key</span></code> and unify PRNG dtype with Extended dtype:
<a class="reference external" href="https://github.com/google/jax/issues/16781">#16781</a></p></li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">jax_legacy_prng_key</span></code> flag to support warning or erroring when using
legacy (raw) PRNG keys: <a class="reference external" href="https://github.com/google/jax/issues/17225">#17225</a></p></li>
</ul>
</section>
</section>
</article>
<footer class="prev-next-footer">
<div class="prev-next-area">
<a class="left-prev" href="4410-omnistaging.html" title="previous page">
<i class="fa-solid fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Omnistaging</p>
</div>
</a>
<a class="right-next" href="9407-type-promotion.html" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Design of Type Promotion Semantics for JAX</p>
</div>
<i class="fa-solid fa-angle-right"></i>
</a>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage" id="pst-page-navigation-heading-2">
<i class="fa-solid fa-list"></i> On this page
  </div>
<nav aria-labelledby="pst-page-navigation-heading-2" class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-does-this-mean-for-users">What does this mean for users?</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detecting-new-style-typed-keys">Detecting new-style typed keys</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#type-annotations-for-prng-keys">Type annotations for PRNG Keys</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#notes-for-jax-library-authors">Notes for JAX library authors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#customizing-prng-implementations">Customizing PRNG implementations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#safe-prng-key-use">Safe PRNG key use</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-buffer-indexing">Key buffer indexing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-arithmetic">Key arithmetic</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inadvertent-transposing-of-key-buffers">Inadvertent transposing of key buffers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#key-reuse">Key reuse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-of-typed-prng-keys">Design of typed PRNG keys</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-dtypes">Extended dtypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prng-dtypes">PRNG dtypes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#progress">Progress</a></li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By The JAX authors
</p>
</div>
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>
<footer class="bd-footer">
</footer>
</body>
</html>