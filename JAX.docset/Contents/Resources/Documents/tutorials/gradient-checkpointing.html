
<!DOCTYPE html>

<html data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Gradient checkpointing with jax.checkpoint (jax.remat) â€” JAX  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css?v=a746c00c" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/sphinx-book-theme.css?v=384b581d" rel="stylesheet" type="text/css"/>
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css"/>
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css?v=02ed413a" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/documentation_options.js?v=9eb32ce0"></script>
<script src="../_static/doctools.js?v=9a2dae69"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../_static/copybutton.js?v=f281be69"></script>
<script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
<script src="../_static/design-tabs.js?v=36754332"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/gradient-checkpointing';</script>
<link href="../_static/favicon.png" rel="icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<a class="skip-link" href="#main-content" id="pst-skip-link">Skip to main content</a>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar">
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="../index.html">
<img alt="JAX  documentation - Home" class="logo__image only-light" src="../_static/jax_logo_250px.png"/>
<script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
</a></div>
<div class="sidebar-primary-item">
<script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">ðŸ”ª JAX - The Sharp Bits ðŸ”ª</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guide.html">Advanced Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiffâ€™s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor_guide.html">Developer Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">JAX Glossary of Terms</a></li>
</ul>
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<a class="btn btn-sm btn-source-repository-button" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/google/jax" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../_sources/tutorials/gradient-checkpointing.md" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.md</span>
</a>
</li>
<li>
<button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Gradient checkpointing with jax.checkpoint (jax.remat)</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-think-step-by-step">Letâ€™s think step by step</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-checkpoint-fundamentals"><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-what-s-saveable">Custom policies for whatâ€™s saveable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-recursive-jax-checkpoint">Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-notes">Practical notes</a></li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<section id="gradient-checkpointing-with-jax-checkpoint-jax-remat">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Gradient checkpointing with jax.checkpoint (jax.remat)"></a><span id="gradient-checkpointing"></span><h1>Gradient checkpointing with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (<code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)<a class="headerlink" href="#gradient-checkpointing-with-jax-checkpoint-jax-remat" title="Link to this heading">#</a></h1>
<p>In this tutorial, you will learn how to control JAX automatic differentiationâ€™s saved values using <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> (also known as <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.remat()</span></code>), which can be particularly helpful in machine learning.</p>
<p>If you are new to automatic differentiation (autodiff) or need to refresh your memory, JAX has <a class="reference internal" href="automatic-differentiation.html#automatic-differentiation"><span class="std std-ref">Automatic differentiation</span></a> and <a class="reference internal" href="advanced-autodiff.html#advanced-autodiff"><span class="std std-ref">Advanced automatic differentiation</span></a> tutorials.</p>
<p><strong>TL;DR</strong> Use the <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorator (aliased as <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.remat()</span></code>) with <a class="reference internal" href="../_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a> to control which intermediates are saved on the forward pass versus the recomputed intermediates on the backward pass, trading off memory and FLOPs.</p>
<p>If you donâ€™t use <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>, the <code class="docutils literal notranslate"><span class="pre">jax.grad(f)(x)</span></code> forward pass stores Jacobian coefficients and other intermediates to use during the backward pass. These saved values are called <em>residuals</em>.</p>
<p><strong>Note:</strong> Donâ€™t miss the <a class="reference internal" href="#gradient-checkpointing-practical-notes"><span class="std std-ref">Practical notes</span></a> for a discussion about how <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> interacts with <a class="reference internal" href="../_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">W1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">W2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">W3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Inspect the 'residual' values to be saved on the forward pass</span>
<span class="c1"># if you were to evaluate `jax.grad(f)(W1, W2, W3, x)`</span>
<span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">print_saved_residuals</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of sin from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
f32[5] output of cos from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
f32[6] output of sin from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
f32[6] output of cos from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
f32[7] output of cos from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div>
</div>
</div>
</div>
<p>By applying <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to sub-functions, as a decorator or at specific application sites, you force JAX not to save any of that sub-functionâ€™s residuals. Instead, only the inputs of a <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated function might be saved, and any residuals consumed on the backward pass are re-computed from those inputs as needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of sin from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
f32[6] output of sin from /tmp/ipykernel_72882/1801108376.py:6:9 (g)
</pre></div>
</div>
</div>
</div>
<p>Here, the values of two <code class="docutils literal notranslate"><span class="pre">sin</span></code> applications are saved because they are arguments
in subsequent applications of the <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated <code class="docutils literal notranslate"><span class="pre">g</span></code> function, and
inputs to a <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated function may be saved. But no values of
<code class="docutils literal notranslate"><span class="pre">cos</span></code> applications are saved.</p>
<p>To control which values are saveable without having to edit the definition of the function to be differentiated, you can use a rematerialization <em>policy</em>. Here is an example that saves only the results of <code class="docutils literal notranslate"><span class="pre">dot</span></code> operations with no batch dimensions (since they are often FLOP-bound, and hence worth saving rather than recomputing):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f3</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f3</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] output of dot_general from /tmp/ipykernel_72882/1801108376.py:5:6 (g)
f32[6] output of dot_general from /tmp/ipykernel_72882/1801108376.py:5:6 (g)
f32[7] output of dot_general from /tmp/ipykernel_72882/1801108376.py:5:6 (g)
</pre></div>
</div>
</div>
</div>
<p>You can also use policies to refer to intermediate values you name using <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_name</span>

<span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W1</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'a'</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W2</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'b'</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">'c'</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="n">f4</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f4</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">save_only_these_names</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span>
<span class="n">jax</span><span class="o">.</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f4</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[5,4] from the argument W1
f32[6,5] from the argument W2
f32[7,6] from the argument W3
f32[4] from the argument x
f32[5] named 'a' from /tmp/ipykernel_72882/2296542172.py:4:6 (f4)
</pre></div>
</div>
</div>
</div>
<p>When playing around with these toy examples, you can get a closer look at whatâ€™s going on using a custom <code class="docutils literal notranslate"><span class="pre">print_fwd_bwd</span></code> utility defined in this notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.tree_util</span> <span class="kn">import</span> <span class="n">tree_flatten</span><span class="p">,</span> <span class="n">tree_unflatten</span>

<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">rich.text</span>

<span class="k">def</span> <span class="nf">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
  <span class="n">args</span><span class="p">,</span> <span class="n">in_tree</span> <span class="o">=</span> <span class="n">tree_flatten</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">f_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">tree_unflatten</span><span class="p">(</span><span class="n">in_tree</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="n">fwd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">make_jaxpr</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">jaxpr</span>

  <span class="n">y</span><span class="p">,</span> <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">res</span><span class="p">,</span> <span class="n">in_tree</span> <span class="o">=</span> <span class="n">tree_flatten</span><span class="p">(</span><span class="n">f_vjp</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">g_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">tree_unflatten</span><span class="p">(</span><span class="n">in_tree</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_vjp</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

  <span class="n">bwd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">make_jaxpr</span><span class="p">(</span><span class="n">g_</span><span class="p">)(</span><span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">jaxpr</span>

  <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">show_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">"[bold green]forward computation:"</span><span class="p">,</span>
                <span class="s2">"[bold green]backward computation:"</span><span class="p">)</span>
  <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">rich</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">from_ansi</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fwd</span><span class="p">)),</span>
                <span class="n">rich</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">from_ansi</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bwd</span><span class="p">)))</span>
  <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">force_jupyter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_renderable_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span>
<span class="n">rich</span><span class="o">.</span><span class="n">jupyter</span><span class="o">.</span><span class="n">JupyterRenderable</span><span class="o">.</span><span class="n">_repr_html_</span> <span class="o">=</span> <span class="n">_renderable_repr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Without using `jax.checkpoint`:</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                                         
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                         <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                     
                                                                                                                                                         
  { lambda ; a:f32[5,4] b:f32[6,5] c:f32[7,6] d:f32[4]. let    { lambda ; a:f32[4] b:f32[5,4] c:f32[5] d:f32[5] e:f32[6,5] f:f32[6] g:f32[6] h:f32[7,6]  
      e:f32[5] = dot_general[                                      i:f32[7] j:f32[7]. let                                                                
        dimension_numbers=(([1], [0]), ([], []))                   k:f32[7] = mul j i                                                                    
        preferred_element_type=float32                             l:f32[6] = dot_general[                                                               
      ] a d                                                          dimension_numbers=(([0], [0]), ([], []))                                            
      f:f32[5] = sin e                                               preferred_element_type=float32                                                      
      g:f32[5] = cos e                                             ] k h                                                                                 
      h:f32[6] = dot_general[                                      m:f32[7,6] = dot_general[                                                             
        dimension_numbers=(([1], [0]), ([], []))                     dimension_numbers=(([], []), ([], []))                                              
        preferred_element_type=float32                               preferred_element_type=float32                                                      
      ] b f                                                        ] k g                                                                                 
      i:f32[6] = sin h                                             n:f32[6] = mul l f                                                                    
      j:f32[6] = cos h                                             o:f32[5] = dot_general[                                                               
      k:f32[7] = dot_general[                                        dimension_numbers=(([0], [0]), ([], []))                                            
        dimension_numbers=(([1], [0]), ([], []))                     preferred_element_type=float32                                                      
        preferred_element_type=float32                             ] n e                                                                                 
      ] c i                                                        p:f32[6,5] = dot_general[                                                             
      l:f32[7] = sin k                                               dimension_numbers=(([], []), ([], []))                                              
      m:f32[7] = cos k                                               preferred_element_type=float32                                                      
    in (l, d, a, g, f, b, j, i, c, m) }                            ] n d                                                                                 
                                                                   q:f32[5] = mul o c                                                                    
                                                                   r:f32[4] = dot_general[                                                               
                                                                     dimension_numbers=(([0], [0]), ([], []))                                            
                                                                     preferred_element_type=float32                                                      
                                                                   ] q b                                                                                 
                                                                   s:f32[5,4] = dot_general[                                                             
                                                                     dimension_numbers=(([], []), ([], []))                                              
                                                                     preferred_element_type=float32                                                      
                                                                   ] q a                                                                                 
                                                                 in (s, p, m, r) }                                                                       
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using `jax.checkpoint` with policy=jax.checkpoint_policies.dots_with_no_batch_dims_saveable:</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f3</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                                              
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                         <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                          
                                                                                                                                                              
  { lambda ; a:f32[5,4] b:f32[6,5] c:f32[7,6] d:f32[4]. let    { lambda ; a:f32[5] b:f32[6] c:f32[7] d:f32[5,4] e:f32[6,5] f:f32[7,6] g:f32[4] h:f32[7]. let  
      e:f32[5] = dot_general[                                      i:f32[5,4] j:f32[6,5] k:f32[7,6] l:f32[4] = remat2[                                        
        dimension_numbers=(([1], [0]), ([], []))                     differentiated=True                                                                      
        preferred_element_type=float32                               jaxpr={ lambda ; m:f32[5] n:f32[6] o:f32[7] p:f32[5,4] q:f32[6,5] r:f32[7,6]             
      ] a d                                                              s:f32[4] t:f32[7]. let                                                               
      f:f32[5] = sin e                                                   u:f32[5] = sin m                                                                     
      g:f32[6] = dot_general[                                            v:f32[5] = cos m                                                                     
        dimension_numbers=(([1], [0]), ([], []))                         w:f32[6] = sin n                                                                     
        preferred_element_type=float32                                   x:f32[6] = cos n                                                                     
      ] b f                                                              y:f32[7] = cos o                                                                     
      h:f32[6] = sin g                                                   z:f32[7] = mul t y                                                                   
      i:f32[7] = dot_general[                                            ba:f32[6] = dot_general[                                                             
        dimension_numbers=(([1], [0]), ([], []))                           dimension_numbers=(([0], [0]), ([], []))                                           
        preferred_element_type=float32                                     preferred_element_type=float32                                                     
      ] c h                                                              ] z r                                                                                
      j:f32[7] = sin i                                                   bb:f32[6] = mul ba x                                                                 
    in (j, e, g, i, a, b, c, d) }                                        bc:f32[5] = dot_general[                                                             
                                                                           dimension_numbers=(([0], [0]), ([], []))                                           
                                                                           preferred_element_type=float32                                                     
                                                                         ] bb q                                                                               
                                                                         bd:f32[5] = mul bc v                                                                 
                                                                         be:f32[4] = dot_general[                                                             
                                                                           dimension_numbers=(([0], [0]), ([], []))                                           
                                                                           preferred_element_type=float32                                                     
                                                                         ] bd p                                                                               
                                                                         bf:f32[5,4] = dot_general[                                                           
                                                                           dimension_numbers=(([], []), ([], []))                                             
                                                                           preferred_element_type=float32                                                     
                                                                         ] bd s                                                                               
                                                                         bg:f32[6,5] = dot_general[                                                           
                                                                           dimension_numbers=(([], []), ([], []))                                             
                                                                           preferred_element_type=float32                                                     
                                                                         ] bb u                                                                               
                                                                         bh:f32[7,6] = dot_general[                                                           
                                                                           dimension_numbers=(([], []), ([], []))                                             
                                                                           preferred_element_type=float32                                                     
                                                                         ] z w                                                                                
                                                                       in (bf, bg, bh, be) }                                                                  
                                                                     policy=&lt;function dot_with_no_batch_dims_saveable at 0x731361564f40&gt;                      
                                                                     prevent_cse=True                                                                         
                                                                   ] a b c d e f g h                                                                          
                                                                 in (i, j, k, l) }                                                                            
</pre>
</div></div>
</div>
<section id="let-s-think-step-by-step">
<h2>Letâ€™s think step by step<a class="headerlink" href="#let-s-think-step-by-step" title="Link to this heading">#</a></h2>
<p><strong>Note:</strong> It may help to check out the <a class="reference internal" href="advanced-autodiff.html#advanced-autodiff"><span class="std std-ref">Advanced automatic differentiation</span></a> tutorial prior to continuing here.</p>
<section id="jax-checkpoint-fundamentals">
<h3><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals<a class="headerlink" href="#jax-checkpoint-fundamentals" title="Link to this heading">#</a></h3>
<p>In both <a class="reference internal" href="../_autosummary/jax.linearize.html#jax.linearize" title="jax.linearize"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.linearize()</span></code></a> and <a class="reference internal" href="../_autosummary/jax.vjp.html#jax.vjp" title="jax.vjp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vjp()</span></code></a>, there is flexibility in how and when some values are computed. Different choices can trade off memory use against FLOPs. JAX provides control over these choices with <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>.</p>
<p>One such choice is whether to perform Jacobian coefficient computations on the forward pass, as soon as the inputs are available, or on the backward pass, just before the coefficients are needed. Consider the example of <code class="docutils literal notranslate"><span class="pre">sin_vjp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sin_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">cos_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y_bar</span><span class="p">:</span> <span class="n">cos_x</span> <span class="o">*</span> <span class="n">y_bar</span>
</pre></div>
</div>
</div>
</div>
<p>Another valid implementation would compute the value of <code class="docutils literal notranslate"><span class="pre">jnp.cos(x)</span></code> on the backward pass rather than on the forward pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sin_vjp2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y_bar</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_bar</span>
</pre></div>
</div>
</div>
</div>
<p>For this particular function, the amount of memory used by the two versions is the same, though youâ€™ve reduced the FLOPs for the primal computation (the forward pass) and increased the FLOPs for the cotangent computation (the backward pass).</p>
<p>Thereâ€™s another choice when it comes to function composition. Recall the VJP rule for a composition of two functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">f_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">z</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">z_bar</span><span class="p">):</span>
    <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="n">z_bar</span><span class="p">)</span>
    <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_bar</span>
  <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">f_bwd</span>
</pre></div>
</div>
</div>
</div>
<p>An alternative is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_vjp_checkpoint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f_bwd2</span><span class="p">(</span><span class="n">z_bar</span><span class="p">):</span>
    <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="n">z_bar</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_bar</span>
  <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">f_bwd2</span>
</pre></div>
</div>
</div>
</div>
<p>Using words, this alternative implementation doesnâ€™t compute <code class="docutils literal notranslate"><span class="pre">g_vjp</span></code>, or the residual values in its closure, on the forward pass. Instead, it only computes them in the backward pass <code class="docutils literal notranslate"><span class="pre">f_bwd2</span></code>. That means <code class="docutils literal notranslate"><span class="pre">f_vjp_checkpoint</span></code> requires less memory: if <code class="docutils literal notranslate"><span class="pre">g</span></code> and <code class="docutils literal notranslate"><span class="pre">h</span></code> each required similar amounts of memory for their residuals, each much larger than <code class="docutils literal notranslate"><span class="pre">x</span></code>, then the function produced by <code class="docutils literal notranslate"><span class="pre">f_vjp_checkpoint(x)</span></code> requires half the memory as that of <code class="docutils literal notranslate"><span class="pre">f_vjp(x)</span></code>!</p>
<p>The cost you pay is redundant work: in <code class="docutils literal notranslate"><span class="pre">f_bwd2</span></code> you must re-evaluate <code class="docutils literal notranslate"><span class="pre">g(x)</span></code> as part of <code class="docutils literal notranslate"><span class="pre">jax.vjp(g,</span> <span class="pre">x)</span></code> just to discard its value (in the underscore variable on the line <code class="docutils literal notranslate"><span class="pre">_,</span> <span class="pre">g_vjp</span> <span class="pre">=</span> <span class="pre">jax.vjp(g,</span> <span class="pre">x)</span></code>).</p>
<p>You can get this VJP behavior in autodiff ï¿½ without having to write VJP functions directly ï¿½ by instead using <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> in an alternative definition of the original function <code class="docutils literal notranslate"><span class="pre">f</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_checkpoint</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">g</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<p>In other words, you apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">g</span></code> â€” the first stage of <code class="docutils literal notranslate"><span class="pre">f</span></code> â€” rather than to <code class="docutils literal notranslate"><span class="pre">f</span></code> itself. This way, when you evaluate <code class="docutils literal notranslate"><span class="pre">jax.grad(f_checkpoint)(x)</span></code>, youâ€™d get a computation like:</p>
<ol class="arabic simple">
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, discarding residual values.</p></li>
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, consuming residuals from step 2.</p></li>
<li><p>Re-run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, consuming residuals from step 4.</p></li>
</ol>
<p>That is, by evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(f_checkpoint)(x)</span></code> weâ€™d get the same computation as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_checkpoint_grad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                  <span class="c1"># step 1</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># step 2</span>
  <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 4</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>     <span class="c1"># step 5</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>In general, <code class="docutils literal notranslate"><span class="pre">jax.checkpoint(foo)</span></code> is a new function which has the same input-output behavior as <code class="docutils literal notranslate"><span class="pre">foo</span></code>, but behaves differently under autodiff, particularly under <a class="reference internal" href="../_autosummary/jax.linearize.html#jax.linearize" title="jax.linearize"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.linearize()</span></code></a> and <a class="reference internal" href="../_autosummary/jax.vjp.html#jax.vjp" title="jax.vjp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vjp()</span></code></a> (and their wrappers, like <a class="reference internal" href="../_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a>) but not <a class="reference internal" href="../_autosummary/jax.jvp.html#jax.jvp" title="jax.jvp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jvp()</span></code></a>. When differentiated, only the input to a <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-differentiated function is stored on the forward pass. On the backward pass, the residuals (intermediates from <code class="docutils literal notranslate"><span class="pre">foo</span></code> and its Jacobian coefficient values needed for the backward pass) are recomputed.</p>
<p>Notice that if <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">h(g(x))</span></code> is the function you want to differentiate (in other words, if you want to apply <code class="docutils literal notranslate"><span class="pre">jax.grad(f)</span></code>) you donâ€™t get any memory savings by applying <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">f</span></code> itself. Thatâ€™s because evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(jax.checkpoint(f))(x)</span></code> would lead to a computation, such as:</p>
<ol class="arabic simple">
<li><p>Run the forward pass, discarding all residuals.</p></li>
<li><p>Immediately re-run the forward pass, saving residuals.</p></li>
<li><p>Run the backward pass, consuming residuals from step 2.</p></li>
</ol>
<p>In code, youâ€™d have something like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_grad_bad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">_</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                  <span class="c1"># step 1</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 2</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">f_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>You also wouldnâ€™t get any memory savings by applying <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">h</span></code>, the second stage of <code class="docutils literal notranslate"><span class="pre">f</span></code>. Thatâ€™s because evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(lambda</span> <span class="pre">x:</span> <span class="pre">jax.checkpoint(h)(g(x)))</span></code> would lead to a computation, such as:</p>
<ol class="arabic simple">
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, saving residuals.</p></li>
<li><p>Run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, discarding residuals.</p></li>
<li><p>Immediately re-run the forward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, saving residuals.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">h</span></code>, consuming residuals from step 3.</p></li>
<li><p>Run the backward pass of <code class="docutils literal notranslate"><span class="pre">g</span></code>, consuming residuals from step 1.</p></li>
</ol>
<p>In code youâ€™d have something like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_grad_bad2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span><span class="p">,</span> <span class="n">g_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># step 1</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>                  <span class="c1"># step 2</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">h_vjp</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vjp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># step 3</span>
  <span class="n">y_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">h_vjp</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>       <span class="c1"># step 3</span>
  <span class="n">x_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">g_vjp</span><span class="p">(</span><span class="n">y_bar</span><span class="p">)</span>     <span class="c1"># step 5</span>
  <span class="k">return</span> <span class="n">x_bar</span>
</pre></div>
</div>
</div>
</div>
<p>Slightly more generally, if you had a chain composition of functions, such as <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">=</span> <span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">f3(f2(f1(x)))</span></code>, and were interested in evaluating <code class="docutils literal notranslate"><span class="pre">jax.grad(f)</span></code>, you could say that you:</p>
<ul class="simple">
<li><p>Shouldnâ€™t apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to the whole function <code class="docutils literal notranslate"><span class="pre">f</span></code>, since that wouldnâ€™t save any memory (and will perform wasteful recomputation).</p></li>
<li><p>Shouldnâ€™t apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to the last sub-function <code class="docutils literal notranslate"><span class="pre">f3</span></code>, since that wouldnâ€™t save any memory (and will perform wasteful recomputation).</p></li>
<li><p>Could apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to <code class="docutils literal notranslate"><span class="pre">f1</span></code>, <code class="docutils literal notranslate"><span class="pre">f2</span></code>, or their composition <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">f2(f1(x))</span></code>, since any of those might save memory and would express different memory/recompute tradeoffs.</p></li>
</ul>
</section>
<section id="custom-policies-for-what-s-saveable">
<h3>Custom policies for whatâ€™s saveable<a class="headerlink" href="#custom-policies-for-what-s-saveable" title="Link to this heading">#</a></h3>
<p>As shown so far, using <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> switches from one extreme to another:</p>
<ul class="simple">
<li><p>Without <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>, JAXâ€™s autodiff tends to compute everything possible on the forward pass and store it for the backward pass.</p></li>
<li><p>With a <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorator, you instead compute as little as possible on the forward pass and recompute values as needed on the backward pass.</p></li>
</ul>
<p>To operate between these two extremes, saving some things and not others, you can carefully place <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> decorators on sub-functions. But that requires editing the function to be differentiated, e.g. model code, which may be inconvenient. It can also be hard to experiment with variations.</p>
<p>So an alternative is to use the <code class="docutils literal notranslate"><span class="pre">policy</span></code> argument to <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>. A policy is a callable (i.e. a function) which takes as input a type-level specification of a first order primitive application and returns a boolean indicating whether the corresponding output value(s) are allowed to be saved as residuals (or instead must be recomputed in the (co)tangent computation as needed). To write robust code, a policy should be selected from the attributes on <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies()</span></code>, like <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies.dots_with_no_batch_dims_saveable()</span></code>, since the API for writing custom policy callables is considered internal.</p>
<p>For example, consider this function to be differentiated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="o">*</span><span class="n">Ws</span><span class="p">,</span> <span class="n">Wlast</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">for</span> <span class="n">W</span> <span class="ow">in</span> <span class="n">Ws</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wlast</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W1</span> <span class="o">=</span> <span class="n">W2</span> <span class="o">=</span> <span class="n">W3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">W3</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] output of sin from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] output of cos from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] output of sin from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] output of cos from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] output of mul from /tmp/ipykernel_72882/4230705069.py:2:17 (loss)
</pre></div>
</div>
</div>
</div>
<p>Instead of saving so many values on the forward pass, perhaps you only want to save the results of matrix multiplications with no batch dimension (since they may be FLOP- rather than memory-bound). You can do that using the policy <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint_policies.dots_with_no_batch_dims_saveable()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_checkpoint</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss_checkpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] from the argument y
f32[4] output of dot_general from /tmp/ipykernel_72882/4230705069.py:12:17 (layer)
f32[4] output of dot_general from /tmp/ipykernel_72882/4230705069.py:12:17 (layer)
f32[4] output of dot_general from /tmp/ipykernel_72882/4230705069.py:8:6 (predict)
</pre></div>
</div>
</div>
</div>
<p>Notice also that by providing a policy, you didnâ€™t need to edit the code defining <code class="docutils literal notranslate"><span class="pre">loss</span></code>, <code class="docutils literal notranslate"><span class="pre">predict</span></code>, or <code class="docutils literal notranslate"><span class="pre">layer</span></code>. That is particularly convenient if you want to experiment with policies in calling code (such as a training script) without changing library code (for example, the neural network library).</p>
<p>Some policies can refer to values named with <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint.checkpoint_name()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.ad_checkpoint</span> <span class="kn">import</span> <span class="n">checkpoint_name</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="o">*</span><span class="n">Ws</span><span class="p">,</span> <span class="n">Wlast</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">W</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Ws</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint_name</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">'layer</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_output'</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Wlast</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>By itself, <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint</span> <span class="pre">import.checkpoint_name()</span></code> is just an identity function. But because some policy functions know to look for them, you can use the names to control whether certain values output by <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.ad_checkpoint</span> <span class="pre">import.checkpoint_name()</span></code> are considered saveable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] output of cos from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] named 'layer0_output' from /tmp/ipykernel_72882/178264713.py:7:8 (predict)
f32[4] output of cos from /tmp/ipykernel_72882/4230705069.py:12:9 (layer)
f32[4] named 'layer1_output' from /tmp/ipykernel_72882/178264713.py:7:8 (predict)
f32[4] output of mul from /tmp/ipykernel_72882/4230705069.py:2:17 (loss)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_checkpoint2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">save_any_names_but_these</span><span class="p">(</span><span class="s1">'layer1_output'</span><span class="p">))</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">loss_checkpoint2</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[4,4] from the argument params[0]
f32[4,4] from the argument params[1]
f32[4,4] from the argument params[2]
f32[4] from the argument x
f32[4] from the argument y
</pre></div>
</div>
</div>
</div>
<p>Another policy which refers to names is <code class="docutils literal notranslate"><span class="pre">jax.checkpoint_policies.save_only_these_names</span></code>.</p>
<p>Some of the policies are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">everything_saveable</span></code>: The default strategy, as if <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> were not being used at all).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nothing_saveable</span></code>: That is, rematerialize everything, as if a custom policy were not being used at all.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dots_saveable</span></code>: Or its alias <code class="docutils literal notranslate"><span class="pre">checkpoint_dots</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dots_with_no_batch_dims_saveable</span></code>: Or its alias <code class="docutils literal notranslate"><span class="pre">checkpoint_dots_with_no_batch_dims</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_anything_but_these_names</span></code>: Save any values except for the output of
<code class="docutils literal notranslate"><span class="pre">checkpoint_name</span></code> with any of the names given.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_any_names_but_these</span></code>: Save only named values (that is, any outputs of).
<code class="docutils literal notranslate"><span class="pre">checkpoint_name</span></code>: Except for those with the names given.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save_only_these_names</span></code>: Save only named values, and only among the names
given.</p></li>
</ul>
<p>Policies only indicate what is saveable; a value is only saved if itâ€™s actually needed by the backward pass.</p>
</section>
<section id="advanced-recursive-jax-checkpoint">
<h3>Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code><a class="headerlink" href="#advanced-recursive-jax-checkpoint" title="Link to this heading">#</a></h3>
<p>By applying <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> in the right way, there are many tradeoffs between memory usage and (re)computation that can be expressed. One surprising example is <em>recursive</em> checkpointing, where you apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> to a function which itself calls <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>-decorated functions in a way so that memory usage from the chain composition of <span class="math notranslate nohighlight">\(D\)</span> functions scales like <span class="math notranslate nohighlight">\(\mathcal{O}(\log_2 D)\)</span> rather than <span class="math notranslate nohighlight">\(\mathcal{O}(D)\)</span>.</p>
<p>As a toy example, consider the chain composition of multiple <a class="reference internal" href="../_autosummary/jax.numpy.sin.html#jax.numpy.sin" title="jax.numpy.sin"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.numpy.sin()</span></code></a> functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">chain_compose</span><span class="p">(</span><span class="n">funs</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">funs</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">f</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
</pre></div>
</div>
</div>
</div>
<p>In general, the number of stored residuals scales linearly with the length of the chain:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
f32[] output of cos from /tmp/ipykernel_72882/410288286.py:4:10 (chain_compose.&lt;locals&gt;.f)
</pre></div>
</div>
</div>
</div>
<p>But you can apply <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> recursively to improve the scaling:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">funs</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">(</span><span class="n">funs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">funs</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f1</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">f2</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] from the argument x
f32[] output of sin from /tmp/ipykernel_72882/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_72882/1943107544.py:6:24 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_72882/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">print_saved_residuals</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f32[] from the argument x
f32[] output of sin from /tmp/ipykernel_72882/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of sin from /tmp/ipykernel_72882/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_72882/1943107544.py:6:24 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
f32[] output of cos from /tmp/ipykernel_72882/1943107544.py:6:21 (recursive_checkpoint.&lt;locals&gt;.&lt;lambda&gt;)
</pre></div>
</div>
</div>
</div>
<p>The cost here, as usual, is recomputation: in particular, you end up performing <span class="math notranslate nohighlight">\(\mathcal{O}(\log_2 D)\)</span> times as many FLOPs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">chain_compose</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                 
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                                                                    
                                                                                                                                 
  { lambda ; a:f32[]. let               { lambda ; a:f32[] b:f32[] c:f32[] d:f32[] e:f32[] f:f32[] g:f32[] h:f32[] i:f32[]. let  
      b:f32[] = sin a                       j:f32[] = mul i h                                                                    
      c:f32[] = cos a                       k:f32[] = mul j g                                                                    
      d:f32[] = sin b                       l:f32[] = mul k f                                                                    
      e:f32[] = cos b                       m:f32[] = mul l e                                                                    
      f:f32[] = sin d                       n:f32[] = mul m d                                                                    
      g:f32[] = cos d                       o:f32[] = mul n c                                                                    
      h:f32[] = sin f                       p:f32[] = mul o b                                                                    
      i:f32[] = cos f                       q:f32[] = mul p a                                                                    
      j:f32[] = sin h                     in (q,) }                                                                              
      k:f32[] = cos h                                                                                                            
      l:f32[] = sin j                                                                                                            
      m:f32[] = cos j                                                                                                            
      n:f32[] = sin l                                                                                                            
      o:f32[] = cos l                                                                                                            
      p:f32[] = sin n                                                                                                            
      q:f32[] = cos n                                                                                                            
    in (p, c, e, g, i, k, m, o, q) }                                                                                             
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">recursive_checkpoint</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">print_fwd_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                                                                                                                        
  <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">forward computation:</span>                                                              <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">backward computation:</span>                               
                                                                                                                                        
  { lambda ; a:f32[]. let                                                           { lambda ; a:f32[] b:f32[] c:f32[] d:f32[]. let     
      b:f32[] = remat2[                                                                 e:f32[] = mul d c                               
        differentiated=False                                                            f:f32[] = mul e b                               
        jaxpr={ lambda ; c:f32[]. let d:f32[] = sin c; e:f32[] = sin d in (e,) }        g:f32[] = remat2[                               
        policy=None                                                                       differentiated=True                           
        prevent_cse=True                                                                  jaxpr={ lambda ; h:f32[] i:f32[]. let         
      ] a                                                                                     j:f32[] = sin h                           
      f:f32[] = sin b                                                                         k:f32[] = cos h                           
      g:f32[] = sin f                                                                         l:f32[] = cos j                           
      h:f32[] = sin g                                                                         m:f32[] = mul i l                         
      i:f32[] = sin h                                                                         n:f32[] = mul m k                         
      j:f32[] = sin i                                                                       in (n,) }                                   
      k:f32[] = cos i                                                                     policy=None                                   
      l:f32[] = sin j                                                                     prevent_cse=True                              
      m:f32[] = cos j                                                                   ] a f                                           
    in (l, g, a, k, m) }                                                                o:f32[] = remat2[                               
                                                                                          differentiated=True                           
                                                                                          jaxpr={ lambda ; p:f32[] q:f32[]. let         
                                                                                              r:f32[] = sin p                           
                                                                                              s:f32[] = sin r                           
                                                                                              t:f32[] = sin s                           
                                                                                              u:f32[] = cos s                           
                                                                                              v:f32[] = cos t                           
                                                                                              w:f32[] = mul q v                         
                                                                                              x:f32[] = mul w u                         
                                                                                              y:f32[] = remat2[                         
                                                                                                differentiated=True                     
                                                                                                jaxpr={ lambda ; z:f32[] ba:f32[]. let  
                                                                                                    bb:f32[] = sin z                    
                                                                                                    bc:f32[] = cos z                    
                                                                                                    bd:f32[] = cos bb                   
                                                                                                    be:f32[] = mul ba bd                
                                                                                                    bf:f32[] = mul be bc                
                                                                                                  in (bf,) }                            
                                                                                                policy=None                             
                                                                                                prevent_cse=True                        
                                                                                              ] p x                                     
                                                                                            in (y,) }                                   
                                                                                          policy=None                                   
                                                                                          prevent_cse=True                              
                                                                                        ] 3.0 g                                         
                                                                                      in (o,) }                                         
</pre>
</div></div>
</div>
</section>
</section>
<section id="practical-notes">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Practical notes"></a><span id="gradient-checkpointing-practical-notes"></span><h2>Practical notes<a class="headerlink" href="#practical-notes" title="Link to this heading">#</a></h2>
<p>When differentiated functions are staged out to XLA for compilation â€” for example by applying <a class="reference internal" href="../_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a> to a function which contains a <a class="reference internal" href="../_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a> call â€” XLA will automatically optimize the computation, including decisions about when to compute or rematerialize values. As a result, <strong><a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> often isnâ€™t needed for differentiated functions under a <a class="reference internal" href="../_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jit()</span></code></a></strong>. XLA will optimize things for you.</p>
<p>One exception is when using staged-out control flow, like <a class="reference internal" href="../_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>. Automatic compiler optimizations across multiple control flow primitives (for example, across a forward-pass <code class="docutils literal notranslate"><span class="pre">scan</span></code> and the corresponding backward-pass <code class="docutils literal notranslate"><span class="pre">scan</span></code>), typically arenâ€™t arenâ€™t as thorough. As a result, itâ€™s often a good idea to use <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> on the body function passed to <a class="reference internal" href="../_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>.</p>
<p>For example, one common pattern in large <a class="reference external" href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">Transformer models</a> is to express the architecture as a <a class="reference internal" href="../_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a> over layers so as to reduce compilation times. That is, using a simple fully-connected network as an analogy, instead of writing something like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LayerParam</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>  <span class="c1"># Weights-bias pair for a layer.</span>
<span class="n">ParamsList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">LayerParam</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">net</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ParamsList</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>Instead, iterate over the layer application with <a class="reference internal" href="../_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="p">[(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])),</span> 
          <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))]</span>

<span class="n">all_weights</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">W</span> <span class="k">for</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">params</span><span class="p">])</span>
<span class="n">all_biases</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">params</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W_b_pair</span><span class="p">):</span>
  <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">W_b_pair</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">net</span><span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">all_biases</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">all_biases</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>This scan-over-layers version reduces compile times, but by foiling some compiler optimizations it can lead to inefficient computation of gradients. To mitigate the issue, you can use <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> on the scanned function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span>
         <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">dots_with_no_batch_dims_saveable</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W_b_pair</span><span class="p">):</span>
  <span class="n">W</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">W_b_pair</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>By using <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a> this way, youâ€™re manually controlling which values JAXâ€™s autodiff saves between the forward and backward passes, and therefore not relying on XLA optimizations to choose for you.</p>
</section>
</section>
</article>
<footer class="prev-next-footer">
<div class="prev-next-area">
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage" id="pst-page-navigation-heading-2">
<i class="fa-solid fa-list"></i> On this page
  </div>
<nav aria-labelledby="pst-page-navigation-heading-2" class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-think-step-by-step">Letâ€™s think step by step</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-checkpoint-fundamentals"><code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> fundamentals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-policies-for-what-s-saveable">Custom policies for whatâ€™s saveable</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-recursive-jax-checkpoint">Advanced: Recursive <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#practical-notes">Practical notes</a></li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By The JAX authors
</p>
</div>
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>
<footer class="bd-footer">
</footer>
</body>
</html>