
<!DOCTYPE html>

<html data-content_root="../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Working with pytrees — JAX  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css?v=a746c00c" rel="stylesheet" type="text/css"/>
<link href="../_static/styles/sphinx-book-theme.css?v=384b581d" rel="stylesheet" type="text/css"/>
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css"/>
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
<link href="../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css?v=02ed413a" rel="stylesheet" type="text/css"/>
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" rel="preload"/>
<script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/documentation_options.js?v=9eb32ce0"></script>
<script src="../_static/doctools.js?v=9a2dae69"></script>
<script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../_static/copybutton.js?v=f281be69"></script>
<script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
<script src="../_static/design-tabs.js?v=36754332"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/working-with-pytrees';</script>
<link href="../_static/favicon.png" rel="icon"/>
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<a class="skip-link" href="#main-content" id="pst-skip-link">Skip to main content</a>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar">
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="../index.html">
<img alt="JAX  documentation - Home" class="logo__image only-light" src="../_static/jax_logo_250px.png"/>
<script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
</a></div>
<div class="sidebar-primary-item">
<script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">🔪 JAX - The Sharp Bits 🔪</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guide.html">Advanced Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/autodiff_remat.html">Control autodiff’s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor_guide.html">Developer Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">JAX Glossary of Terms</a></li>
</ul>
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<a class="btn btn-sm btn-source-repository-button" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/google/jax" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../_sources/tutorials/working-with-pytrees.md" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.md</span>
</a>
</li>
<li>
<button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Working with pytrees</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-pytree">What is a pytree?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-functions">Common pytree functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-function-jax-tree-map">Common function: <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-of-jax-tree-map-with-ml-model-parameters">Example of <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> with ML model parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-pytree-nodes">Custom pytree nodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytrees-and-jax-transformations">Pytrees and JAX transformations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explicit-key-paths">Explicit key paths</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-gotchas">Common pytree gotchas</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mistaking-pytree-nodes-for-leaves">Mistaking pytree nodes for leaves</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-none-by-jax-tree-util">Handling of <code class="docutils literal notranslate"><span class="pre">None</span></code> by <code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-pytrees-and-initialization-with-unexpected-values">Custom pytrees and initialization with unexpected values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-patterns">Common pytree patterns</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transposing-pytrees-with-jax-tree-map-and-jax-tree-transpose">Transposing pytrees with <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.tree.transpose</span></code></a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Working with pytrees"></a><section class="tex2jax_ignore mathjax_ignore" id="working-with-pytrees">
<span id="id1"></span><h1>Working with pytrees<a class="headerlink" href="#working-with-pytrees" title="Link to this heading">#</a></h1>
<p>JAX has built-in support for objects that look like dictionaries (dicts) of arrays, or lists of lists of dicts, or other nested structures — in JAX these are called pytrees.
This section will explain how to use them, provide useful code examples, and point out common “gotchas” and patterns.</p>
<section id="what-is-a-pytree">
<a class="dashAnchor" name="//apple_ref/cpp/Section/What is a pytree?"></a><span id="pytrees-what-is-a-pytree"></span><h2>What is a pytree?<a class="headerlink" href="#what-is-a-pytree" title="Link to this heading">#</a></h2>
<p>A pytree is a container-like structure built out of container-like Python objects — “leaf” pytrees and/or more pytrees. A pytree can include lists, tuples, and dicts. A leaf is anything that’s not a pytree, such as an array, but a single leaf is also a pytree.</p>
<p>In the context of machine learning (ML), a pytree can contain:</p>
<ul class="simple">
<li><p>Model parameters</p></li>
<li><p>Dataset entries</p></li>
<li><p>Reinforcement learning agent observations</p></li>
</ul>
<p>When working with datasets, you can often come across pytrees (such as lists of lists of dicts).</p>
<p>Below is an example of a simple pytree. In JAX, you can use <a class="reference internal" href="../_autosummary/jax.tree.leaves.html#jax.tree.leaves" title="jax.tree.leaves"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.leaves()</span></code></a>, to extract the flattened leaves from the trees, as demonstrated here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="n">example_trees</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="nb">object</span><span class="p">()],</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">()),</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">'k1'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'k2'</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)},</span> <span class="mi">5</span><span class="p">],</span>
    <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)},</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
<span class="p">]</span>

<span class="c1"># Print how many leaves the pytrees have.</span>
<span class="k">for</span> <span class="n">pytree</span> <span class="ow">in</span> <span class="n">example_trees</span><span class="p">:</span>
  <span class="c1"># This `jax.tree.leaves()` method extracts the flattened leaves from the pytrees.</span>
  <span class="n">leaves</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">(</span><span class="n">pytree</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">pytree</span><span class="p">)</span><span class="si">:</span><span class="s2">&lt;45</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">leaves</span><span class="p">)</span><span class="si">}</span><span class="s2"> leaves: </span><span class="si">{</span><span class="n">leaves</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 'a', &lt;object object at 0x7d0e908ec440&gt;]   has 3 leaves: [1, 'a', &lt;object object at 0x7d0e908ec440&gt;]
(1, (2, 3), ())                               has 3 leaves: [1, 2, 3]
[1, {'k1': 2, 'k2': (3, 4)}, 5]               has 5 leaves: [1, 2, 3, 4, 5]
{'a': 2, 'b': (2, 3)}                         has 3 leaves: [2, 2, 3]
Array([1, 2, 3], dtype=int32)                 has 1 leaves: [Array([1, 2, 3], dtype=int32)]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div>
</div>
</div>
</div>
<p>Any tree-like structure built out of container-like Python objects can be treated as a pytree in JAX.
Classes are considered container-like if they are in the pytree registry, which by default includes lists, tuples, and dicts. Any object whose type is <em>not</em> in the pytree container registry will be treated as a leaf node in the tree.</p>
<p>The pytree registry can be extended to include user-defined container classes by registering the class
with functions that specify how to flatten the tree; see <a class="reference internal" href="#pytrees-custom-pytree-nodes"><span class="std std-ref">Custom pytree nodes</span></a> below.</p>
</section>
<section id="common-pytree-functions">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Common pytree functions"></a><span id="pytrees-common-pytree-functions"></span><h2>Common pytree functions<a class="headerlink" href="#common-pytree-functions" title="Link to this heading">#</a></h2>
<p>JAX provides a number of utilities to operate over pytrees. These can be found in the <a class="reference internal" href="../jax.tree_util.html#module-jax.tree_util" title="jax.tree_util"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.tree_util</span></code></a> subpackage;
for convenience many of these have aliases in the <a class="reference internal" href="../jax.tree.html#module-jax.tree" title="jax.tree"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.tree</span></code></a> module.</p>
<section id="common-function-jax-tree-map">
<h3>Common function: <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code><a class="headerlink" href="#common-function-jax-tree-map" title="Link to this heading">#</a></h3>
<p>The most commonly used pytree function is <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>. It works analogously to Python’s native <code class="docutils literal notranslate"><span class="pre">map</span></code>, but transparently operates over entire pytrees.</p>
<p>Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">list_of_lists</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">6</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">6</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">8</span><span class="-Color -Color-Bold">]]</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a> also allows mapping a <a class="reference external" href="https://en.wikipedia.org/wiki/N-ary">N-ary</a> function over multiple arguments. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">another_list_of_lists</span> <span class="o">=</span> <span class="n">list_of_lists</span>
<span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="n">list_of_lists</span><span class="p">,</span> <span class="n">another_list_of_lists</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">6</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">6</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">8</span><span class="-Color -Color-Bold">]]</span>
</pre></div>
</div>
</div>
</div>
<p>When using multiple arguments with <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>, the structure of the inputs must exactly match. That is, lists must have the same number of elements, dicts must have the same keys, etc.</p>
</section>
<section id="example-of-jax-tree-map-with-ml-model-parameters">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Example of jax.tree.map with ML model parameters"></a><span id="pytrees-example-jax-tree-map-ml"></span><h3>Example of <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> with ML model parameters<a class="headerlink" href="#example-of-jax-tree-map-with-ml-model-parameters" title="Link to this heading">#</a></h3>
<p>This example demonstrates how pytree operations can be useful when training a simple <a class="reference external" href="https://en.wikipedia.org/wiki/Multilayer_perceptron">multi-layer perceptron (MLP)</a>.</p>
<p>Begin with defining the initial model parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">init_mlp_params</span><span class="p">(</span><span class="n">layer_widths</span><span class="p">):</span>
  <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">n_in</span><span class="p">,</span> <span class="n">n_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layer_widths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer_widths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_in</span><span class="p">,</span> <span class="n">n_out</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">n_in</span><span class="p">),</span>
             <span class="n">biases</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_out</span><span class="p">,))</span>
            <span class="p">)</span>
    <span class="p">)</span>
  <span class="k">return</span> <span class="n">params</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">init_mlp_params</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Use <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a> to check the shapes of the initial parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[</span>
    <span class="-Color -Color-Bold">{</span><span class="-Color -Color-Green">'biases'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">128</span>,<span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Green">'weights'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">128</span><span class="-Color -Color-Bold">)}</span>,
    <span class="-Color -Color-Bold">{</span><span class="-Color -Color-Green">'biases'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">128</span>,<span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Green">'weights'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">128</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">128</span><span class="-Color -Color-Bold">)}</span>,
    <span class="-Color -Color-Bold">{</span><span class="-Color -Color-Green">'biases'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Green">'weights'</span>: <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Cyan">128</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span><span class="-Color -Color-Bold">)}</span>
<span class="-Color -Color-Bold">]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, define the functions for training the MLP model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the forward pass.</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="o">*</span><span class="n">hidden</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">hidden</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="n">layer</span><span class="p">[</span><span class="s1">'weights'</span><span class="p">]</span> <span class="o">+</span> <span class="n">layer</span><span class="p">[</span><span class="s1">'biases'</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">@</span> <span class="n">last</span><span class="p">[</span><span class="s1">'weights'</span><span class="p">]</span> <span class="o">+</span> <span class="n">last</span><span class="p">[</span><span class="s1">'biases'</span><span class="p">]</span>

<span class="c1"># Define the loss function.</span>
<span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">forward</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Set the learning rate.</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># Using the stochastic gradient descent, define the parameter update function.</span>
<span class="c1"># Apply `@jax.jit` for JIT compilation (speed).</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="c1"># Calculate the gradients with `jax.grad`.</span>
  <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">)(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="c1"># Note that `grads` is a pytree with the same structure as `params`.</span>
  <span class="c1"># `jax.grad` is one of many JAX functions that has</span>
  <span class="c1"># built-in support for pytrees.</span>
  <span class="c1"># This is useful - you can apply the SGD update using JAX pytree utilities.</span>
  <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
      <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">p</span> <span class="o">-</span> <span class="n">LEARNING_RATE</span> <span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">grads</span>
  <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="custom-pytree-nodes">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom pytree nodes"></a><span id="pytrees-custom-pytree-nodes"></span><h2>Custom pytree nodes<a class="headerlink" href="#custom-pytree-nodes" title="Link to this heading">#</a></h2>
<p>This section explains how in JAX you can extend the set of Python types that will be considered <em>internal nodes</em> in pytrees (pytree nodes) by using <a class="reference internal" href="../_autosummary/jax.tree_util.register_pytree_node.html#jax.tree_util.register_pytree_node" title="jax.tree_util.register_pytree_node"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.register_pytree_node()</span></code></a> with <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>.</p>
<p>Why would you need this? In the previous examples, pytrees were shown as lists, tuples, and dicts, with everything else as pytree leaves. This is because if you define your own container class, it will be considered to be a pytree leaf unless you <em>register</em> it with JAX. This is also the case even if your container class has trees inside it. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Special</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">([</span>
    <span class="n">Special</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Special</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[&lt;__main__.Special</span> object at <span class="-Color -Color-Bold -Color-Bold-Cyan">0x7d0e90f97450</span>&gt;, &lt;__main__.Special object at <span class="-Color -Color-Bold -Color-Bold-Cyan">0x7d0ee0189590</span><span class="-Color -Color-Bold">&gt;]</span>
</pre></div>
</div>
</div>
</div>
<p>Accordingly, if you try to use a <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a> expecting the leaves to be elements inside the container, you will get an error:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="n">Special</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">Special</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
  <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 jax.tree.map(<span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> x: x + <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>,                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>[                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">3 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>Special(<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>),                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>Special(<span style="color: #0000ff; text-decoration-color: #0000ff">2</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">4</span>)                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">tree.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">61</span> in  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">map</span>                                                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 58 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>tree: Any,                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 59 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>*rest: Any,                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 60 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>is_leaf: Callable[[Any], <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>] | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>) -&gt; Any:                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 61 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> tree_util.tree_map(f, tree, *rest, is_leaf=is_leaf)                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 62 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 63 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 64 </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@overload</span>                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">tree_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">21</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">tree_map</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 318 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 319 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>leaves, treedef = tree_flatten(tree, is_leaf)                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>all_leaves = [leaves] + [treedef.flatten_up_to(r) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> r <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> rest]                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 321 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> treedef.unflatten(f(*xs) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> xs <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*all_leaves))                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 322 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 323 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 324 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">build_tree</span>(treedef: PyTreeDef, xs: Any) -&gt; Any:                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">tree_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">21</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;genexpr&gt;</span>                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 318 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 319 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>leaves, treedef = tree_flatten(tree, is_leaf)                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>all_leaves = [leaves] + [treedef.flatten_up_to(r) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> r <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> rest]                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 321 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> treedef.unflatten(f(*xs) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> xs <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*all_leaves))                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 322 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 323 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 324 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">build_tree</span>(treedef: PyTreeDef, xs: Any) -&gt; Any:                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;lambda&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 jax.tree.map(<span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> x: x + <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>,                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>[                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">3 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>Special(<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>),                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>Special(<span style="color: #0000ff; text-decoration-color: #0000ff">2</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">4</span>)                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>unsupported operand <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">type</span><span style="font-weight: bold">(</span>s<span style="font-weight: bold">)</span> for +: <span style="color: #008000; text-decoration-color: #008000">'Special'</span> and <span style="color: #008000; text-decoration-color: #008000">'int'</span>
</pre>
</div></div>
</div>
<p>As a solution, JAX allows to extend the set of types to be considered internal pytree nodes through a global registry of types. Additionally, the values of registered types are traversed recursively.</p>
<p>First, register a new type using <a class="reference internal" href="../_autosummary/jax.tree_util.register_pytree_node.html#jax.tree_util.register_pytree_node" title="jax.tree_util.register_pytree_node"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.register_pytree_node()</span></code></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.tree_util</span> <span class="kn">import</span> <span class="n">register_pytree_node</span>

<span class="k">class</span> <span class="nc">RegisteredSpecial</span><span class="p">(</span><span class="n">Special</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"RegisteredSpecial(x=</span><span class="si">{}</span><span class="s2">, y=</span><span class="si">{}</span><span class="s2">)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">special_flatten</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""Specifies a flattening recipe.</span>

<span class="sd">  Params:</span>
<span class="sd">    v: The value of the registered type to flatten.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A pair of an iterable with the children to be flattened recursively,</span>
<span class="sd">    and some opaque auxiliary data to pass back to the unflattening recipe.</span>
<span class="sd">    The auxiliary data is stored in the treedef for use during unflattening.</span>
<span class="sd">    The auxiliary data could be used, for example, for dictionary keys.</span>
<span class="sd">  """</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
  <span class="n">aux_data</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">aux_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">special_unflatten</span><span class="p">(</span><span class="n">aux_data</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""Specifies an unflattening recipe.</span>

<span class="sd">  Params:</span>
<span class="sd">    aux_data: The opaque data that was specified during flattening of the</span>
<span class="sd">      current tree definition.</span>
<span class="sd">    children: The unflattened children</span>

<span class="sd">  Returns:</span>
<span class="sd">    A reconstructed object of the registered type, using the specified</span>
<span class="sd">    children and auxiliary data.</span>
<span class="sd">  """</span>
  <span class="k">return</span> <span class="n">RegisteredSpecial</span><span class="p">(</span><span class="o">*</span><span class="n">children</span><span class="p">)</span>

<span class="c1"># Global registration</span>
<span class="n">register_pytree_node</span><span class="p">(</span>
    <span class="n">RegisteredSpecial</span><span class="p">,</span>
    <span class="n">special_flatten</span><span class="p">,</span>    <span class="c1"># Instruct JAX what are the children nodes.</span>
    <span class="n">special_unflatten</span>   <span class="c1"># Instruct JAX how to pack back into a `RegisteredSpecial`.</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now you can traverse the special container structure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
  <span class="p">[</span>
   <span class="n">RegisteredSpecial</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
   <span class="n">RegisteredSpecial</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
  <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Magenta">RegisteredSpecial</span><span class="-Color -Color-Bold">(</span><span class="-Color -Color-Yellow">x</span>=<span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>, <span class="-Color -Color-Yellow">y</span>=<span class="-Color -Color-Bold -Color-Bold-Cyan">2</span><span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Bold -Color-Bold-Magenta">RegisteredSpecial</span><span class="-Color -Color-Bold">(</span><span class="-Color -Color-Yellow">x</span>=<span class="-Color -Color-Bold -Color-Bold-Cyan">3</span>, <span class="-Color -Color-Yellow">y</span>=<span class="-Color -Color-Bold -Color-Bold-Cyan">5</span><span class="-Color -Color-Bold">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Modern Python comes equipped with helpful tools to make defining containers easier. Some will work with JAX out-of-the-box, but others require more care.</p>
<p>For instance, a Python <code class="docutils literal notranslate"><span class="pre">NamedTuple</span></code> subclass doesn’t need to be registered to be considered a pytree node type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span> <span class="nc">MyOtherContainer</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
  <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
  <span class="n">a</span><span class="p">:</span> <span class="n">Any</span>
  <span class="n">b</span><span class="p">:</span> <span class="n">Any</span>
  <span class="n">c</span><span class="p">:</span> <span class="n">Any</span>

<span class="c1"># NamedTuple subclasses are handled as pytree nodes, so</span>
<span class="c1"># this will work out-of-the-box.</span>
<span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">([</span>
    <span class="n">MyOtherContainer</span><span class="p">(</span><span class="s1">'Alice'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">MyOtherContainer</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[</span><span class="-Color -Color-Green">'Alice'</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">2</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">3</span>, <span class="-Color -Color-Green">'Bob'</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">5</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">6</span><span class="-Color -Color-Bold">]</span>
</pre></div>
</div>
</div>
</div>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">name</span></code> field now appears as a leaf, because all tuple elements are children. This is what happens when you don’t have to register the class the hard way.</p>
</section>
<section id="pytrees-and-jax-transformations">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Pytrees and JAX transformations"></a><span id="pytree-and-jax-transformations"></span><h2>Pytrees and JAX transformations<a class="headerlink" href="#pytrees-and-jax-transformations" title="Link to this heading">#</a></h2>
<p>Many JAX functions, like <a class="reference internal" href="../_autosummary/jax.lax.scan.html#jax.lax.scan" title="jax.lax.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.lax.scan()</span></code></a>, operate over pytrees of arrays. In addition, all JAX function transformations can be applied to functions that accept as input and produce as output pytrees of arrays.</p>
<p>Some JAX function transformations take optional parameters that specify how certain input or output values should be treated (such as the <code class="docutils literal notranslate"><span class="pre">in_axes</span></code> and <code class="docutils literal notranslate"><span class="pre">out_axes</span></code> arguments to <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a>). These parameters can also be pytrees, and their structure must correspond to the pytree structure of the corresponding arguments. In particular, to be able to “match up” leaves in these parameter pytrees with values in the argument pytrees, the parameter pytrees are often constrained to be tree prefixes of the argument pytrees.</p>
<p>For example, if you pass the following input to <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a> (note that the input arguments to a function are considered a tuple):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="p">{</span><span class="s2">"k1"</span><span class="p">:</span> <span class="n">a2</span><span class="p">,</span> <span class="s2">"k2"</span><span class="p">:</span> <span class="n">a3</span><span class="p">}))</span>
</pre></div>
</div>
<p>then you can use the following <code class="docutils literal notranslate"><span class="pre">in_axes</span></code> pytree to specify that only the <code class="docutils literal notranslate"><span class="pre">k2</span></code> argument is mapped (<code class="docutils literal notranslate"><span class="pre">axis=0</span></code>), and the rest aren’t mapped over (<code class="docutils literal notranslate"><span class="pre">axis=None</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">"k1"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"k2"</span><span class="p">:</span> <span class="mi">0</span><span class="p">}))</span>
</pre></div>
</div>
<p>The optional parameter pytree structure must match that of the main input pytree. However, the optional parameters can optionally be specified as a “prefix” pytree, meaning that a single leaf value can be applied to an entire sub-pytree.</p>
<p>For example, if you have the same <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a> input as above, but wish to only map over the dictionary argument, you can use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># equivalent to (None, {"k1": 0, "k2": 0})</span>
</pre></div>
</div>
<p>Alternatively, if you want every argument to be mapped, you can write a single leaf value that is applied over the entire argument tuple pytree:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># equivalent to (0, {"k1": 0, "k2": 0})</span>
</pre></div>
</div>
<p>This happens to be the default <code class="docutils literal notranslate"><span class="pre">in_axes</span></code> value for <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a>.</p>
<p>The same logic applies to other optional parameters that refer to specific input or output values of a transformed function, such as <code class="docutils literal notranslate"><span class="pre">out_axes</span></code> in <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a>.</p>
</section>
<section id="explicit-key-paths">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Explicit key paths"></a><span id="pytrees-explicity-key-paths"></span><h2>Explicit key paths<a class="headerlink" href="#explicit-key-paths" title="Link to this heading">#</a></h2>
<p>In a pytree each leaf has a <em>key path</em>. A key path for a leaf is a <code class="docutils literal notranslate"><span class="pre">list</span></code> of <em>keys</em>, where the length of the list is equal to the depth of the leaf in the pytree . Each <em>key</em> is a <a class="reference external" href="https://docs.python.org/3/glossary.html#term-hashable">hashable object</a> that represents an index into the corresponding pytree node type. The type of the key depends on the pytree node type; for example, the type of keys for <code class="docutils literal notranslate"><span class="pre">dict</span></code>s is different from the type of keys for <code class="docutils literal notranslate"><span class="pre">tuple</span></code>s.</p>
<p>For built-in pytree node types, the set of keys for any pytree node instance is unique. For a pytree comprising nodes with this property, the key path for each leaf is unique.</p>
<p>JAX has the following <code class="docutils literal notranslate"><span class="pre">jax.tree_util.*</span></code> methods for working with key paths:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../_autosummary/jax.tree_util.tree_flatten_with_path.html#jax.tree_util.tree_flatten_with_path" title="jax.tree_util.tree_flatten_with_path"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.tree_flatten_with_path()</span></code></a>: Works similarly to <a class="reference internal" href="../_autosummary/jax.tree.flatten.html#jax.tree.flatten" title="jax.tree.flatten"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.flatten()</span></code></a>, but returns key paths.</p></li>
<li><p><a class="reference internal" href="../_autosummary/jax.tree_util.tree_map_with_path.html#jax.tree_util.tree_map_with_path" title="jax.tree_util.tree_map_with_path"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.tree_map_with_path()</span></code></a>: Works similarly to <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>, but the function also takes key paths as arguments.</p></li>
<li><p><a class="reference internal" href="../_autosummary/jax.tree_util.keystr.html#jax.tree_util.keystr" title="jax.tree_util.keystr"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.keystr()</span></code></a>: Given a general key path, returns a reader-friendly string expression.</p></li>
</ul>
<p>For example, one use case is to print debugging information related to a certain leaf value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">ATuple</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">"ATuple"</span><span class="p">,</span> <span class="p">(</span><span class="s1">'name'</span><span class="p">))</span>

<span class="n">tree</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">'k1'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'k2'</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)},</span> <span class="n">ATuple</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)]</span>
<span class="n">flattened</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten_with_path</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">flattened</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Value of tree</span><span class="si">{</span><span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">keystr</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value of tree[0]: 1
Value of tree[1]['k1']: 2
Value of tree[1]['k2'][0]: 3
Value of tree[1]['k2'][1]: 4
Value of tree[2].name: foo
</pre></div>
</div>
</div>
</div>
<p>To express key paths, JAX provides a few default key types for the built-in pytree node types, namely:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SequenceKey(idx:</span> <span class="pre">int)</span></code>: For lists and tuples.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DictKey(key:</span> <span class="pre">Hashable)</span></code>: For dictionaries.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GetAttrKey(name:</span> <span class="pre">str)</span></code>: For <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code>s and preferably custom pytree nodes (more in the next section)</p></li>
</ul>
<p>You are free to define your own key types for your custom nodes. They will work with <a class="reference internal" href="../_autosummary/jax.tree_util.keystr.html#jax.tree_util.keystr" title="jax.tree_util.keystr"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree_util.keystr()</span></code></a> as long as their <code class="docutils literal notranslate"><span class="pre">__str__()</span></code> method is also overridden with a reader-friendly expression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">flattened</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Key path of tree</span><span class="si">{</span><span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">keystr</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Key path of tree[0]: (SequenceKey(idx=0),)
Key path of tree[1]['k1']: (SequenceKey(idx=1), DictKey(key='k1'))
Key path of tree[1]['k2'][0]: (SequenceKey(idx=1), DictKey(key='k2'), SequenceKey(idx=0))
Key path of tree[1]['k2'][1]: (SequenceKey(idx=1), DictKey(key='k2'), SequenceKey(idx=1))
Key path of tree[2].name: (SequenceKey(idx=2), GetAttrKey(name='name'))
</pre></div>
</div>
</div>
</div>
</section>
<section id="common-pytree-gotchas">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Common pytree gotchas"></a><span id="pytrees-common-pytree-gotchas"></span><h2>Common pytree gotchas<a class="headerlink" href="#common-pytree-gotchas" title="Link to this heading">#</a></h2>
<p>This section covers some of the most common problems (“gotchas”) encountered when using JAX pytrees.</p>
<section id="mistaking-pytree-nodes-for-leaves">
<h3>Mistaking pytree nodes for leaves<a class="headerlink" href="#mistaking-pytree-nodes-for-leaves" title="Link to this heading">#</a></h3>
<p>A common gotcha to look out for is accidentally introducing <em>tree nodes</em> instead of <em>leaves</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_tree</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))]</span>

<span class="c1"># Try to make another pytree with ones instead of zeros.</span>
<span class="n">shapes</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">a_tree</span><span class="p">)</span>
<span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[</span>
    <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Magenta">Array</span><span class="-Color -Color-Bold">([</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>.<span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Yellow">dtype</span>=<span class="-Color -Color-Magenta">float32</span><span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Bold -Color-Bold-Magenta">Array</span><span class="-Color -Color-Bold">([</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>.<span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Yellow">dtype</span>=<span class="-Color -Color-Magenta">float32</span><span class="-Color -Color-Bold">))</span>,
    <span class="-Color -Color-Bold">(</span><span class="-Color -Color-Bold -Color-Bold-Magenta">Array</span><span class="-Color -Color-Bold">([</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>.<span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Yellow">dtype</span>=<span class="-Color -Color-Magenta">float32</span><span class="-Color -Color-Bold">)</span>, <span class="-Color -Color-Bold -Color-Bold-Magenta">Array</span><span class="-Color -Color-Bold">([</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>., <span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>.<span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Yellow">dtype</span>=<span class="-Color -Color-Magenta">float32</span><span class="-Color -Color-Bold">))</span>
<span class="-Color -Color-Bold">]</span>
</pre></div>
</div>
</div>
</div>
<p>What happened here is that the <code class="docutils literal notranslate"><span class="pre">shape</span></code> of an array is a tuple, which is a pytree node, with its elements as leaves. Thus, in the map, instead of calling <code class="docutils literal notranslate"><span class="pre">jnp.ones</span></code> on e.g. <code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">3)</span></code>, it’s called on <code class="docutils literal notranslate"><span class="pre">2</span></code> and <code class="docutils literal notranslate"><span class="pre">3</span></code>.</p>
<p>The solution will depend on the specifics, but there are two broadly applicable options:</p>
<ul class="simple">
<li><p>Rewrite the code to avoid the intermediate <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>.</p></li>
<li><p>Convert the tuple into a NumPy array (<code class="docutils literal notranslate"><span class="pre">np.array</span></code>) or a JAX NumPy array (<code class="docutils literal notranslate"><span class="pre">jnp.array</span></code>), which makes the entire sequence a leaf.</p></li>
</ul>
</section>
<section id="handling-of-none-by-jax-tree-util">
<h3>Handling of <code class="docutils literal notranslate"><span class="pre">None</span></code> by <code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code><a class="headerlink" href="#handling-of-none-by-jax-tree-util" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> functions treat <code class="docutils literal notranslate"><span class="pre">None</span></code> as the absence of a pytree node, not as a leaf:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[]</span>
</pre></div>
</div>
</div>
</div>
<p>To treat <code class="docutils literal notranslate"><span class="pre">None</span></code> as a leaf, you can use the <code class="docutils literal notranslate"><span class="pre">is_leaf</span></code> argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">leaves</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">is_leaf</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">[</span><span class="-Color -Color-Magenta">None</span>, <span class="-Color -Color-Magenta">None</span>, <span class="-Color -Color-Magenta">None</span><span class="-Color -Color-Bold">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="custom-pytrees-and-initialization-with-unexpected-values">
<h3>Custom pytrees and initialization with unexpected values<a class="headerlink" href="#custom-pytrees-and-initialization-with-unexpected-values" title="Link to this heading">#</a></h3>
<p>Another common gotcha with user-defined pytree objects is that JAX transformations occasionally initialize them with unexpected values, so that any input validation done at initialization may fail. For example:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTree</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">register_pytree_node</span><span class="p">(</span><span class="n">MyTree</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">tree</span><span class="p">:</span> <span class="p">((</span><span class="n">tree</span><span class="o">.</span><span class="n">a</span><span class="p">,),</span> <span class="kc">None</span><span class="p">),</span>
    <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">MyTree</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">MyTree</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.0</span><span class="p">))</span>

<span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">tree</span><span class="p">)</span>      <span class="c1"># Error because object() is passed to `MyTree`.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">659</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">656 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dt = x.dtype                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">657 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">658 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>659 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dt = np.result_type(x)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">661 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Cannot interpret <span style="color: #008000; text-decoration-color: #008000">'&lt;object object at 0x7d0e908ed360&gt;'</span> as a data type

<span style="font-style: italic">The above exception was the direct cause of the following exception:</span>

<span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2164</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">array</span>                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2161 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Use lattice_result_type rather than result_type to avoid canonicalization.</span>          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2162 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Otherwise, weakly-typed inputs would have their dtypes canonicalized.</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2163 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2164 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dtype = dtypes._lattice_result_type(*leaves)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>] <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> leaves <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dtypes.float_        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2165 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This happens if, e.g. one of the entries is a memoryview object.</span>                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2167 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This is rare, so we only handle it if the normal path fails.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;genexpr&gt;</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">477</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">474 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">475 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>(value: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">476 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""Return a (dtype, weak_type) tuple for the given input."""</span>                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>477 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> dtype(value), <span style="color: #00ffff; text-decoration-color: #00ffff">any</span>(value <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> typ <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> typ <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _weak_types) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> is_weakly_typed(value   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">478 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">479 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_type_promotion_lattice</span>(jax_numpy_dtype_promotion: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>[JAXType, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[JAXTyp   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">480 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">661</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">658 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">659 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dt = np.result_type(x)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>661 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">663 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Value '{</span>x<span style="color: #808000; text-decoration-color: #808000">}' with dtype {</span>dt<span style="color: #808000; text-decoration-color: #808000">} is not a valid JAX array "</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">664 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span><span style="color: #808000; text-decoration-color: #808000">"type. Only arrays of numeric types are supported by JAX."</span>)            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Cannot determine dtype of <span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">object</span><span style="color: #000000; text-decoration-color: #000000"> object at </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0x7d0e908ed360</span><span style="font-weight: bold">&gt;</span>

<span style="font-style: italic">During handling of the above exception, another exception occurred:</span>

<span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">10</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8 </span>tree = MyTree(jnp.arange(<span style="color: #0000ff; text-decoration-color: #0000ff">5.0</span>))                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 9 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>10 jax.vmap(<span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> x: x)(tree)      <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Error because object() is passed to `MyTree`.</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">11 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">api.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1237</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">vmap_f</span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1234 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>args_flat, in_tree  = tree_flatten((args, kwargs), is_leaf=batching.is_vmappable)     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1235 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>f = lu.wrap_init(fun)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1236 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>flat_fun, out_tree = batching.flatten_fun_for_vmap(f, in_tree)                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1237 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_axes_flat = flatten_axes(<span style="color: #808000; text-decoration-color: #808000">"vmap in_axes"</span>, in_tree, (in_axes, <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>), kws=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1238 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>axis_size_ = (axis_size <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> axis_size <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> <span style="color: #0000ff; text-decoration-color: #0000ff">else</span>                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1239 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │     </span>_mapped_axis_size(fun, in_tree, args_flat, in_axes_flat, <span style="color: #808000; text-decoration-color: #808000">"vmap"</span>))       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1240 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_flat = batching.batch(                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">api_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">41</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">1</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">flatten_axes</span>                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">408 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># and return the flattened result</span>                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">409 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(mattjj,phawkins): improve this implementation</span>                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">410 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>proxy = <span style="color: #00ffff; text-decoration-color: #00ffff">object</span>()                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>411 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dummy = tree_unflatten(treedef, [<span style="color: #00ffff; text-decoration-color: #00ffff">object</span>()] * treedef.num_leaves)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">412 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>axes = []                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">413 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>add_leaves = <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> i, x: axes.extend([i] * <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(tree_flatten(x)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]))                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">414 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">tree_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">33</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">tree_unflatten</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 130 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">│   </span><span style="color: #808000; text-decoration-color: #808000">- :func:`jax.tree.leaves`</span>                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 131 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">│   </span><span style="color: #808000; text-decoration-color: #808000">- :func:`jax.tree.structure`</span>                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 132 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 133 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> treedef.unflatten(leaves)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 134 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 135 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 136 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">tree_leaves</span>(tree: Any,                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;lambda&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">6</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 3 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.a = jnp.asarray(a)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 4 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 5 </span>register_pytree_node(MyTree, <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> tree: ((tree.a,), <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>),                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 6 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> _, args: MyTree(*args))                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8 </span>tree = MyTree(jnp.arange(<span style="color: #0000ff; text-decoration-color: #0000ff">5.0</span>))                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 9 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">__init__</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 1 </span><span style="color: #0000ff; text-decoration-color: #0000ff">class</span> <span style="color: #00ff00; text-decoration-color: #00ff00; text-decoration: underline">MyTree</span>:                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 2 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">__init__</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, a):                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 3 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.a = jnp.asarray(a)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 4 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 5 </span>register_pytree_node(MyTree, <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> tree: ((tree.a,), <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>),                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> _, args: MyTree(*args))                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2242</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">asarray</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2239 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes.check_user_dtype_supported(dtype, <span style="color: #808000; text-decoration-color: #808000">"asarray"</span>)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2240 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dtype <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2241 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dtype = dtypes.canonicalize_dtype(dtype, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore[</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2242 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> array(a, dtype=dtype, copy=<span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>(copy), order=order)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2243 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2244 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2245 </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@util</span>.implements(np.copy, lax_description=_ARRAY_DOC)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2169</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">array</span>                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This happens if, e.g. one of the entries is a memoryview object.</span>                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2167 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This is rare, so we only handle it if the normal path fails.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>leaves = [_convert_to_array_if_dtype_fails(leaf) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> leaf <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> leaves]                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2169 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dtype = dtypes._lattice_result_type(*leaves)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2170 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2171 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> weak_type:                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2172 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dtype = dtypes.canonicalize_dtype(dtype, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore[</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;genexpr&gt;</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">477</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">474 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">475 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>(value: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">476 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""Return a (dtype, weak_type) tuple for the given input."""</span>                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>477 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> dtype(value), <span style="color: #00ffff; text-decoration-color: #00ffff">any</span>(value <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> typ <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> typ <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _weak_types) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> is_weakly_typed(value   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">478 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">479 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_type_promotion_lattice</span>(jax_numpy_dtype_promotion: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>[JAXType, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[JAXTyp   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">480 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">663</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">661 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>663 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Value '{</span>x<span style="color: #808000; text-decoration-color: #808000">}' with dtype {</span>dt<span style="color: #808000; text-decoration-color: #808000">} is not a valid JAX array "</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">664 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span><span style="color: #808000; text-decoration-color: #808000">"type. Only arrays of numeric types are supported by JAX."</span>)            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">665 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(jakevdp): fix return type annotation and remove this ignore.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Value <span style="color: #008000; text-decoration-color: #008000">'&lt;object object at 0x7d0e908ed360&gt;'</span> with dtype object is not a valid JAX array type. Only arrays 
of numeric types are supported by JAX.
</pre>
</div></div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)(</span><span class="n">tree</span><span class="p">)</span>  <span class="c1"># Error because MyTree(...) is passed to `MyTree`.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/lax_numpy.py:2242: FutureWarning: None encountered in jnp.array(); this is currently treated as NaN. In the future this will result in an error.
  return array(a, dtype=dtype, copy=bool(copy), order=order)  # type: ignore
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">659</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">656 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dt = x.dtype                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">657 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">658 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>659 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dt = np.result_type(x)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">661 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Cannot interpret <span style="color: #008000; text-decoration-color: #008000">'&lt;object object at 0x7d0e908ee110&gt;'</span> as a data type

<span style="font-style: italic">The above exception was the direct cause of the following exception:</span>

<span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2164</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">array</span>                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2161 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Use lattice_result_type rather than result_type to avoid canonicalization.</span>          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2162 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Otherwise, weakly-typed inputs would have their dtypes canonicalized.</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2163 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2164 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dtype = dtypes._lattice_result_type(*leaves)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>] <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> leaves <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dtypes.float_        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2165 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This happens if, e.g. one of the entries is a memoryview object.</span>                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2167 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This is rare, so we only handle it if the normal path fails.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;genexpr&gt;</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">477</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">474 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">475 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>(value: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">476 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""Return a (dtype, weak_type) tuple for the given input."""</span>                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>477 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> dtype(value), <span style="color: #00ffff; text-decoration-color: #00ffff">any</span>(value <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> typ <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> typ <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _weak_types) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> is_weakly_typed(value   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">478 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">479 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_type_promotion_lattice</span>(jax_numpy_dtype_promotion: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>[JAXType, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[JAXTyp   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">480 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">661</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">658 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">659 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dt = np.result_type(x)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>661 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">663 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Value '{</span>x<span style="color: #808000; text-decoration-color: #808000">}' with dtype {</span>dt<span style="color: #808000; text-decoration-color: #808000">} is not a valid JAX array "</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">664 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span><span style="color: #808000; text-decoration-color: #808000">"type. Only arrays of numeric types are supported by JAX."</span>)            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Cannot determine dtype of <span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">object</span><span style="color: #000000; text-decoration-color: #000000"> object at </span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0x7d0e908ee110</span><span style="font-weight: bold">&gt;</span>

<span style="font-style: italic">During handling of the above exception, another exception occurred:</span>

<span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 jax.jacobian(<span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> x: x)(tree)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Error because MyTree(...) is passed to `MyTree`.</span>          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">api.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">927</span> in  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">jacfun</span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 924 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 925 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>y, pullback, aux = _vjp(f_partial, *dyn_args, has_aux=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 926 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>tree_map(partial(_check_output_dtype_jacrev, holomorphic), y)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 927 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jac = vmap(pullback)(_std_basis(y))                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 928 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jac = jac[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>] <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">isinstance</span>(argnums, <span style="color: #00ffff; text-decoration-color: #00ffff">int</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> jac                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 929 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>example_args = dyn_args[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>] <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">isinstance</span>(argnums, <span style="color: #00ffff; text-decoration-color: #00ffff">int</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dyn_args                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 930 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jac_tree = tree_map(partial(_jacrev_unravel, y), example_args, jac)                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">api.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1237</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">vmap_f</span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1234 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>args_flat, in_tree  = tree_flatten((args, kwargs), is_leaf=batching.is_vmappable)     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1235 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>f = lu.wrap_init(fun)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1236 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>flat_fun, out_tree = batching.flatten_fun_for_vmap(f, in_tree)                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1237 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_axes_flat = flatten_axes(<span style="color: #808000; text-decoration-color: #808000">"vmap in_axes"</span>, in_tree, (in_axes, <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>), kws=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1238 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>axis_size_ = (axis_size <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> axis_size <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> <span style="color: #0000ff; text-decoration-color: #0000ff">else</span>                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1239 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │     </span>_mapped_axis_size(fun, in_tree, args_flat, in_axes_flat, <span style="color: #808000; text-decoration-color: #808000">"vmap"</span>))       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1240 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_flat = batching.batch(                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">api_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">41</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">1</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">flatten_axes</span>                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">408 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># and return the flattened result</span>                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">409 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(mattjj,phawkins): improve this implementation</span>                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">410 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>proxy = <span style="color: #00ffff; text-decoration-color: #00ffff">object</span>()                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>411 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dummy = tree_unflatten(treedef, [<span style="color: #00ffff; text-decoration-color: #00ffff">object</span>()] * treedef.num_leaves)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">412 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>axes = []                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">413 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>add_leaves = <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> i, x: axes.extend([i] * <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(tree_flatten(x)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]))                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">414 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">tree_util.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">33</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">tree_unflatten</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 130 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">│   </span><span style="color: #808000; text-decoration-color: #808000">- :func:`jax.tree.leaves`</span>                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 131 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">│   </span><span style="color: #808000; text-decoration-color: #808000">- :func:`jax.tree.structure`</span>                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 132 </span><span style="color: #bfbf7f; text-decoration-color: #bfbf7f">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 133 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> treedef.unflatten(leaves)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 134 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 135 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 136 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">tree_leaves</span>(tree: Any,                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;lambda&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">6</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 3 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.a = jnp.asarray(a)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 4 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 5 </span>register_pytree_node(MyTree, <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> tree: ((tree.a,), <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>),                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 6 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> _, args: MyTree(*args))                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8 </span>tree = MyTree(jnp.arange(<span style="color: #0000ff; text-decoration-color: #0000ff">5.0</span>))                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 9 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">__init__</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 1 </span><span style="color: #0000ff; text-decoration-color: #0000ff">class</span> <span style="color: #00ff00; text-decoration-color: #00ff00; text-decoration: underline">MyTree</span>:                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 2 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">__init__</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, a):                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 3 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.a = jnp.asarray(a)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 4 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 5 </span>register_pytree_node(MyTree, <span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> tree: ((tree.a,), <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>),                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">lambda</span> _, args: MyTree(*args))                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2242</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">asarray</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2239 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes.check_user_dtype_supported(dtype, <span style="color: #808000; text-decoration-color: #808000">"asarray"</span>)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2240 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dtype <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2241 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dtype = dtypes.canonicalize_dtype(dtype, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore[</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2242 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> array(a, dtype=dtype, copy=<span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>(copy), order=order)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2243 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2244 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2245 </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@util</span>.implements(np.copy, lax_description=_ARRAY_DOC)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2169</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">array</span>                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This happens if, e.g. one of the entries is a memoryview object.</span>                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2167 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># This is rare, so we only handle it if the normal path fails.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>leaves = [_convert_to_array_if_dtype_fails(leaf) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> leaf <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> leaves]                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2169 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>dtype = dtypes._lattice_result_type(*leaves)[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2170 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2171 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> weak_type:                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2172 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dtype = dtypes.canonicalize_dtype(dtype, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore[</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">669</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;genexpr&gt;</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">667 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">668 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_lattice_result_type</span>(*args: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>669 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes, weak_types = <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(*(_dtype_and_weaktype(arg) <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args))                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">670 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(dtypes) == <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>:                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">671 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_dtype = dtypes[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">672 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_weak_type = weak_types[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>]                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">477</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">474 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">475 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_dtype_and_weaktype</span>(value: Any) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[DType, <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>]:                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">476 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""Return a (dtype, weak_type) tuple for the given input."""</span>                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>477 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> dtype(value), <span style="color: #00ffff; text-decoration-color: #00ffff">any</span>(value <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> typ <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> typ <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _weak_types) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> is_weakly_typed(value   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">478 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">479 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_type_promotion_lattice</span>(jax_numpy_dtype_promotion: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>[JAXType, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[JAXTyp   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">480 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""</span>                                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">dtypes.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">663</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">dtype</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">660 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> err:                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">661 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Cannot determine dtype of {</span>x<span style="color: #808000; text-decoration-color: #808000">}"</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">from</span> <span style="color: #00ffff; text-decoration-color: #00ffff; text-decoration: underline">err</span>                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">662 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> dt <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> _jax_dtype_set <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> issubdtype(dt, extended):                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>663 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">f"Value '{</span>x<span style="color: #808000; text-decoration-color: #808000">}' with dtype {</span>dt<span style="color: #808000; text-decoration-color: #808000">} is not a valid JAX array "</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">664 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span><span style="color: #808000; text-decoration-color: #808000">"type. Only arrays of numeric types are supported by JAX."</span>)            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">665 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(jakevdp): fix return type annotation and remove this ignore.</span>                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">666 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> canonicalize_dtype(dt, allow_extended_dtype=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> canonicalize <span style="color: #0000ff; text-decoration-color: #0000ff">else</span> dt  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># ty</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Value <span style="color: #008000; text-decoration-color: #008000">'&lt;object object at 0x7d0e908ee110&gt;'</span> with dtype object is not a valid JAX array type. Only arrays 
of numeric types are supported by JAX.
</pre>
</div></div>
</div>
<ul class="simple">
<li><p>In the first case with <code class="docutils literal notranslate"><span class="pre">jax.vmap(...)(tree)</span></code>, JAX’s internals use arrays of <code class="docutils literal notranslate"><span class="pre">object()</span></code> values to infer the structure of the tree</p></li>
<li><p>In the second case with <code class="docutils literal notranslate"><span class="pre">jax.jacobian(...)(tree)</span></code>, the Jacobian of a function mapping a tree to a tree is defined as a tree of trees.</p></li>
</ul>
<p><strong>Potential solution 1:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">__new__</span></code> methods of custom pytree classes should generally avoid doing any array conversion or other input validation, or else anticipate and handle these special cases. For example:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTree</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">object</span> <span class="ow">or</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">MyTree</span><span class="p">)):</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Potential solution 2:</strong></p>
<ul class="simple">
<li><p>Structure your custom <code class="docutils literal notranslate"><span class="pre">tree_unflatten</span></code> function so that it avoids calling <code class="docutils literal notranslate"><span class="pre">__init__</span></code>. If you choose this route, make sure that your <code class="docutils literal notranslate"><span class="pre">tree_unflatten</span></code> function stays in sync with <code class="docutils literal notranslate"><span class="pre">__init__</span></code> if and when the code is updated. Example:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tree_unflatten</span><span class="p">(</span><span class="n">aux_data</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
  <span class="k">del</span> <span class="n">aux_data</span>  <span class="c1"># Unused in this class.</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">MyTree</span><span class="p">)</span>
  <span class="n">obj</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
  <span class="k">return</span> <span class="n">obj</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="common-pytree-patterns">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Common pytree patterns"></a><span id="pytrees-common-pytree-patterns"></span><h2>Common pytree patterns<a class="headerlink" href="#common-pytree-patterns" title="Link to this heading">#</a></h2>
<p>This section covers some of the most common patterns with JAX pytrees.</p>
<section id="transposing-pytrees-with-jax-tree-map-and-jax-tree-transpose">
<h3>Transposing pytrees with <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.tree.transpose</span></code><a class="headerlink" href="#transposing-pytrees-with-jax-tree-map-and-jax-tree-transpose" title="Link to this heading">#</a></h3>
<p>To transpose a pytree (turn a list of trees into a tree of lists), JAX has two functions: {func} <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> (more basic) and <a class="reference internal" href="../_autosummary/jax.tree.transpose.html#jax.tree.transpose" title="jax.tree.transpose"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.transpose()</span></code></a> (more flexible, complex and verbose).</p>
<p><strong>Option 1:</strong> Use <a class="reference internal" href="../_autosummary/jax.tree.map.html#jax.tree.map" title="jax.tree.map"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.map()</span></code></a>. Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tree_transpose</span><span class="p">(</span><span class="n">list_of_trees</span><span class="p">):</span>
<span class="w">  </span><span class="sd">"""</span>
<span class="sd">  Converts a list of trees of identical structure into a single tree of lists.</span>
<span class="sd">  """</span>
  <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">xs</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="o">*</span><span class="n">list_of_trees</span><span class="p">)</span>

<span class="c1"># Convert a dataset from row-major to column-major.</span>
<span class="n">episode_steps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">tree_transpose</span><span class="p">(</span><span class="n">episode_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">{</span><span class="-Color -Color-Green">'obs'</span>: <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">3</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Green">'t'</span>: <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">2</span><span class="-Color -Color-Bold">]}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Option 2:</strong> For more complex transposes, use <a class="reference internal" href="../_autosummary/jax.tree.transpose.html#jax.tree.transpose" title="jax.tree.transpose"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.tree.transpose()</span></code></a>, which is more verbose, but allows you specify the structure of the inner and outer pytree for more flexibility. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
  <span class="n">outer_treedef</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">structure</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">episode_steps</span><span class="p">]),</span>
  <span class="n">inner_treedef</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">structure</span><span class="p">(</span><span class="n">episode_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
  <span class="n">pytree_to_transpose</span> <span class="o">=</span> <span class="n">episode_steps</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class="-Color -Color-Bold">{</span><span class="-Color -Color-Green">'obs'</span>: <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">3</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">4</span><span class="-Color -Color-Bold">]</span>, <span class="-Color -Color-Green">'t'</span>: <span class="-Color -Color-Bold">[</span><span class="-Color -Color-Bold -Color-Bold-Cyan">1</span>, <span class="-Color -Color-Bold -Color-Bold-Cyan">2</span><span class="-Color -Color-Bold">]}</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</article>
<footer class="prev-next-footer">
<div class="prev-next-area">
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage" id="pst-page-navigation-heading-2">
<i class="fa-solid fa-list"></i> On this page
  </div>
<nav aria-labelledby="pst-page-navigation-heading-2" class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-pytree">What is a pytree?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-functions">Common pytree functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-function-jax-tree-map">Common function: <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-of-jax-tree-map-with-ml-model-parameters">Example of <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> with ML model parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-pytree-nodes">Custom pytree nodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pytrees-and-jax-transformations">Pytrees and JAX transformations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explicit-key-paths">Explicit key paths</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-gotchas">Common pytree gotchas</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mistaking-pytree-nodes-for-leaves">Mistaking pytree nodes for leaves</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-none-by-jax-tree-util">Handling of <code class="docutils literal notranslate"><span class="pre">None</span></code> by <code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-pytrees-and-initialization-with-unexpected-values">Custom pytrees and initialization with unexpected values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-pytree-patterns">Common pytree patterns</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transposing-pytrees-with-jax-tree-map-and-jax-tree-transpose">Transposing pytrees with <code class="docutils literal notranslate"><span class="pre">jax.tree.map</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.tree.transpose</span></code></a></li>
</ul>
</li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By The JAX authors
</p>
</div>
<div class="footer-item">
<p class="copyright">
    
      © Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>
<footer class="bd-footer">
</footer>
</body>
</html>