
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jax._src.config &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/style.css?v=02ed413a" />
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/jax/_src/config';</script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../../../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/Common_Gotchas_in_JAX.html">ðŸ”ª JAX - The Sharp Bits ðŸ”ª</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../advanced_guide.html">Advanced Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>



<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/autodiff_remat.html">Control autodiffâ€™s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/How_JAX_primitives_work.html">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../contributor_guide.html">Developer Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">JAX Glossary of Terms</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/google/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for jax._src.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The JAX Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Hashable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">jax_jit</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">transfer_guard_lib</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">xla_client</span>
<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">logging_config</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;_T&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bool_env</span><span class="p">(</span><span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Read an environment variable and interpret it as a boolean.</span>

<span class="sd">  True values are (case insensitive): &#39;y&#39;, &#39;yes&#39;, &#39;t&#39;, &#39;true&#39;, &#39;on&#39;, and &#39;1&#39;;</span>
<span class="sd">  false values are &#39;n&#39;, &#39;no&#39;, &#39;f&#39;, &#39;false&#39;, &#39;off&#39;, and &#39;0&#39;.</span>

<span class="sd">  Args:</span>
<span class="sd">    varname: the name of the variable</span>
<span class="sd">    default: the default boolean value</span>
<span class="sd">  Raises: ValueError if the environment variable is anything else.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">))</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid truth value </span><span class="si">{</span><span class="n">val</span><span class="si">!r}</span><span class="s2"> for environment </span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">int_env</span><span class="p">(</span><span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Read an environment variable and interpret it as an integer.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)))</span>


<span class="n">UPGRADE_BOOL_HELP</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot; This will be enabled by default in future versions of JAX, at which &quot;</span>
    <span class="s2">&quot;point all uses of the flag will be considered deprecated (following &quot;</span>
    <span class="s2">&quot;the `API compatibility policy &quot;</span>
    <span class="s2">&quot;&lt;https://jax.readthedocs.io/en/latest/api_compatibility.html&gt;`_).&quot;</span><span class="p">)</span>

<span class="n">UPGRADE_BOOL_EXTRA_DESC</span> <span class="o">=</span> <span class="s2">&quot; (transient)&quot;</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
  <span class="n">_HAS_DYNAMIC_ATTRIBUTES</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># There are two kinds of value holders: FlagHolders, which hold global</span>
    <span class="c1"># flags, and StateContextManagers, which hold state that can be changed</span>
    <span class="c1"># locally within a thread. A value holder needs a `.value` property and a</span>
    <span class="c1"># `._set()` method.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized config option: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
          <span class="s2">&quot;For flags with a corresponding contextmanager, read their value &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;via e.g. `config.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` rather than `config.FLAGS.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized config option: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">holder</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">holder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

  <span class="k">def</span> <span class="nf">add_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="n">opt_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config option </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already defined&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">holder</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">opt_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">config_with_absl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers absl flags for the JAX configs.</span>

<span class="sd">    E.g., for each JAX config defined using define_bool_state(), this method</span>
<span class="sd">    registers an absl boolean flag, with the same name.</span>

<span class="sd">    This is the recommended method to call if you use `app.run(main)` and you</span>
<span class="sd">    need JAX flags.  Example:</span>

<span class="sd">    ```python</span>
<span class="sd">    from absl import app</span>
<span class="sd">    import jax</span>
<span class="sd">    ...</span>

<span class="sd">    if __name__ == &#39;__main__&#39;:</span>
<span class="sd">      jax.config.config_with_absl()</span>
<span class="sd">      app.run(main)</span>
<span class="sd">    ```</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">absl.flags</span> <span class="k">as</span> <span class="nn">absl_FLAGS</span>  <span class="c1"># noqa: F401  # pytype: disable=import-error</span>
    <span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">flags</span> <span class="k">as</span> <span class="n">absl_flags</span>  <span class="c1"># pytype: disable=import-error</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">absl_flags</span> <span class="o">=</span> <span class="n">absl_flags</span>
    <span class="n">absl_defs</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">bool</span><span class="p">:</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">,</span>
                  <span class="nb">int</span><span class="p">:</span>  <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">,</span>
                  <span class="nb">float</span><span class="p">:</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_float</span><span class="p">,</span>
                  <span class="nb">str</span><span class="p">:</span>  <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">,</span>
                  <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_enum</span> <span class="p">}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">flag_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">holder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="n">absl_defs</span><span class="p">[</span><span class="n">flag_type</span><span class="p">](</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">meta_args</span><span class="p">,</span> <span class="o">**</span><span class="n">meta_kwargs</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">call_after_init</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_absl_config</span><span class="p">(</span><span class="n">absl_flags</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">complete_absl_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absl_flags</span><span class="p">):</span>
    <span class="c1"># NOTE: avoid calling from outside this module. Instead, use</span>
    <span class="c1"># `config_with_absl()`, and (in rare cases) `parse_flags_with_absl()`.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">holder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_holders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># This can happen if a new flag was added after config_with_absl() was</span>
        <span class="c1"># called, but before complete_absl_config was run. We could in principle</span>
        <span class="c1"># add code to DEFINE_... to register any newly added flags with ABSL</span>
        <span class="c1"># if config_with_absl() has already been called, but arguably the user</span>
        <span class="c1"># should have called config_with_absl() later.</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">present</span><span class="p">:</span>
        <span class="n">holder</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">parse_flags_with_absl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses command-line args that start with --jax.</span>

<span class="sd">    This method should be used only by advanced users. Most users should use</span>
<span class="sd">    :meth:`config_with_absl` instead.</span>

<span class="sd">    This method has serious limitations: e.g., although it parses only the</span>
<span class="sd">    --jax* command-line args, it runs the validators of all registered absl</span>
<span class="sd">    flags, even non-JAX ones that have not been set yet; as such, for the</span>
<span class="sd">    non-JAX flags, the validators run on the default flag values, not on the</span>
<span class="sd">    values indicated by the command-line args.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">already_configured_with_absl</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_configured_with_absl</span><span class="p">:</span>
      <span class="c1"># Extract just the --jax... flags (before the first --) from argv. In some</span>
      <span class="c1"># environments (e.g. ipython/colab) argv might be a mess of things</span>
      <span class="c1"># parseable by absl and other junk.</span>
      <span class="n">jax_argv</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
      <span class="n">jax_argv</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">jax_argv</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--jax&#39;</span><span class="p">))]</span>

      <span class="kn">import</span> <span class="nn">absl.flags</span>  <span class="c1"># pytype: disable=import-error</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config_with_absl</span><span class="p">()</span>
      <span class="n">absl</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">(</span><span class="n">jax_argv</span><span class="p">,</span> <span class="n">known_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">complete_absl_config</span><span class="p">(</span><span class="n">absl</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
      <span class="n">already_configured_with_absl</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">trace_context</span><span class="p">():</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns a tuple of configuration values that affect tracing.</span>

<span class="sd">  These values are included in the cache key for linear_util.cache.</span>

<span class="sd">  Values included in this set should also most likely be included in</span>
<span class="sd">  the C++ JIT state, which is handled separately.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">tls</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="n">axis_env_state</span> <span class="o">=</span> <span class="p">()</span>
  <span class="n">mesh_context_manager</span> <span class="o">=</span> <span class="p">()</span>
  <span class="n">context</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span>
  <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">axis_env_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">axis_env_state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">axis_env_state</span>
  <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">mesh_context_manager</span><span class="p">:</span>
    <span class="n">mesh_context_manager</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">mesh_context_manager</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">axis_env_state</span><span class="p">,</span> <span class="n">mesh_context_manager</span><span class="p">,</span> <span class="n">enable_x64</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">numpy_rank_promotion</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">default_matmul_precision</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">dynamic_shapes</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">numpy_dtype_promotion</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">default_device</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">random_seed_offset</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">threefry_partitionable</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">softmax_custom_jvp</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">enable_memories</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">disable_jit</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">debug_key_reuse</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="n">jax_xla_profile_version</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
          <span class="c1"># Technically this affects jaxpr-&gt;stablehlo lowering, not tracing.</span>
          <span class="n">hlo_source_file_canonicalization_regex</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

<span class="n">_read</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">_read</span>
<span class="n">update</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">update</span>
<span class="n">parse_flags_with_absl</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">parse_flags_with_absl</span>


<span class="k">class</span> <span class="nc">NoDefault</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">no_default</span> <span class="o">=</span> <span class="n">NoDefault</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_Unset</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">unset</span> <span class="o">=</span> <span class="n">_Unset</span><span class="p">()</span>

<span class="n">_thread_local_state</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_StateContextManager</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
  <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s1">&#39;_name&#39;</span><span class="p">,</span> <span class="s1">&#39;_value&#39;</span><span class="p">,</span> <span class="s1">&#39;_update_thread_local_hook&#39;</span><span class="p">,</span> <span class="s1">&#39;_update_global_hook&#39;</span><span class="p">,</span>
      <span class="s1">&#39;_validator&#39;</span><span class="p">,</span> <span class="s1">&#39;_default_context_manager_value&#39;</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
      <span class="n">default</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
      <span class="n">help</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_T</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_T</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">validator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">extra_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="n">default_context_manager_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">no_default</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;jax_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context manager for `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` config option&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extra_description</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="si">{</span><span class="n">help</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_hook</span> <span class="o">=</span> <span class="n">update_global_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span> <span class="o">=</span> <span class="n">update_thread_local_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">validator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_default_context_manager_value</span> <span class="o">=</span> <span class="n">default_context_manager_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;bool() not supported for instances of type &#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span>
        <span class="s2">&quot;(did you mean to use &#39;</span><span class="si">{0}</span><span class="s2">.value&#39; instead?)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_hook</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_hook</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_thread_local_state</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_T</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

  <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">no_default</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="n">no_default</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_context_manager_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_default</span><span class="p">:</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_context_manager_value</span>  <span class="c1"># default_context_manager_value provided to constructor</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no default_value provided to constructor and no value provided as an</span>
        <span class="c1"># argument, so we raise an error</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context manager for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> config option &quot;</span>
                        <span class="s2">&quot;requires an argument representing the new value for &quot;</span>
                        <span class="s2">&quot;the config option.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
    <span class="n">prev_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">prev_val</span> <span class="ow">is</span> <span class="n">unset</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">_T</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_add_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private method that adds hooks to an existing context-manager.</span>

<span class="sd">    Used to avoid cyclic import dependencies.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span> <span class="o">=</span> <span class="n">update_thread_local_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_global_hook</span> <span class="o">=</span> <span class="n">update_global_hook</span>
    <span class="n">update_global_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  This function is a convenience wrapper. It defines a flag, environment</span>
<span class="sd">  variable, and corresponding thread-local state, which can be managed via the</span>
<span class="sd">  contextmanager it returns.</span>

<span class="sd">  The thread-local state value can be read via the ``config.&lt;option_name&gt;``</span>
<span class="sd">  attribute, where ``config`` is the singleton ``Config`` instance.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: boolean, a default value for the option.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>
<span class="sd">    update_global_hook: a optional callback that is called with the updated</span>
<span class="sd">      value of the global state when it is altered or set initially.</span>
<span class="sd">    update_thread_local_hook: a optional callback that is called with the</span>
<span class="sd">      updated value of the thread-local state when it is altered or set</span>
<span class="sd">      initially.</span>
<span class="sd">    upgrade: optional indicator that this flag controls a canonical feature</span>
<span class="sd">      upgrade, so that it is `True` for the incoming functionality, `False`</span>
<span class="sd">      for the outgoing functionality to be deprecated.</span>
<span class="sd">    extra_description: string, optional: extra information to add to the</span>
<span class="sd">      summary description.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>

<span class="sd">  Example:</span>

<span class="sd">    enable_foo = config.define_bool_state(</span>
<span class="sd">        name=&#39;jax_enable_foo&#39;,</span>
<span class="sd">        default=False,</span>
<span class="sd">        help=&#39;Enable foo.&#39;)</span>

<span class="sd">    # Now the JAX_ENABLE_FOO shell environment variable and --jax_enable_foo</span>
<span class="sd">    # command-line flag can be used to control the process-level value of</span>
<span class="sd">    # the configuration option, in addition to using e.g.</span>
<span class="sd">    # ``config.update(&quot;jax_enable_foo&quot;, True)`` directly. We can also use a</span>
<span class="sd">    # context manager:</span>

<span class="sd">    with enable_foo(True):</span>
<span class="sd">      ...</span>

<span class="sd">  The value of the thread-local state or flag can be accessed via</span>
<span class="sd">  ``config.jax_enable_foo``. Reading it via ``config.FLAGS.jax_enable_foo`` is</span>
<span class="sd">  an error.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type bool, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">default</span> <span class="o">=</span> <span class="n">bool_env</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">upgrade</span><span class="p">:</span>
    <span class="n">help</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">UPGRADE_BOOL_HELP</span>
    <span class="n">extra_description</span> <span class="o">+=</span> <span class="n">UPGRADE_BOOL_EXTRA_DESC</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">bool</span><span class="p">](</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">extra_description</span><span class="o">=</span><span class="n">extra_description</span><span class="p">,</span> <span class="n">default_context_manager_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">})</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    enum_values: list of strings representing the possible values for the</span>
<span class="sd">      option.</span>
<span class="sd">    default: string, default value.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type str, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for JAX flag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">new_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new enum value must be in </span><span class="si">{</span><span class="n">enum_values</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">str</span><span class="p">](</span>
      <span class="n">name</span><span class="p">,</span>
      <span class="n">default</span><span class="p">,</span>
      <span class="n">help</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
      <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span>
      <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;enum_values&quot;</span><span class="p">:</span> <span class="n">enum_values</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    enum_values: list of strings representing the possible values for the</span>
<span class="sd">      option.</span>
<span class="sd">    default: optional string, default value.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type str or None, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for JAX flag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
      <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">new_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new enum value must be None or in </span><span class="si">{</span><span class="n">enum_values</span><span class="si">}</span><span class="s2">, &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="s1">&#39;str | None&#39;</span><span class="p">](</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">validate</span>
  <span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
      <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span>
      <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;enum_values&quot;</span><span class="p">:</span> <span class="n">enum_values</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: optional int, default value.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type int, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">default_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
  <span class="k">if</span> <span class="n">default_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">default</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_env</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default_env</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for JAX flag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;new int config value must be None or of type int, &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s1"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">int</span><span class="p">](</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span>
                                <span class="n">update_thread_local_hook</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">})</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">define_float_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: default value.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type float, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">default_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
  <span class="k">if</span> <span class="n">default_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">default</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">default_env</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default_env</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for JAX flag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;new float config value must be None or of type float, &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s1"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">float</span><span class="p">](</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span>
                                  <span class="n">update_thread_local_hook</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">})</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">define_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: string, a default value for the option.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>
<span class="sd">    update_global_hook: an optional callback that is called with the updated</span>
<span class="sd">      value of the global state when it is altered or set initially.</span>
<span class="sd">    update_thread_local_hook: an optional callback that is called with the</span>
<span class="sd">      updated value of the thread-local state when it is altered or set</span>
<span class="sd">      initially.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type str, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;new string config value must be of type str,&#39;</span>
                       <span class="sa">f</span><span class="s1">&#39; got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s1"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">define_string_or_object_state</span><span class="p">(</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">define_optional_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  See docstring for ``define_bool_state``.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: optional string, a default value for the option.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>
<span class="sd">    update_global_hook: an optional callback that is called with the updated</span>
<span class="sd">      value of the global state when it is altered or set initially.</span>
<span class="sd">    update_thread_local_hook: an optional callback that is called with the</span>
<span class="sd">      updated value of the thread-local state when it is altered or set</span>
<span class="sd">      initially.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default value must be of type str or None, got </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of type </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="n">default</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new string config value must be None or of type str,&#39;</span>
                       <span class="sa">f</span><span class="s1">&#39; got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s1"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">define_string_or_object_state</span><span class="p">(</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">define_string_or_object_state</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">validator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">  Similar to ``define_string_state``, except the context manager will accept</span>
<span class="sd">  any object, not just a string. Any value passed via commandline flag or</span>
<span class="sd">  environment variable will be treated as a string.</span>

<span class="sd">  Args:</span>
<span class="sd">    name: string, converted to lowercase to define the name of the config</span>
<span class="sd">      option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">      corresponding shell environment variable.</span>
<span class="sd">    default: string, a default value for the option.</span>
<span class="sd">    help: string, used to populate the flag help information as well as the</span>
<span class="sd">      docstring of the returned context manager.</span>
<span class="sd">    update_global_hook: an optional callback that is called with the updated</span>
<span class="sd">      value of the global state when it is altered or set initially.</span>
<span class="sd">    update_thread_local_hook: an optional callback that is called with the</span>
<span class="sd">      updated value of the thread-local state when it is altered or set</span>
<span class="sd">      initially.</span>
<span class="sd">    validator: an optional callback that is called with the new</span>
<span class="sd">      value on any update, and should raise an error if the new value is</span>
<span class="sd">      invalid.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A contextmanager to control the thread-local state value.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">_StateContextManager</span><span class="p">[</span><span class="n">Any</span><span class="p">](</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span>
      <span class="n">validator</span><span class="p">)</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">meta_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">meta_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="n">help</span><span class="p">})</span>
  <span class="k">return</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">FlagHolder</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
  <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;_update_hook&quot;</span><span class="p">)</span>

  <span class="n">_name</span><span class="p">:</span> <span class="nb">str</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">_T</span>
  <span class="n">_update_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span>
               <span class="n">update_hook</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_hook</span> <span class="o">=</span> <span class="n">update_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;bool() not supported for instances of type &#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span>
        <span class="s2">&quot;(did you mean to use &#39;</span><span class="si">{0}</span><span class="s2">.value&#39; instead?)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_update_hook</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">_value_holders</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized config option: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">DEFINE_bool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlagHolder</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
  <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">holder</span> <span class="o">=</span> <span class="n">FlagHolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">update_hook</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">holder</span>


<span class="k">def</span> <span class="nf">DEFINE_integer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlagHolder</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
  <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">holder</span> <span class="o">=</span> <span class="n">FlagHolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">update_hook</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">holder</span>


<span class="k">def</span> <span class="nf">DEFINE_float</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlagHolder</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
  <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">holder</span> <span class="o">=</span> <span class="n">FlagHolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">update_hook</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">holder</span>


<span class="k">def</span> <span class="nf">DEFINE_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlagHolder</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
  <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">holder</span> <span class="o">=</span> <span class="n">FlagHolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">update_hook</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">holder</span>


<span class="k">def</span> <span class="nf">DEFINE_enum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlagHolder</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
  <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">holder</span> <span class="o">=</span> <span class="n">FlagHolder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">update_hook</span><span class="p">)</span>
  <span class="n">config</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">holder</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">holder</span>


<span class="n">already_configured_with_absl</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># The C++ JIT maintains its own copy of several configuration items as</span>
<span class="c1"># a global/thread-local state. These methods allow updates to part of the</span>
<span class="c1"># state when a configuration value changes.</span>
<span class="k">class</span> <span class="nc">_GlobalExtraJitContext</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
  <span class="n">numpy_rank_promotion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">numpy_dtype_promotion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">default_matmul_precision</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">dynamic_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">random_seed_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">threefry_partitionable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">softmax_custom_jvp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">xla_profile_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_update_global_jit_state</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
  <span class="n">gs</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span>
  <span class="n">context</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="ow">or</span> <span class="n">_GlobalExtraJitContext</span><span class="p">()</span>
  <span class="n">gs</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ThreadLocalExtraJitContext</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A namedtuple containing states to add to the cache key.</span>

<span class="sd">  Just in time compilation (for jit, pmap, etc) behavior is configurable through</span>
<span class="sd">  global and thread-local options, used in the cache key.</span>

<span class="sd">  The initialization, which uses both config.py and core.py is done using</span>
<span class="sd">  `_update_thread_local_jit_state` in core.py to prevent circular imports.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dynamic_trace_state</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">axis_env_state</span><span class="p">:</span> <span class="n">Hashable</span> <span class="o">=</span> <span class="p">()</span>
  <span class="n">mesh_context_manager</span><span class="p">:</span> <span class="n">Hashable</span> <span class="o">=</span> <span class="p">()</span>

  <span class="c1"># Values set by _StateContextManager context managers.</span>
  <span class="c1"># CAUTION: these must be initialized to `None`! The state context manager</span>
  <span class="c1"># restores these to None on exit. If the object default is not `None`, the</span>
  <span class="c1"># context manager is not a no-op, which leads to problems with stale state</span>
  <span class="c1"># (e.g. spurious cache misses in tests).</span>
  <span class="n">numpy_rank_promotion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">numpy_dtype_promotion</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">default_matmul_precision</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">dynamic_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">random_seed_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">threefry_partitionable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">softmax_custom_jvp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">xla_profile_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">_ThreadLocalStateCache</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;&quot;A thread local cache for _ThreadLocalExtraJitContext</span>

<span class="sd">  The extra_jit_context in jax_jit.thread_local_state() may get updated and thus</span>
<span class="sd">  incurring dispatch overhead for comparing this python object during jit calls.</span>
<span class="sd">  We want to duduplicate the objects that have the same hash/equality to also</span>
<span class="sd">  have the same object ID, since the equality check is much faster if the object</span>
<span class="sd">  IDs match.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">canonicalize</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">128</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>


<span class="n">_thread_local_state_cache</span> <span class="o">=</span> <span class="n">_ThreadLocalStateCache</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">update_thread_local_jit_state</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
  <span class="n">tls</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="c1"># After xla_client._version &gt;= 70, the thread_local object will necessarily</span>
  <span class="c1"># be initialized when accessed. The following line can be removed when the</span>
  <span class="c1"># minimum  jaxlib version is past version 70</span>
  <span class="n">context</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="ow">or</span> <span class="n">_ThreadLocalExtraJitContext</span><span class="p">()</span>
  <span class="n">tmp</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
  <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="o">=</span> <span class="n">_thread_local_state_cache</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>


<span class="c1"># TODO(b/214340779): remove flag when XLA:CPU is improved.</span>
<span class="n">jax2tf_associative_scan_reductions</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax2tf_associative_scan_reductions&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;JAX has two separate lowering rules for the cumulative reduction &#39;</span>
        <span class="s1">&#39;primitives (cumsum, cumprod, cummax, cummin). On CPUs and GPUs it uses &#39;</span>
        <span class="s1">&#39;a lax.associative_scan, while for TPUs it uses the HLO ReduceWindow. &#39;</span>
        <span class="s1">&#39;The latter has a slow implementation on CPUs and GPUs. &#39;</span>
        <span class="s1">&#39;By default, jax2tf uses the TPU lowering. Set this flag to True to &#39;</span>
        <span class="s1">&#39;use the associative scan lowering usage, and only if it makes a difference &#39;</span>
        <span class="s1">&#39;for your application. &#39;</span>
        <span class="s1">&#39;See the jax2tf README.md for more details.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">jax2tf_default_native_serialization</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax2tf_default_native_serialization&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX2TF_DEFAULT_NATIVE_SERIALIZATION&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Sets the default value of the native_serialization parameter to &#39;</span>
        <span class="s1">&#39;jax2tf.convert. Prefer using the parameter instead of the flag, &#39;</span>
        <span class="s1">&#39;the flag may be removed in the future.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">jax_serialization_version</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_serialization_version&#39;</span><span class="p">,</span>
    <span class="c1"># Note: bump the default serialization version at least one month after</span>
    <span class="c1"># we update XlaCallModule to support the new version, so that serialized</span>
    <span class="c1"># modules are forward compatible with deployed versions of XlaCallModule.</span>
    <span class="c1"># Version 9 of XlaCallModule is supported since October 27th, 2023.</span>
    <span class="n">default</span><span class="o">=</span><span class="n">int_env</span><span class="p">(</span><span class="s1">&#39;JAX_SERIALIZATION_VERSION&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;The version number to use for native serialization. This must be &#39;</span>
        <span class="s1">&#39;within the range of versions supported by the tf.XlaCallModule &#39;</span>
        <span class="s1">&#39;used in your deployment environment. &#39;</span>
        <span class="s1">&#39;See https://github.com/google/jax/blob/main/jax/experimental/jax2tf/README.md#native-serialization-versions.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">jax_platforms</span> <span class="o">=</span> <span class="n">define_optional_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_platforms&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Comma-separated list of platform names specifying which platforms jax &#39;</span>
        <span class="s1">&#39;should initialize. If any of the platforms in this list are not successfully &#39;</span>
        <span class="s1">&#39;initialized, an exception will be raised and the program will be aborted. &#39;</span>
        <span class="s1">&#39;The first platform in the list will be the default platform. &#39;</span>
        <span class="s1">&#39;For example, config.jax_platforms=cpu,tpu means that CPU and TPU backends &#39;</span>
        <span class="s1">&#39;will be initialized, and the CPU backend will be used unless otherwise &#39;</span>
        <span class="s1">&#39;specified. If TPU initialization fails, it will raise an exception. &#39;</span>
        <span class="s1">&#39;By default, jax will try to initialize all available &#39;</span>
        <span class="s1">&#39;platforms and will default to GPU or TPU if available, and fallback to CPU &#39;</span>
        <span class="s1">&#39;otherwise.&#39;</span>
        <span class="p">))</span>

<span class="n">enable_checks</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_checks&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn on invariant checking for JAX internals. Makes things slower.&#39;</span><span class="p">)</span>

<span class="n">debug_key_reuse</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_key_reuse&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Turn on experimental key reuse checking. With this configuration enabled,&#39;</span>
          <span class="s1">&#39; typed PRNG keys (i.e. keys created with jax.random.key()) will have their&#39;</span>
          <span class="s1">&#39; usage tracked, and incorrect reuse of a previously-used key will lead to&#39;</span>
          <span class="s1">&#39; an error. Currently enabling this leads to a small Python overhead on&#39;</span>
          <span class="s1">&#39; every call to a JIT-compiled function with keys as inputs or outputs.&#39;</span><span class="p">))</span>

<span class="n">check_tracer_leaks</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_check_tracer_leaks&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Turn on checking for leaked tracers as soon as a trace completes. &#39;</span>
          <span class="s1">&#39;Enabling leak checking may have performance impacts: some caching &#39;</span>
          <span class="s1">&#39;is disabled, and other overheads may be added. Additionally, be aware &#39;</span>
          <span class="s1">&#39;that some Python debuggers can cause false positives, so it is recommended &#39;</span>
          <span class="s1">&#39;to disable any debuggers while leak checking is enabled.&#39;</span><span class="p">))</span>
<span class="n">checking_leaks</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">check_tracer_leaks</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">debug_nans</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_nans&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Add nan checks to every operation. When a nan is detected on the &#39;</span>
          <span class="s1">&#39;output of a jit-compiled computation, call into the un-compiled &#39;</span>
          <span class="s1">&#39;version in an attempt to more precisely identify the operation &#39;</span>
          <span class="s1">&#39;which produced the nan.&#39;</span><span class="p">))</span>

<span class="n">debug_infs</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_infs&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Add inf checks to every operation. When an inf is detected on the &#39;</span>
          <span class="s1">&#39;output of a jit-compiled computation, call into the un-compiled &#39;</span>
          <span class="s1">&#39;version in an attempt to more precisely identify the operation &#39;</span>
          <span class="s1">&#39;which produced the inf.&#39;</span><span class="p">))</span>

<span class="n">log_compiles</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_log_compiles&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Log a message each time every time `jit` or `pmap` compiles an XLA &#39;</span>
          <span class="s1">&#39;computation. Logging is performed with `logging`. When this &#39;</span>
          <span class="s1">&#39;option is set, the log level is WARNING; otherwise the level is &#39;</span>
          <span class="s1">&#39;DEBUG.&#39;</span><span class="p">))</span>

<span class="n">explain_cache_misses</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_explain_cache_misses&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Each time there is a miss on one of the main caches (e.g. the &#39;</span>
          <span class="s1">&#39;tracing cache), log an explanation.. Logging is performed with &#39;</span>
          <span class="s1">&#39;`logging`. When this option is set, the log level is WARNING; &#39;</span>
          <span class="s1">&#39;otherwise the level is DEBUG.&#39;</span><span class="p">))</span>

<span class="n">log_checkpoint_residuals</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_log_checkpoint_residuals&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Log a message every time jax.checkpoint (aka jax.remat) is &#39;</span>
          <span class="s1">&#39;partially evaluated (e.g. for autodiff), printing what residuals &#39;</span>
          <span class="s1">&#39;are saved.&#39;</span><span class="p">))</span>

<span class="n">pmap_shmap_merge</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_pmap_shmap_merge&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If True, pmap and shard_map API will be merged.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_update_jax_memories_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_memories</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_jax_memories_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_memories</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">enable_memories</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="s1">&#39;jax_enable_memories&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_jax_memories_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_jax_memories_thread_local</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;If True, will allow fetching memory kinds available on executable &quot;</span>
          <span class="s2">&quot;and annotate Shardings with it.&quot;</span><span class="p">))</span>

<span class="n">spmd_mode</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_spmd_mode&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allow_all&#39;</span><span class="p">,</span> <span class="s1">&#39;allow_jit&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;allow_jit&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Decides whether Math on `jax.Array`&#39;s that are not fully addressable &quot;</span>
          <span class="s2">&quot;(i.e. spans across multiple processes) is allowed. The options are: &quot;</span>
          <span class="s2">&quot;* allow_jit: Default, `pjit` and `jax.jit` computations are allowed &quot;</span>
          <span class="s2">&quot;    to execute on non-fully addressable `jax.Array`s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;* allow_all: `jnp`, normal math (like `a + b`, etc), `pjit`, &quot;</span>
          <span class="s2">&quot;    `jax.jit` and all other operations are allowed to &quot;</span>
          <span class="s2">&quot;    execute on non-fully addressable `jax.Array`s.&quot;</span><span class="p">))</span>


<span class="n">distributed_debug</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_distributed_debug&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enable logging useful for debugging multi-process distributed &#39;</span>
          <span class="s1">&#39;computations. Logging is performed with `logging` at WARNING &#39;</span>
          <span class="s1">&#39;level.&#39;</span><span class="p">))</span>

<span class="n">random_seed_offset</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_random_seed_offset&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Offset to all random seeds (e.g. argument to jax.random.key()).&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_global_jit_state</span><span class="p">(</span>
        <span class="n">random_seed_offset</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">update_thread_local_jit_state</span><span class="p">(</span>
        <span class="n">random_seed_offset</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">legacy_prng_key</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_legacy_prng_key&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Specify the behavior when raw PRNG keys are passed to &#39;</span>
          <span class="s1">&#39;jax.random APIs.&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">enable_custom_prng</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_custom_prng&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables an internal upgrade that allows one to define custom &#39;</span>
          <span class="s1">&#39;pseudo-random number generator implementations.&#39;</span><span class="p">))</span>

<span class="n">default_prng_impl</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_prng_impl&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;threefry2x32&#39;</span><span class="p">,</span> <span class="s1">&#39;rbg&#39;</span><span class="p">,</span> <span class="s1">&#39;unsafe_rbg&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;threefry2x32&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the default PRNG implementation, used when one is not &#39;</span>
          <span class="s1">&#39;explicitly provided at seeding time.&#39;</span><span class="p">))</span>

<span class="n">threefry_partitionable</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_threefry_partitionable&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables internal threefry PRNG implementation changes that &#39;</span>
          <span class="s1">&#39;render it automatically partitionable in some cases. Without this &#39;</span>
          <span class="s1">&#39;flag, using the standard jax.random pseudo-random number generation &#39;</span>
          <span class="s1">&#39;may result in extraneous communication and/or redundant distributed &#39;</span>
          <span class="s1">&#39;computation. With this flag, the communication overheads disappear &#39;</span>
          <span class="s1">&#39;in some cases.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_global_jit_state</span><span class="p">(</span>
        <span class="n">threefry_partitionable</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">update_thread_local_jit_state</span><span class="p">(</span>
        <span class="n">threefry_partitionable</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>


<span class="n">softmax_custom_jvp</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_softmax_custom_jvp&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Use a new custom_jvp rule for jax.nn.softmax. The new rule should &#39;</span>
          <span class="s1">&#39;improve memory usage and stability. Set True to use new &#39;</span>
          <span class="s1">&#39;behavior. See https://github.com/google/jax/pull/15677&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_global_jit_state</span><span class="p">(</span>
        <span class="n">softmax_custom_jvp</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">update_thread_local_jit_state</span><span class="p">(</span>
        <span class="n">softmax_custom_jvp</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>


<span class="n">enable_custom_vjp_by_custom_transpose</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_custom_vjp_by_custom_transpose&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables an internal upgrade that implements `jax.custom_vjp` by &#39;</span>
          <span class="s1">&#39;reduction to `jax.custom_jvp` and `jax.custom_transpose`.&#39;</span><span class="p">))</span>

<span class="n">raise_persistent_cache_errors</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_raise_persistent_cache_errors&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If true, exceptions raised when reading or writing to the &#39;</span>
          <span class="s1">&#39;persistent compilation cache will be allowed through, halting &#39;</span>
          <span class="s1">&#39;program execution if not manually caught. If false, exceptions are &#39;</span>
          <span class="s1">&#39;caught and raised as warnings, allowing program execution to &#39;</span>
          <span class="s1">&#39;continue. Defaults to false so cache bugs or intermittent issues &#39;</span>
          <span class="s1">&#39;are non-fatal.&#39;</span><span class="p">))</span>

<span class="n">persistent_cache_min_compile_time_secs</span> <span class="o">=</span> <span class="n">define_float_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_persistent_cache_min_compile_time_secs&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;The minimum compile time of a computation to be written to the &#39;</span>
          <span class="s1">&#39;persistent compilation cache. This threshold can be raised to &#39;</span>
          <span class="s1">&#39;decrease the number of entries written to the cache.&#39;</span><span class="p">))</span>

<span class="n">persistent_cache_min_entry_size_bytes</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_persistent_cache_min_entry_size_bytes&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;The minimum size (in bytes) of an entry that will be cached in the &#39;</span>
          <span class="s1">&#39;persistent compilation cache: &#39;</span>
          <span class="s1">&#39;* -1: disable the size restriction and prevent overrides. &#39;</span>
          <span class="s1">&#39;* Leave at default (0) to allow for overrides. The override will &#39;</span>
          <span class="s1">&#39;  typically ensure that the minimum size is optimal for the &#39;</span>
          <span class="s1">&#39;  filesystem being used for the cache. &#39;</span>
          <span class="s1">&#39;* &gt; 0: the actual minimum size desired; no overrides.&#39;</span><span class="p">))</span>

<span class="n">compilation_cache_include_metadata_in_key</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_compilation_cache_include_metadata_in_key&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Include metadata, such as file names and line numbers, in the&#39;</span>
        <span class="s1">&#39; compilation cache key. If false, the cache will still get hits even&#39;</span>
        <span class="s1">&#39; if functions or files are moved, etc. However, it means that&#39;</span>
        <span class="s1">&#39; executables loaded from the cache may have stale metadata, which&#39;</span>
        <span class="s1">&#39; may show up in, e.g., profiles.&#39;</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">hlo_source_file_canonicalization_regex</span> <span class="o">=</span> <span class="n">define_optional_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_hlo_source_file_canonicalization_regex&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Used to canonicalize the source_path metadata of HLO instructions &#39;</span>
          <span class="s1">&#39;by removing the given regex. If set, re.sub() is called on each &#39;</span>
          <span class="s1">&#39;source_file with the given regex, and all matches are removed. &#39;</span>
          <span class="s1">&#39;This can be used to avoid spurious cache misses when using the &#39;</span>
          <span class="s1">&#39;persistent compilation cache, which includes HLO metadata in the &#39;</span>
          <span class="s1">&#39;cache key.&#39;</span><span class="p">))</span>

<span class="n">include_full_tracebacks_in_locations</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_include_full_tracebacks_in_locations&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Include Python tracebacks in MLIR locations in IR emitted by JAX.&#39;</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">traceback_in_locations_limit</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_traceback_in_locations_limit&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Limit the number of frames at the Python traceback frames included in &#39;</span>
        <span class="s1">&#39;MLIR locations. If set to the negative value, traceback will not be &#39;</span>
        <span class="s1">&#39;limited.&#39;</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">share_autotune_config_between_hosts</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_share_autotune_config_between_hosts&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;If set to True, the coordinator process will share autotune configs &#39;</span>
        <span class="s1">&#39;other participants. This will increase overall compilation time, but &#39;</span>
        <span class="s1">&#39;will lead to equal compiled modules in each process. &#39;</span>
        <span class="s1">&#39;If both jax_share_binary_between_hosts and &#39;</span>
        <span class="s1">&#39;jax_share_autotune_config_between_hosts are set, compiled HLO will be &#39;</span>
        <span class="s2">&quot;shared when it&#39;s possible and autotune config sharing will be used &quot;</span>
        <span class="s1">&#39;as a fallback.&#39;</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">share_binary_between_hosts</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_share_binary_between_hosts&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;If set to True, the compiled module will be shared between hosts &#39;</span>
        <span class="s1">&#39;directly.&#39;</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="n">share_binary_between_hosts_timeout_ms</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_share_binary_between_hosts_timeout_ms&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Timeout for the compiled module share.&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">enable_compilation_cache</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_compilation_cache&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If set to False, the compilation cache will be disabled regardless &#39;</span>
          <span class="s1">&#39;of whether set_cache_dir() was called. If set to True, the &#39;</span>
          <span class="s1">&#39;path could be set to a default value or via a call to &#39;</span>
          <span class="s1">&#39;set_cache_dir().&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">compilation_cache_dir</span> <span class="o">=</span> <span class="n">define_optional_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_compilation_cache_dir&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Path for the cache. &#39;</span>
          <span class="s1">&#39;Precedence: &#39;</span>
          <span class="s1">&#39;1. A call to compilation_cache.set_cache_dir(). &#39;</span>
          <span class="s1">&#39;2. The value of this flag set in the command line or by default.&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">default_dtype_bits</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_dtype_bits&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;64&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Specify bit width of default dtypes, either 32-bit or 64-bit. &#39;</span>
          <span class="s1">&#39;This is a temporary flag that will be used during the process &#39;</span>
          <span class="s1">&#39;of deprecating the ``jax_enable_x64`` flag.&#39;</span><span class="p">))</span>

<span class="n">numpy_dtype_promotion</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_numpy_dtype_promotion&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;strict&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Specify the rules used for implicit type promotion in operations &#39;</span>
          <span class="s1">&#39;between arrays. Options are &quot;standard&quot; or &quot;strict&quot;; in strict-mode, &#39;</span>
          <span class="s1">&#39;binary operations between arrays of differing strongly-specified &#39;</span>
          <span class="s1">&#39;dtypes will result in an error.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">numpy_dtype_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">numpy_dtype_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_update_x64_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_x64</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_x64_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_x64</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">enable_x64</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable 64-bit types to be used&#39;</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_x64_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_x64_thread_local</span><span class="p">)</span>

<span class="c1"># TODO(phawkins): remove after fixing users of FLAGS.x64_enabled.</span>
<span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">)</span>

<span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="s2">&quot;x64_enabled&quot;</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">enable_x64</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_update_default_device_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">default_device</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_update_default_device_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">default_device</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_validate_default_device</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">xla_client</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="c1"># TODO(skyewm): this is a workaround for non-PJRT Device types. Remove when</span>
    <span class="c1"># all JAX backends use a single C++ device interface.</span>
    <span class="k">if</span> <span class="s1">&#39;Device&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;Allowing non-`xla_client.Device` default device: </span><span class="si">%s</span><span class="s1">, type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;jax.default_device must be passed a Device object (e.g. &#39;</span>
                     <span class="sa">f</span><span class="s2">&quot;`jax.devices(&#39;cpu&#39;)[0]`), got: </span><span class="si">{</span><span class="n">val</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># TODO(skye): default_device only accepts devices for now. Make it work with</span>
<span class="c1"># platform names as well (e.g. &quot;cpu&quot; to mean the same as jax.devices(&quot;cpu&quot;)[0]).</span>
<span class="n">default_device</span> <span class="o">=</span> <span class="n">define_string_or_object_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_device&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Configure the default device for JAX operations. Set to a Device &#39;</span>
        <span class="s1">&#39;object (e.g. ``jax.devices(&quot;cpu&quot;)[0]``) to use that Device as the &#39;</span>
        <span class="s1">&#39;default device for JAX operations and jit</span><span class="se">\&#39;</span><span class="s1">d function calls (there is &#39;</span>
        <span class="s1">&#39;no effect on multi-device computations, e.g. pmapped function calls). &#39;</span>
        <span class="s1">&#39;Set to None to use the system default device. See &#39;</span>
        <span class="s1">&#39;:ref:`faq-data-placement` for more information on device placement.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_default_device_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_default_device_thread_local</span><span class="p">,</span>
    <span class="n">validator</span><span class="o">=</span><span class="n">_validate_default_device</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_update_disable_jit_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">disable_jit</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_disable_jit_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">disable_jit</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">disable_jit</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_disable_jit&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Disable JIT compilation and just call original Python.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_disable_jit_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_disable_jit_thread_local</span><span class="p">)</span>


<span class="n">numpy_rank_promotion</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_numpy_rank_promotion&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Control NumPy-style automatic rank promotion broadcasting &#39;</span>
          <span class="s1">&#39;(&quot;allow&quot;, &quot;warn&quot;, or &quot;raise&quot;).&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">numpy_rank_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">numpy_rank_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="n">default_matmul_precision</span> <span class="o">=</span> <span class="n">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_matmul_precision&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorfloat32&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Control the default matmul and conv precision for 32bit inputs.</span><span class="se">\n\n</span><span class="s1">&#39;</span>

          <span class="s1">&#39;Some platforms, like TPU, offer configurable precision levels for &#39;</span>
          <span class="s1">&#39;matrix multiplication and convolution computations, trading off &#39;</span>
          <span class="s1">&#39;accuracy for speed. The precision can be controlled for each &#39;</span>
          <span class="s1">&#39;operation; for example, see the :func:`jax.lax.conv_general_dilated` &#39;</span>
          <span class="s1">&#39;and :func:`jax.lax.dot` docstrings. But it can be useful to control &#39;</span>
          <span class="s1">&#39;the default behavior obtained when an operation is not given a &#39;</span>
          <span class="s1">&#39;specific precision.</span><span class="se">\n\n</span><span class="s1">&#39;</span>

          <span class="s1">&#39;This option can be used to control the default precision &#39;</span>
          <span class="s1">&#39;level for computations involved in matrix multiplication and &#39;</span>
          <span class="s1">&#39;convolution on 32bit inputs. The levels roughly describe the &#39;</span>
          <span class="s2">&quot;precision at which scalar products are computed. The &#39;bfloat16&#39; &quot;</span>
          <span class="s2">&quot;option is the fastest and least precise; &#39;float32&#39; is similar to &quot;</span>
          <span class="s2">&quot;full float32 precision; &#39;tensorfloat32&#39; is intermediate.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">default_matmul_precision</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">default_matmul_precision</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="n">traceback_filtering</span> <span class="o">=</span> <span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;jax_traceback_filtering&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;tracebackhide&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_frames&quot;</span><span class="p">,</span> <span class="s2">&quot;quiet_remove_frames&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Controls how JAX filters internal frames out of tracebacks.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot;Valid values are:</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">off</span><span class="se">\&quot;</span><span class="s2">: disables traceback filtering.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">auto</span><span class="se">\&quot;</span><span class="s2">: use </span><span class="se">\&quot;</span><span class="s2">tracebackhide</span><span class="se">\&quot;</span><span class="s2"> if running under a sufficiently&quot;</span>
         <span class="s2">&quot; new IPython, or </span><span class="se">\&quot;</span><span class="s2">remove_frames</span><span class="se">\&quot;</span><span class="s2"> otherwise.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">tracebackhide</span><span class="se">\&quot;</span><span class="s2">: adds </span><span class="se">\&quot;</span><span class="s2">__tracebackhide__</span><span class="se">\&quot;</span><span class="s2"> annotations to&quot;</span>
         <span class="s2">&quot; hidden stack frames, which some traceback printers support.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">remove_frames</span><span class="se">\&quot;</span><span class="s2">: removes hidden frames from tracebacks, and adds&quot;</span>
         <span class="s2">&quot; the unfiltered traceback as a __cause__ of the exception.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">quiet_remove_frames</span><span class="se">\&quot;</span><span class="s2">: removes hidden frames from tracebacks, and adds&quot;</span>
         <span class="s2">&quot; a brief message (to the __cause__ of the exception) describing that this has&quot;</span>
         <span class="s2">&quot; happened.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># This flag is for internal use.</span>
<span class="c1"># TODO(tianjianlu): Removes once we always enable cusparse lowering.</span>
<span class="c1"># TODO(b/262050896): Set to true after bug is fixed</span>
<span class="n">bcoo_cusparse_lowering</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_bcoo_cusparse_lowering&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables lowering BCOO ops to cuSparse.&#39;</span><span class="p">))</span>

<span class="c1"># TODO(mattjj): remove this flag when we ensure we only succeed at trace-staging</span>
<span class="c1"># if the intended backend can handle lowering the result</span>
<span class="n">dynamic_shapes</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_dynamic_shapes&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;JAX_DYNAMIC_SHAPES&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables experimental features for staging out computations with &#39;</span>
          <span class="s1">&#39;dynamic shapes.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">dynamic_shapes</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">dynamic_shapes</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="c1"># This flag is temporary during rollout of the remat barrier.</span>
<span class="c1"># TODO(parkers): Remove if there are no complaints.</span>
<span class="n">remat_opt_barrier</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_remat_opt_barrier&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables using optimization-barrier op for lowering remat.&#39;</span><span class="p">))</span>

<span class="c1"># TODO(sharadmv,mattjj): set default to True, then remove</span>
<span class="n">eager_pmap</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_eager_pmap&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable eager-mode pmap when jax_disable_jit is activated.&#39;</span><span class="p">)</span>

<span class="c1"># TODO(mattjj): remove once we land mutable array plumbing, or face great shame</span>
<span class="n">custom_vjp_disable_shape_check</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_custom_vjp_disable_shape_check&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable the check from #19009 to enable some custom_vjp hacks.&#39;</span><span class="p">)</span>

<span class="n">xla_runtime_errors</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_experimental_unsafe_xla_runtime_errors&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enable XLA runtime errors for jax.experimental.checkify.checks &#39;</span>
          <span class="s1">&#39;on CPU and GPU. These errors are async, might get lost and are not &#39;</span>
          <span class="s1">&#39;very readable. But, they crash the computation and enable you &#39;</span>
          <span class="s1">&#39;to write jittable checks without needing to checkify. Does not &#39;</span>
          <span class="s1">&#39;work under pmap/pjit.&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">jax_xla_profile_version</span> <span class="o">=</span> <span class="n">define_int_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_xla_profile_version&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Optional profile version for XLA compilation. This is meaningful &#39;</span>
        <span class="s1">&#39;only when XLA is configured to support the remote compilation &#39;</span>
        <span class="s1">&#39;profile feature.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_global_jit_state</span><span class="p">(</span>
        <span class="n">xla_profile_version</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">update_thread_local_jit_state</span><span class="p">(</span>
        <span class="n">xla_profile_version</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
<span class="p">)</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">explicit_device_put_scope</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Indicates that the current context is an explicit device_put*() call.&quot;&quot;&quot;</span>
  <span class="n">state</span> <span class="o">=</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span>
  <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">yield</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span> <span class="o">=</span> <span class="n">prev</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">explicit_device_get_scope</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Indicates that the current context is an explicit device_get() call.&quot;&quot;&quot;</span>
  <span class="n">state</span> <span class="o">=</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span>
  <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">yield</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span> <span class="o">=</span> <span class="n">prev</span>

<span class="k">def</span> <span class="nf">_update_transfer_guard</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Applies the transfer guard level within transfer_guard_lib.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;allow&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">LOG</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;disallow&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">DISALLOW</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">LOG_EXPLICIT</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;disallow_explicit&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">DISALLOW_EXPLICIT</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Invalid transfer guard level </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">transfer_guard_host_to_device</span> <span class="o">=</span> <span class="n">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_host_to_device&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for host-to-device transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;host_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;host_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="n">transfer_guard_device_to_device</span> <span class="o">=</span> <span class="n">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_device_to_device&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for device-to-device transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="n">transfer_guard_device_to_host</span> <span class="o">=</span> <span class="n">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_device_to_host&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for device-to-host transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_host&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_host&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_update_all_transfer_guard_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jax_transfer_guard_host_to_device&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jax_transfer_guard_device_to_device&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jax_transfer_guard_device_to_host&#39;</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">_transfer_guard</span> <span class="o">=</span> <span class="n">define_optional_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard_*.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for all transfers. This option is &#39;</span>
          <span class="s1">&#39;set-only; the transfer guard level for a specific direction should &#39;</span>
          <span class="s1">&#39;be read using the per-transfer direction option. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_all_transfer_guard_global</span><span class="p">)</span>

<div class="viewcode-block" id="transfer_guard">
<a class="viewcode-back" href="../../../_autosummary/jax.transfer_guard.html#jax.transfer_guard">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">transfer_guard</span><span class="p">(</span><span class="n">new_val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A contextmanager to control the transfer guard level for all transfers.</span>

<span class="sd">  For more information, see</span>
<span class="sd">  https://jax.readthedocs.io/en/latest/transfer_guard.html</span>

<span class="sd">  Args:</span>
<span class="sd">    new_val: The new thread-local transfer guard level for all transfers.</span>

<span class="sd">  Yields:</span>
<span class="sd">    None.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_host_to_device</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_device_to_device</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_device_to_host</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">_transfer_guard</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="k">yield</span></div>



<span class="k">def</span> <span class="nf">_update_debug_log_modules</span><span class="p">(</span><span class="n">module_names_str</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
  <span class="n">logging_config</span><span class="o">.</span><span class="n">disable_all_debug_logging</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">module_names_str</span><span class="p">:</span>
    <span class="k">return</span>
  <span class="n">module_names</span> <span class="o">=</span> <span class="n">module_names_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
    <span class="n">logging_config</span><span class="o">.</span><span class="n">enable_debug_logging</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

<span class="c1"># Don&#39;t define a context manager since this isn&#39;t threadsafe.</span>
<span class="n">define_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_log_modules&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Comma-separated list of module names (e.g. &quot;jax&quot; or &#39;</span>
          <span class="s1">&#39;&quot;jax._src.xla_bridge,jax._src.dispatch&quot;) to enable debug logging &#39;</span>
          <span class="s1">&#39;for.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_debug_log_modules</span><span class="p">)</span>

<span class="n">pmap_no_rank_reduction</span> <span class="o">=</span> <span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_pmap_no_rank_reduction&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;If True, pmap shards have a the same rank as their enclosing array.&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>