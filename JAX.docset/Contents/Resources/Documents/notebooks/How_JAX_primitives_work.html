
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How JAX primitives work &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=02ed413a" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/How_JAX_primitives_work';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing custom Jaxpr interpreters in JAX" href="Writing_custom_interpreters_in_Jax.html" />
    <link rel="prev" title="Control autodiff‚Äôs saved values with jax.checkpoint (aka jax.remat)" href="autodiff_remat.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="Common_Gotchas_in_JAX.html">üî™ JAX - The Sharp Bits üî™</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../advanced_guide.html">Advanced Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>



<li class="toctree-l2"><a class="reference internal" href="xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="autodiff_remat.html">Control autodiff‚Äôs saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>

<li class="toctree-l2"><a class="reference internal" href="convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor_guide.html">Developer Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">JAX Glossary of Terms</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/google/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/How_JAX_primitives_work.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>How JAX primitives work</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-existing-primitives">Using existing primitives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-new-jax-primitives">Defining new JAX primitives</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#primal-evaluation-rules">Primal evaluation rules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jit">JIT</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract-evaluation-rules">Abstract evaluation rules</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#xla-compilation-rules">XLA Compilation rules</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-differentiation">Forward differentiation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-forward-differentiation">JIT of forward differentiation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-differentiation">Reverse differentiation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#transposition">Transposition</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-reverse-differentiation">JIT of reverse differentiation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batching">Batching</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-batching">JIT of batching</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="how-jax-primitives-work">
<h1>How JAX primitives work<a class="headerlink" href="#how-jax-primitives-work" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/google/jax/blob/main/docs/notebooks/How_JAX_primitives_work.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a> <a class="reference external" href="https://kaggle.com/kernels/welcome?src=https://github.com/google/jax/blob/main/docs/notebooks/How_JAX_primitives_work.ipynb"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg" /></a></p>
<p><em>necula&#64;google.com</em>, October 2019.</p>
<p>JAX implements certain transformations of Python functions, e.g., <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">grad</span></code>,
<code class="docutils literal notranslate"><span class="pre">vmap</span></code>, or <code class="docutils literal notranslate"><span class="pre">pmap</span></code>. The Python functions to be transformed must be JAX-traceable,
which means that as the Python function executes
the only operations it applies to the data are either inspections of data
attributes such as shape or type, or special operations called JAX primitives.
In particular, a JAX-traceable function is sometimes invoked by JAX with
abstract arguments. An example of a JAX abstract value is <code class="docutils literal notranslate"><span class="pre">ShapedArray(float32[2,2])</span></code>,
which captures the type and the shape of values, but not the concrete data values.
JAX primitives know how to operate on both concrete data
values and on the JAX abstract values.</p>
<p>The JAX-transformed functions must themselves be JAX-traceable functions,
to ensure that these transformations
can be composed, e.g., <code class="docutils literal notranslate"><span class="pre">jit(jacfwd(grad(f)))</span></code>.</p>
<p>There are pre-defined JAX primitives corresponding to most XLA operations,
e.g., add, matmul, sin, cos, indexing.
JAX comes with an implementation of numpy functions in terms of JAX primitives, which means that Python programs
using JAX‚Äôs implementation of numpy are JAX-traceable and therefore transformable.
Other libraries can be made JAX-traceable by implementing them in terms of JAX primitives.</p>
<p>The set of JAX primitives is extensible. Instead of reimplementing a function in terms of pre-defined JAX primitives,
one can define a new primitive that encapsulates the behavior of the function.</p>
<p><strong>The goal of this document is to explain the interface that a JAX primitive must support in order to allow JAX to perform all its transformations.</strong></p>
<p>Consider that we want to add to JAX support for a multiply-add function with three arguments, defined mathematically
as ‚Äúmultiply_add(x, y, z) = x * y + z‚Äù.
This function operates on 3 identically-shaped tensors of floating point
values and performs the operations pointwise.</p>
<section id="using-existing-primitives">
<h2>Using existing primitives<a class="headerlink" href="#using-existing-primitives" title="Link to this heading">#</a></h2>
<p>The easiest way to define new functions is to write them in terms of JAX primitives, or in terms of other
functions that are themselves written using JAX primitives, e.g., those
defined in the <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">api</span>

<span class="k">def</span> <span class="nf">multiply_add_lax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Implementation of multiply-add using the jax.lax primitives.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">square_add_lax</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A square-add function using the newly defined multiply-add.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">multiply_add_lax</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square_add_lax = &quot;</span><span class="p">,</span> <span class="n">square_add_lax</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">))</span>
<span class="c1"># Differentiate w.r.t. the first argument</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grad(square_add_lax) = &quot;</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">square_add_lax</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">10.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>square_add_lax =  14.0
grad(square_add_lax) =  4.0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div>
</div>
</div>
</div>
<p>In order to understand how JAX is internally using the primitives,
we add some helpers for tracing function calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper functions (execute this cell)</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="n">_indentation</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">_trace</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a message at current indentation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">_indentation</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_trace_indent</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a message and then indent the rest.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_indentation</span>
    <span class="n">_trace</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">_indentation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">_indentation</span>

<span class="k">def</span> <span class="nf">_trace_unindent</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unindent then print a message.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_indentation</span>
    <span class="n">_indentation</span> <span class="o">=</span> <span class="n">_indentation</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">_trace</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A decorator for functions to trace arguments and results.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">trace_func</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>  <span class="c1"># pylint: disable=missing-docstring</span>
    <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print certain values more succinctly&quot;&quot;&quot;</span>
        <span class="n">vtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;jax._src.xla_bridge._JaxComputationBuilder&quot;</span> <span class="ow">in</span> <span class="n">vtype</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;JaxComputationBuilder&gt;&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;jaxlib.xla_extension.XlaOp&quot;</span> <span class="ow">in</span> <span class="n">vtype</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;XlaOp at 0x</span><span class="si">{:x}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;partial_eval.JaxprTracer&quot;</span> <span class="ow">in</span> <span class="n">vtype</span> <span class="ow">or</span>
              <span class="s2">&quot;batching.BatchTracer&quot;</span> <span class="ow">in</span> <span class="n">vtype</span> <span class="ow">or</span>
              <span class="s2">&quot;ad.JVPTracer&quot;</span> <span class="ow">in</span> <span class="n">vtype</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;Traced&lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">aval</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp_values</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pp_values</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pp</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
      <span class="n">_trace_indent</span><span class="p">(</span><span class="s2">&quot;call </span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pp_values</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
      <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">_trace_unindent</span><span class="p">(</span><span class="s2">&quot;|&lt;- </span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pp</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
      <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">func_wrapper</span>

  <span class="k">return</span> <span class="n">trace_func</span>

<span class="k">class</span> <span class="nc">expectNotImplementedError</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Context manager to check for NotImplementedError.&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_indentation</span>
    <span class="n">_indentation</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found expected exception:&quot;</span><span class="p">)</span>
      <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># No exception</span>
      <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Expected NotImplementedError&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of using <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> primitives directly, we can use other functions
that are already written in terms of those primitives, such as those in <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_numpy&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_numpy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>

<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;square_add_numpy&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">square_add_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">multiply_add_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normal evaluation:&quot;</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square_add_numpy = &quot;</span><span class="p">,</span> <span class="n">square_add_numpy</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Gradient evaluation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grad(square_add_numpy) = &quot;</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">square_add_numpy</span><span class="p">)(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">10.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normal evaluation:
call square_add_numpy(2.0, 10.0)
  call multiply_add_numpy(2.0, 2.0, 10.0)
  |&lt;- multiply_add_numpy = 14.0
|&lt;- square_add_numpy = 14.0
square_add_numpy =  14.0

Gradient evaluation:
call square_add_numpy(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
  call multiply_add_numpy(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
  |&lt;- multiply_add_numpy = Traced&lt;ConcreteArray(14.0, dtype=float32, weak_type=True)&gt;
|&lt;- square_add_numpy = Traced&lt;ConcreteArray(14.0, dtype=float32, weak_type=True)&gt;
grad(square_add_numpy) =  4.0
</pre></div>
</div>
</div>
</div>
<p>Notice that in the process of computing <code class="docutils literal notranslate"><span class="pre">grad</span></code>, JAX invokes <code class="docutils literal notranslate"><span class="pre">square_add_numpy</span></code> and
<code class="docutils literal notranslate"><span class="pre">multiply_add_numpy</span></code> with special arguments <code class="docutils literal notranslate"><span class="pre">ConcreteArray(...)</span></code> (described further
below in this colab).
It is important to remember that a JAX-traceable function must be able to
operate not only on concrete arguments but also on special abstract arguments
that JAX may use to abstract the function execution.</p>
<p>The JAX traceability property is satisfied as long as the function is written
in terms of JAX primitives.</p>
</section>
<section id="defining-new-jax-primitives">
<h2>Defining new JAX primitives<a class="headerlink" href="#defining-new-jax-primitives" title="Link to this heading">#</a></h2>
<p>The right way to add support for multiply-add is in terms of existing
JAX primitives, as shown above. However, in order to demonstrate how JAX
primitives work let us pretend that we want to add a new primitive to
JAX for the multiply-add functionality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">core</span>
<span class="n">multiply_add_p</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Primitive</span><span class="p">(</span><span class="s2">&quot;multiply_add&quot;</span><span class="p">)</span>  <span class="c1"># Create the primitive</span>

<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_prim&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;The JAX-traceable way to use the JAX primitive.</span>
<span class="sd">  </span>
<span class="sd">  Note that the traced arguments must be passed as positional arguments</span>
<span class="sd">  to `bind`. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">multiply_add_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;square_add_prim&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">square_add_prim</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;A square-add function implemented using the new JAX-primitive.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we try to call the newly defined functions we get an error, because
we have not yet told JAX anything about the semantics of the new primitive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">square_add_prim</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(2.0, 10.0)
  call multiply_add_prim(2.0, 2.0, 10.0)

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/2844449444.py&quot;, line 2, in &lt;module&gt;
    square_add_prim(2., 10.)
  File &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 48, in func_wrapper
    res = func(*args)
          ^^^^^^^^^^^
  File &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 16, in square_add_prim
    return multiply_add_prim(a, a, b)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
NotImplementedError: Evaluation rule for &#39;multiply_add&#39; not implemented
</pre></div>
</div>
</div>
</div>
<section id="primal-evaluation-rules">
<h3>Primal evaluation rules<a class="headerlink" href="#primal-evaluation-rules" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_impl&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_impl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Concrete implementation of the primitive.</span>

<span class="sd">  This function does not need to be JAX traceable.</span>
<span class="sd">  Args:</span>
<span class="sd">    x, y, z: the concrete arguments of the primitive. Will only be called with </span>
<span class="sd">      concrete values.</span>
<span class="sd">  Returns:</span>
<span class="sd">    the concrete result of the primitive.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Note that we can use the original numpy, which is not JAX traceable</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">z</span><span class="p">)</span>

<span class="c1"># Now we register the primal implementation with JAX</span>
<span class="n">multiply_add_p</span><span class="o">.</span><span class="n">def_impl</span><span class="p">(</span><span class="n">multiply_add_impl</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&lt;function</span> multiply_add_impl at <span class=" -Color -Color-Bold -Color-Bold-Cyan">0x7cf4288b6f20</span><span class=" -Color -Color-Bold">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">square_add_prim</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">==</span> <span class="mf">14.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(2.0, 10.0)
  call multiply_add_prim(2.0, 2.0, 10.0)
    call multiply_add_impl(2.0, 2.0, 10.0)
    |&lt;- multiply_add_impl = 14.0
  |&lt;- multiply_add_prim = 14.0
|&lt;- square_add_prim = 14.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="jit">
<h3>JIT<a class="headerlink" href="#jit" title="Link to this heading">#</a></h3>
<p>If we now try to use <code class="docutils literal notranslate"><span class="pre">jit</span></code> we get a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/1813425700.py&quot;, line 2, in &lt;module&gt;
    api.jit(square_add_prim)(2., 10.)
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&quot;, line 179, in reraise_with_filtered_traceback
    return fun(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&quot;, line 298, in cache_miss
    outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(
                                                                ^^^^^^^^^^^^^^^^^^^^
NotImplementedError: Abstract evaluation for &#39;multiply_add&#39; not implemented
</pre></div>
</div>
</div>
</div>
<section id="abstract-evaluation-rules">
<h4>Abstract evaluation rules<a class="headerlink" href="#abstract-evaluation-rules" title="Link to this heading">#</a></h4>
<p>In order to JIT the function, and for other transformations as well,
JAX first evaluates it abstractly using only the
shape and type of the arguments. This abstract evaluation serves multiple
purposes:</p>
<ul class="simple">
<li><p>Gets the sequence of JAX primitives that are used in the computation. This
sequence will be compiled.</p></li>
<li><p>Computes the shape and type of all vectors and operations used in the computation.</p></li>
</ul>
<p>For example, the abstraction of a vector with 3 elements may be <code class="docutils literal notranslate"><span class="pre">ShapedArray(float32[3])</span></code>, or <code class="docutils literal notranslate"><span class="pre">ConcreteArray([1.,</span> <span class="pre">2.,</span> <span class="pre">3.])</span></code>.
In the latter case, JAX uses the actual concrete value wrapped as an abstract value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">core</span>
<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_abstract_eval&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_abstract_eval</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Abstract evaluation of the primitive.</span>

<span class="sd">  This function does not need to be JAX traceable. It will be invoked with</span>
<span class="sd">  abstractions of the actual arguments. </span>
<span class="sd">  Args:</span>
<span class="sd">    xs, ys, zs: abstractions of the arguments.</span>
<span class="sd">  Result:</span>
<span class="sd">    a ShapedArray for the result of the primitive.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="n">xs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">ys</span><span class="o">.</span><span class="n">shape</span>
  <span class="k">assert</span> <span class="n">xs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">zs</span><span class="o">.</span><span class="n">shape</span>
  <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">ShapedArray</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">xs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># Now we register the abstract evaluation with JAX</span>
<span class="n">multiply_add_p</span><span class="o">.</span><span class="n">def_abstract_eval</span><span class="p">(</span><span class="n">multiply_add_abstract_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&lt;function</span> multiply_add_abstract_eval at <span class=" -Color -Color-Bold -Color-Bold-Cyan">0x7cf428109e40</span><span class=" -Color -Color-Bold">&gt;</span>
</pre></div>
</div>
</div>
</div>
<p>If we re-attempt to JIT, we see how the abstract evaluation proceeds, but
we get another error, about missing the actual XLA compilation rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
    call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
    |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
jax._src.source_info_util.JaxStackTraceBeforeTransformation: NotImplementedError: MLIR translation rule for primitive &#39;multiply_add&#39; not found for platform cpu

The preceding stack trace is the source of the JAX operation that, once transformed by JAX, triggered the following exception.

--------------------

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/1813425700.py&quot;, line 2, in &lt;module&gt;
    api.jit(square_add_prim)(2., 10.)
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&quot;, line 179, in reraise_with_filtered_traceback
    return fun(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&quot;, line 298, in cache_miss
    outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(
                                                                ^^^^^^^^^^^^^^^^^^^^
NotImplementedError: MLIR translation rule for primitive &#39;multiply_add&#39; not found for platform cpu
</pre></div>
</div>
</div>
</div>
</section>
<section id="xla-compilation-rules">
<h4>XLA Compilation rules<a class="headerlink" href="#xla-compilation-rules" title="Link to this heading">#</a></h4>
<p>JAX compilation works by compiling each primitive into a graph of XLA operations.</p>
<p>This is the biggest hurdle to adding new functionality to JAX, because the
set of XLA operations is limited, and JAX already has pre-defined primitives
for most of them. However, XLA includes a <code class="docutils literal notranslate"><span class="pre">CustomCall</span></code> operation that can be used to encapsulate arbitrary functionality defined using C++.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax._src.lib.mlir.dialects</span> <span class="kn">import</span> <span class="n">hlo</span>
<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_lowering&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_lowering</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">zc</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;The compilation to XLA of the primitive.</span>

<span class="sd">  Given an mlir.ir.Value for each argument, return the mlir.ir.Values for</span>
<span class="sd">  the results of the function.</span>

<span class="sd">  Does not need to be a JAX-traceable function.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">hlo</span><span class="o">.</span><span class="n">AddOp</span><span class="p">(</span><span class="n">hlo</span><span class="o">.</span><span class="n">MulOp</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">),</span> <span class="n">zc</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">]</span>

<span class="c1"># Now we register the lowering rule with JAX</span>
<span class="c1"># For GPU see the [Custom operations for GPUs](https://jax.readthedocs.io/en/latest/Custom_Operation_for_GPUs.html)</span>
<span class="c1"># TODO: TPU?</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">mlir</span>
<span class="n">mlir</span><span class="o">.</span><span class="n">register_lowering</span><span class="p">(</span><span class="n">multiply_add_p</span><span class="p">,</span> <span class="n">multiply_add_lowering</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&lt;function</span> multiply_add_lowering at <span class=" -Color -Color-Bold -Color-Bold-Cyan">0x7cf42810a700</span><span class=" -Color -Color-Bold">&gt;</span>
</pre></div>
</div>
</div>
</div>
<p>Now we succeed to JIT. Notice below that JAX first evaluates the function
abstractly, which triggers the <code class="docutils literal notranslate"><span class="pre">multiply_add_abstract_eval</span></code> function, and
then compiles the set of primitives it has encountered, including <code class="docutils literal notranslate"><span class="pre">multiply_add</span></code>.
At this point JAX invokes <code class="docutils literal notranslate"><span class="pre">multiply_add_xla_translation</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">square_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">==</span> <span class="mf">14.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
    call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
    |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf48851e750&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf4288a7bf0&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf488539770&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf4885397b0&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf488539ad0&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c390250&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/1570919344.py&quot;:1:28) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/1570919344.py&quot;:1:7) at callsite(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20) at callsite(&quot;InteractiveShell.run_ast_nodes&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3517:19) at callsite(&quot;InteractiveShell.run_cell_async&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3334:29) at &quot;_pseudo_sync_runner&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;:129:8)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;lambda&gt; at 0x7cf4288d24f0, file &quot;/tmp/ipykernel_27185/1570919344.py&quot;, line 1&gt;, 30): loc(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/1570919344.py&quot;:1:28)), (&lt;code object &lt;module&gt; at 0x7cf4289c4be0, file &quot;/tmp/ipykernel_27185/1570919344.py&quot;, line 1&gt;, 54): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/1570919344.py&quot;:1:7)), (&lt;code object run_code at 0x5c205abc6990, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3541&gt;, 202): loc(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)), (&lt;code object run_ast_nodes at 0x5c205abc5dc0, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3418&gt;, 1258): loc(&quot;InteractiveShell.run_ast_nodes&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3517:19)), (&lt;code object run_cell_async at 0x5c205abc4130, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3183&gt;, 1858): loc(&quot;InteractiveShell.run_cell_async&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3334:29)), (&lt;code object _pseudo_sync_runner at 0x7cf4acb9c630, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 120&gt;, 30): loc(&quot;_pseudo_sync_runner&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;:129:8))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/1570919344.py&#39;: &#39;/tmp/ipykernel_27185/1570919344.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/1570919344.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;: True}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(&lt;lambda&gt;)&#39;), Scope(name=&#39;jit(main)&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf48853bb90&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 1))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4288b9970&gt;]
</pre></div>
</div>
</div>
</div>
<p>Below is another use of <code class="docutils literal notranslate"><span class="pre">jit</span></code> where we compile only
with respect to the first argument. Notice how the second argument to <code class="docutils literal notranslate"><span class="pre">square_add_prim</span></code> is concrete, which leads
in the third argument to <code class="docutils literal notranslate"><span class="pre">multiply_add_abstract_eval</span></code> being
<code class="docutils literal notranslate"><span class="pre">ConcreteArray</span></code>. We see that <code class="docutils literal notranslate"><span class="pre">multiply_add_abstract_eval</span></code> may be used with
both <code class="docutils literal notranslate"><span class="pre">ShapedArray</span></code> and <code class="docutils literal notranslate"><span class="pre">ConcreteArray</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">square_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> 
               <span class="n">static_argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">==</span> <span class="mf">14.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, 10.0)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, 10.0)
    call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
    |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf48851e150&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf488537db0&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf488537d30&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf488537d70&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4885362d0&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c47c210&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/4165789807.py&quot;:1:28) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/4165789807.py&quot;:1:7) at callsite(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20) at callsite(&quot;InteractiveShell.run_ast_nodes&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3517:19) at callsite(&quot;InteractiveShell.run_cell_async&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3334:29) at &quot;_pseudo_sync_runner&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;:129:8)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;lambda&gt; at 0x7cf4288d26b0, file &quot;/tmp/ipykernel_27185/4165789807.py&quot;, line 1&gt;, 30): loc(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/4165789807.py&quot;:1:28)), (&lt;code object &lt;module&gt; at 0x7cf492eca890, file &quot;/tmp/ipykernel_27185/4165789807.py&quot;, line 1&gt;, 58): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/4165789807.py&quot;:1:7)), (&lt;code object run_code at 0x5c205abc6990, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3541&gt;, 202): loc(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)), (&lt;code object run_ast_nodes at 0x5c205abc5dc0, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3418&gt;, 1258): loc(&quot;InteractiveShell.run_ast_nodes&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3517:19)), (&lt;code object run_cell_async at 0x5c205abc4130, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3183&gt;, 1858): loc(&quot;InteractiveShell.run_cell_async&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3334:29)), (&lt;code object _pseudo_sync_runner at 0x7cf4acb9c630, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;, line 120&gt;, 30): loc(&quot;_pseudo_sync_runner&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&quot;:129:8))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/4165789807.py&#39;: &#39;/tmp/ipykernel_27185/4165789807.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/4165789807.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/async_helpers.py&#39;: True}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(&lt;lambda&gt;)&#39;), Scope(name=&#39;jit(main)&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf488536e10&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(%0 = &quot;stablehlo.constant&quot;() {value = dense&lt;1.000000e+01&gt; : tensor&lt;f32&gt;} : () -&gt; tensor&lt;f32&gt;))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4288efd30&gt;]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="forward-differentiation">
<h3>Forward differentiation<a class="headerlink" href="#forward-differentiation" title="Link to this heading">#</a></h3>
<p>JAX implements forward differentiation in the form of
a Jacobian-vector product (see the <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/autodiff_cookbook.html#Jacobian-Matrix-and-Matrix-Jacobian-products">JAX autodiff cookbook</a>).</p>
<p>If we attempt now to compute the <code class="docutils literal notranslate"><span class="pre">jvp</span></code> function we get an
error because we have not yet told JAX how to differentiate
the <code class="docutils literal notranslate"><span class="pre">multiply_add</span></code> primitive.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The second argument `(2., 10.)` are the argument values</span>
<span class="c1"># where we evaluate the Jacobian, and the third `(1., 1.)`</span>
<span class="c1"># are the values of the tangents for the arguments.</span>
<span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">api</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(10.0, dtype=float32, weak_type=True)&gt;)
  call multiply_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(10.0, dtype=float32, weak_type=True)&gt;)

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/800067577.py&quot;, line 5, in &lt;module&gt;
    api.jvp(square_add_prim, (2., 10.), (1., 1.))
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&quot;, line 1933, in jvp
    return _jvp(lu.wrap_init(fun), primals, tangents, has_aux=has_aux)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&quot;, line 1962, in _jvp
    out_primals, out_tangents = ad.jvp(flat_fun).call_wrapped(ps_flat, ts_flat)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
NotImplementedError: Differentiation rule for &#39;multiply_add&#39; not implemented
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">ad</span>


<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_value_and_jvp&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_value_and_jvp</span><span class="p">(</span><span class="n">arg_values</span><span class="p">,</span> <span class="n">arg_tangents</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Evaluates the primal output and the tangents (Jacobian-vector product).</span>

<span class="sd">  Given values of the arguments and perturbation of the arguments (tangents), </span>
<span class="sd">  compute the output of the primitive and the perturbation of the output.</span>

<span class="sd">  This method must be JAX-traceable. JAX may invoke it with abstract values </span>
<span class="sd">  for the arguments and tangents.</span>

<span class="sd">  Args:</span>
<span class="sd">    arg_values: a tuple of arguments</span>
<span class="sd">    arg_tangents: a tuple with the tangents of the arguments. The tuple has </span>
<span class="sd">      the same length as the arg_values. Some of the tangents may also be the </span>
<span class="sd">      special value ad.Zero to specify a zero tangent.</span>
<span class="sd">  Returns:</span>
<span class="sd">     a pair of the primal output and the tangent.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">arg_values</span>
  <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">zt</span> <span class="o">=</span> <span class="n">arg_tangents</span>
  <span class="n">_trace</span><span class="p">(</span><span class="s2">&quot;Primal evaluation:&quot;</span><span class="p">)</span>
  <span class="c1"># Now we have a JAX-traceable computation of the output. </span>
  <span class="c1"># Normally, we can use the ma primitive itself to compute the primal output. </span>
  <span class="n">primal_out</span> <span class="o">=</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
  
  <span class="n">_trace</span><span class="p">(</span><span class="s2">&quot;Tangent evaluation:&quot;</span><span class="p">)</span>
  <span class="c1"># We must use a JAX-traceable way to compute the tangent. It turns out that </span>
  <span class="c1"># the output tangent can be computed as (xt * y + x * yt + zt),</span>
  <span class="c1"># which we can implement in a JAX-traceable way using the same &quot;multiply_add_prim&quot; primitive.</span>
  
  <span class="c1"># We do need to deal specially with Zero. Here we just turn it into a </span>
  <span class="c1"># proper tensor of 0s (of the same shape as &#39;x&#39;). </span>
  <span class="c1"># An alternative would be to check for Zero and perform algebraic </span>
  <span class="c1"># simplification of the output tangent computation.</span>
  <span class="k">def</span> <span class="nf">make_zero</span><span class="p">(</span><span class="n">tan</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">zeros_like_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tan</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ad</span><span class="o">.</span><span class="n">Zero</span> <span class="k">else</span> <span class="n">tan</span>  
  
  <span class="n">output_tangent</span> <span class="o">=</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">make_zero</span><span class="p">(</span><span class="n">xt</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">make_zero</span><span class="p">(</span><span class="n">yt</span><span class="p">),</span> <span class="n">make_zero</span><span class="p">(</span><span class="n">zt</span><span class="p">)))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">primal_out</span><span class="p">,</span> <span class="n">output_tangent</span><span class="p">)</span>

<span class="c1"># Register the forward differentiation rule with JAX </span>
<span class="n">ad</span><span class="o">.</span><span class="n">primitive_jvps</span><span class="p">[</span><span class="n">multiply_add_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiply_add_value_and_jvp</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tangent is: xt*y + x*yt + zt = 1.*2. + 2.*1. + 1. = 5.</span>
<span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mf">14.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(10.0, dtype=float32, weak_type=True)&gt;)
  call multiply_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(10.0, dtype=float32, weak_type=True)&gt;)
    call multiply_add_value_and_jvp((2.0, 2.0, 10.0), (1.0, 1.0, 1.0))
      Primal evaluation:
      call multiply_add_prim(2.0, 2.0, 10.0)
        call multiply_add_impl(2.0, 2.0, 10.0)
        |&lt;- multiply_add_impl = 14.0
      |&lt;- multiply_add_prim = 14.0
      Tangent evaluation:
      call multiply_add_prim(2.0, 1.0, 1.0)
        call multiply_add_impl(2.0, 1.0, 1.0)
        |&lt;- multiply_add_impl = 3.0
      |&lt;- multiply_add_prim = 3.0
      call multiply_add_prim(1.0, 2.0, 3.0)
        call multiply_add_impl(1.0, 2.0, 3.0)
        |&lt;- multiply_add_impl = 5.0
      |&lt;- multiply_add_prim = 5.0
    |&lt;- multiply_add_value_and_jvp = (14.0, 5.0)
  |&lt;- multiply_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;
|&lt;- square_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<p>TO EXPLAIN:</p>
<ul class="simple">
<li><p>Why is JAX using ConcreteArray in square_add_prim? There is no abstract evaluation going on here.</p></li>
<li><p>Not sure how to explain that multiply_add_prim is invoked with ConcreteValue, yet
we do not call the multiply_add_abstract_eval.</p></li>
<li><p>I think it would be useful to show the jaxpr here</p></li>
</ul>
<section id="jit-of-forward-differentiation">
<h4>JIT of forward differentiation<a class="headerlink" href="#jit-of-forward-differentiation" title="Link to this heading">#</a></h4>
<p>We can apply JIT to the forward differentiation function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arg_values</span><span class="p">,</span> <span class="n">arg_tangents</span><span class="p">:</span> 
                   <span class="n">api</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="n">arg_values</span><span class="p">,</span> <span class="n">arg_tangents</span><span class="p">))(</span>
         <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mf">14.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;)
    call multiply_add_value_and_jvp((Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;), (Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;))
      Primal evaluation:
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
      Tangent evaluation:
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[]))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
    |&lt;- multiply_add_value_and_jvp = (Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf418716810&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf4186e8070&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf4186e91f0&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf488538770&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4186e8450&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c5a75f0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 88): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;lambda&gt; at 0x7cf4288f6e30, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 64): loc(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19)), (&lt;code object &lt;module&gt; at 0x7cf492eca890, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 54): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: &#39;/tmp/ipykernel_27185/3197095916.py&#39;, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: &#39;/tmp/ipykernel_27185/2145028508.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(&lt;lambda&gt;)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;jvp&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf4186e9f50&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 1))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf438656630&gt;]
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf418716810&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf4186e8070&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf4186e91f0&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf488538770&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4186e8450&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c5a75f0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7))))))))))), &lt;jaxlib.xla_extension.Traceback object at 0x5c205c7480f0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 88): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;lambda&gt; at 0x7cf4288f6e30, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 64): loc(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19)), (&lt;code object &lt;module&gt; at 0x7cf492eca890, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 54): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 232): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: &#39;/tmp/ipykernel_27185/3197095916.py&#39;, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: &#39;/tmp/ipykernel_27185/2145028508.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(&lt;lambda&gt;)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;jvp&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf4186ea310&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 2), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 3))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4288e3a30&gt;]
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf418716810&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf4186e8070&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf4186e91f0&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf488538770&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4186e8450&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c5a75f0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7))))))))))), &lt;jaxlib.xla_extension.Traceback object at 0x5c205c7480f0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7))))))))))), &lt;jaxlib.xla_extension.Traceback object at 0x5c205c500610&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19) at &quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 88): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:27:15)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;lambda&gt; at 0x7cf4288f6e30, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 64): loc(&quot;&lt;lambda&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:2:19)), (&lt;code object &lt;module&gt; at 0x7cf492eca890, file &quot;/tmp/ipykernel_27185/2145028508.py&quot;, line 1&gt;, 54): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/2145028508.py&quot;:1:7)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 232): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 246): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: &#39;/tmp/ipykernel_27185/3197095916.py&#39;, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: &#39;/tmp/ipykernel_27185/2145028508.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/tmp/ipykernel_27185/2145028508.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(&lt;lambda&gt;)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;jvp&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[])], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf4186ea710&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 2), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(%3 = &quot;stablehlo.add&quot;(%2, %arg3) : (tensor&lt;f32&gt;, tensor&lt;f32&gt;) -&gt; tensor&lt;f32&gt;))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf48853b6b0&gt;]
</pre></div>
</div>
</div>
</div>
<p>Notice that first we evaluate <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code> abstractly, which in turn
evaluates abstractly both the primal and the tangent evaluation (a total of
3 invocations of the <code class="docutils literal notranslate"><span class="pre">ma</span></code> primitive). Then we compile the 3 occurrences
of the primitive.</p>
</section>
</section>
<section id="reverse-differentiation">
<h3>Reverse differentiation<a class="headerlink" href="#reverse-differentiation" title="Link to this heading">#</a></h3>
<p>If we attempt now to use reverse differentiation we
see that JAX starts by using the <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code> to
compute the forward differentiation for abstract values, but then runs
into a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code>.</p>
<p>When computing the reverse differentiation JAX first does abstract evaluation
of the forward differentiation code <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code> to obtain a
trace of primitives that compute the output tangent.
Observe that JAX performs this abstract evaluation with concrete values
for the differentiation point, and abstract values for the tangents.
Observe also that JAX uses the special abstract tangent value <code class="docutils literal notranslate"><span class="pre">Zero</span></code> for
the tangent corresponding to the 3rd argument of <code class="docutils literal notranslate"><span class="pre">ma</span></code>. This reflects the
fact that we do not differentiate w.r.t. the 2nd argument to <code class="docutils literal notranslate"><span class="pre">square_add_prim</span></code>,
which flows to the 3rd argument to <code class="docutils literal notranslate"><span class="pre">multiply_add_prim</span></code>.</p>
<p>Observe also that during the abstract evaluation of the tangent we pass the
value 0.0 as the tangent for the 3rd argument. This is due to the use
of the <code class="docutils literal notranslate"><span class="pre">make_zero</span></code> function in the definition of <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is reverse differentiation w.r.t. the first argument of square_add_prim</span>
<span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">api</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
  call multiply_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
    call multiply_add_value_and_jvp((2.0, 2.0, 10.0), (Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Zero(ShapedArray(float32[], weak_type=True))))
      Primal evaluation:
      call multiply_add_prim(2.0, 2.0, 10.0)
        call multiply_add_impl(2.0, 2.0, 10.0)
        |&lt;- multiply_add_impl = 14.0
      |&lt;- multiply_add_prim = 14.0
      Tangent evaluation:
      call multiply_add_prim(2.0, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, 0.0)
        call multiply_add_abstract_eval(ConcreteArray(2.0, dtype=float32, weak_type=True), ShapedArray(float32[], weak_type=True), ConcreteArray(0.0, dtype=float32, weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, 2.0, Traced&lt;ShapedArray(float32[])&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ConcreteArray(2.0, dtype=float32, weak_type=True), ShapedArray(float32[]))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
    |&lt;- multiply_add_value_and_jvp = (14.0, Traced&lt;ShapedArray(float32[])&gt;)
  |&lt;- multiply_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;
|&lt;- square_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&quot;, line 283, in get_primitive_transpose
    return primitive_transposes[p]
           ~~~~~~~~~~~~~~~~~~~~^^^
KeyError: multiply_add

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;&lt;frozen runpy&gt;&quot;, line 198, in _run_module_as_main
  File &quot;&lt;frozen runpy&gt;&quot;, line 88, in _run_code
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
jax._src.source_info_util.JaxStackTraceBeforeTransformation: NotImplementedError: Transpose rule (for reverse-mode differentiation) for &#39;multiply_add&#39; not implemented

The preceding stack trace is the source of the JAX operation that, once transformed by JAX, triggered the following exception.

--------------------

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/339076514.py&quot;, line 3, in &lt;module&gt;
    api.grad(square_add_prim)(2., 10.)
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&quot;, line 179, in reraise_with_filtered_traceback
    return fun(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&quot;, line 647, in grad_f
    _, g = value_and_grad_f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
NotImplementedError: Transpose rule (for reverse-mode differentiation) for &#39;multiply_add&#39; not implemented
</pre></div>
</div>
</div>
</div>
<p>The above error is because there is a missing piece for JAX to be able
to use the forward differentiation code to compute reverse differentiation.</p>
<section id="transposition">
<h4>Transposition<a class="headerlink" href="#transposition" title="Link to this heading">#</a></h4>
<p>As explained above, when computing reverse differentiation JAX obtains
a trace of primitives that compute the tangent using forward differentiation.
Then, <strong>JAX interprets this trace abstractly backwards</strong> and for each
primitive it applies a <strong>transposition</strong> rule.</p>
<p>To understand what is going on, consider for now a simpler example of the function ‚Äúf(x, y) = x * y + y‚Äù. Assume we need to differentiate at the point <code class="docutils literal notranslate"><span class="pre">(2.,</span> <span class="pre">4.)</span></code>. JAX will produce the following JVP tangent calculation of <code class="docutils literal notranslate"><span class="pre">ft</span></code> from the tangents of the input <code class="docutils literal notranslate"><span class="pre">xt</span></code> and <code class="docutils literal notranslate"><span class="pre">yt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">a</span> <span class="o">=</span> <span class="n">xt</span> <span class="o">*</span> <span class="mf">4.</span>
   <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">yt</span>
   <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
   <span class="n">ft</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">yt</span>
</pre></div>
</div>
<p>By construction, the tangent calculation is always linear in the input tangents.
The only non-linear operator that may arise in the tangent calculation is multiplication,
but then one of the operands is constant.</p>
<p>JAX will produce the reverse differentiation computation by processing the
JVP computation backwards. For each operation in the tangent computation,
it accumulates the cotangents
of the variables used by the operation, using the cotangent of the result
of the operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="c1"># Initialize cotangents of inputs and intermediate vars</span>
  <span class="n">xct</span> <span class="o">=</span> <span class="n">yct</span> <span class="o">=</span> <span class="n">act</span> <span class="o">=</span> <span class="n">bct</span> <span class="o">=</span> <span class="n">cct</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="c1"># Initialize cotangent of the output</span>
  <span class="n">fct</span> <span class="o">=</span> <span class="mf">1.</span>
  <span class="c1"># Process &quot;ft = c + yt&quot;</span>
  <span class="n">cct</span> <span class="o">+=</span> <span class="n">fct</span>
  <span class="n">yct</span> <span class="o">+=</span> <span class="n">fct</span>
  <span class="c1"># Process &quot;c = a + b&quot;</span>
  <span class="n">act</span> <span class="o">+=</span> <span class="n">cct</span>
  <span class="n">bct</span> <span class="o">+=</span> <span class="n">cct</span>
  <span class="c1"># Process &quot;b = 2. * yt&quot;</span>
  <span class="n">yct</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">bct</span>
  <span class="c1"># Process &quot;a = xt * 4.&quot;</span>
  <span class="n">xct</span> <span class="o">+=</span> <span class="n">act</span> <span class="o">*</span> <span class="mf">4.</span>
</pre></div>
</div>
<p>One can verify that this computation produces <code class="docutils literal notranslate"><span class="pre">xct</span> <span class="pre">=</span> <span class="pre">4.</span></code> and <code class="docutils literal notranslate"><span class="pre">yct</span> <span class="pre">=</span> <span class="pre">3.</span></code>, which
are the partial derivatives of the function <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p>
<p>JAX knows for each primitive that may appear in a JVP calculation how to transpose it. Conceptually, if the primitive <code class="docutils literal notranslate"><span class="pre">p(x,</span> <span class="pre">y,</span> <span class="pre">z)</span></code> is linear in the arguments <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code> for a constant value of <code class="docutils literal notranslate"><span class="pre">x</span></code>, e.g., <code class="docutils literal notranslate"><span class="pre">p(x,</span> <span class="pre">y,</span> <span class="pre">z)</span> <span class="pre">=</span> <span class="pre">y*cy</span> <span class="pre">+</span> <span class="pre">z*cz</span></code>, then the transposition of the primitive is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p_transpose</span><span class="p">(</span><span class="n">out_ct</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ct</span><span class="o">*</span><span class="n">cy</span><span class="p">,</span> <span class="n">out_ct</span><span class="o">*</span><span class="n">cz</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">p_transpose</span></code> takes the cotangent of the output of the primitive and a value corresponding to each argument of the primitive. For the linear arguments, the transposition gets an undefined <code class="docutils literal notranslate"><span class="pre">_</span></code> value, and for the other
arguments it gets the actual constants. The transposition returns a cotangent value for each argument of the primitive, with the value <code class="docutils literal notranslate"><span class="pre">None</span></code> returned
for the constant arguments.</p>
<p>In particular,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">add_transpose</span><span class="p">(</span><span class="n">out_ct</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_ct</span><span class="p">,</span> <span class="n">out_ct</span><span class="p">)</span>
 <span class="n">mult_transpose</span><span class="p">(</span><span class="n">out_ct</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">out_ct</span><span class="p">)</span>
 <span class="n">mult_transpose</span><span class="p">(</span><span class="n">out_ct</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_ct</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_transpose&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_transpose</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Evaluates the transpose of a linear primitive.</span>

<span class="sd">  This method is only used when computing the backward gradient following </span>
<span class="sd">  value_and_jvp, and is only needed for primitives that are used in the JVP </span>
<span class="sd">  calculation for some other primitive. We need transposition for multiply_add_prim, </span>
<span class="sd">  because we have used multiply_add_prim in the computation of the output_tangent in </span>
<span class="sd">  multiply_add_value_and_jvp.</span>

<span class="sd">  In our case, multiply_add is not a linear primitive. However, it is used linearly </span>
<span class="sd">  w.r.t. tangents in multiply_add_value_and_jvp:</span>
<span class="sd">       output_tangent(xt, yt, zt) = multiply_add_prim(xt, y, multiply_add_prim(x, yt, zt))</span>
<span class="sd">  </span>
<span class="sd">  Always one of the first two multiplicative arguments is a constant.</span>

<span class="sd">  Args:</span>
<span class="sd">      ct: the cotangent of the output of the primitive.</span>
<span class="sd">      x, y, z: values of the arguments. The arguments that are used linearly</span>
<span class="sd">        get an ad.UndefinedPrimal value. The other arguments get a constant</span>
<span class="sd">        value.</span>
<span class="sd">  Returns:</span>
<span class="sd">      a tuple with the cotangent of the inputs, with the value None</span>
<span class="sd">      corresponding to the constant arguments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">ad</span><span class="o">.</span><span class="n">is_undefined_primal</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># This use of multiply_add is with a constant &quot;x&quot;</span>
    <span class="k">assert</span> <span class="n">ad</span><span class="o">.</span><span class="n">is_undefined_primal</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ct_y</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">Zero</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">aval</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ad</span><span class="o">.</span><span class="n">Zero</span> <span class="k">else</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">zeros_like_array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ct_y</span><span class="p">,</span> <span class="n">ct</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># This use of multiply_add is with a constant &quot;y&quot;</span>
    <span class="k">assert</span> <span class="n">ad</span><span class="o">.</span><span class="n">is_undefined_primal</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ct_x</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">Zero</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">aval</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ad</span><span class="o">.</span><span class="n">Zero</span> <span class="k">else</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">zeros_like_array</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ct_x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ct</span>
  <span class="k">return</span> <span class="n">res</span>


<span class="n">ad</span><span class="o">.</span><span class="n">primitive_transposes</span><span class="p">[</span><span class="n">multiply_add_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiply_add_transpose</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can complete the run of the <code class="docutils literal notranslate"><span class="pre">grad</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">==</span> <span class="mf">4.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
  call multiply_add_prim(Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, Traced&lt;ConcreteArray(2.0, dtype=float32, weak_type=True)&gt;, 10.0)
    call multiply_add_value_and_jvp((2.0, 2.0, 10.0), (Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Zero(ShapedArray(float32[], weak_type=True))))
      Primal evaluation:
      call multiply_add_prim(2.0, 2.0, 10.0)
        call multiply_add_impl(2.0, 2.0, 10.0)
        |&lt;- multiply_add_impl = 14.0
      |&lt;- multiply_add_prim = 14.0
      Tangent evaluation:
      call multiply_add_prim(2.0, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, 0.0)
        call multiply_add_abstract_eval(ConcreteArray(2.0, dtype=float32, weak_type=True), ShapedArray(float32[], weak_type=True), ConcreteArray(0.0, dtype=float32, weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, 2.0, Traced&lt;ShapedArray(float32[])&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ConcreteArray(2.0, dtype=float32, weak_type=True), ShapedArray(float32[]))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
    |&lt;- multiply_add_value_and_jvp = (14.0, Traced&lt;ShapedArray(float32[])&gt;)
  |&lt;- multiply_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;
|&lt;- square_add_prim = Traced&lt;ConcreteArray(14.0, dtype=float32)&gt;
call multiply_add_transpose(1.0, UndefinedPrimal(ShapedArray(float32[], weak_type=True)), 2.0, UndefinedPrimal(ShapedArray(float32[])))
  call multiply_add_prim(1.0, 2.0, 0.0)
    call multiply_add_impl(1.0, 2.0, 0.0)
    |&lt;- multiply_add_impl = 2.0
  |&lt;- multiply_add_prim = 2.0
|&lt;- multiply_add_transpose = (2.0, None, 1.0)
call multiply_add_transpose(1.0, 2.0, UndefinedPrimal(ShapedArray(float32[], weak_type=True)), 0.0)
  call multiply_add_prim(2.0, 1.0, 0.0)
    call multiply_add_impl(2.0, 1.0, 0.0)
    |&lt;- multiply_add_impl = 2.0
  |&lt;- multiply_add_prim = 2.0
|&lt;- multiply_add_transpose = (None, 2.0, 1.0)
</pre></div>
</div>
</div>
</div>
<p>Notice the two calls to <code class="docutils literal notranslate"><span class="pre">multiply_add_transpose</span></code>. They correspond to the two
uses of <code class="docutils literal notranslate"><span class="pre">multiply_add_prim</span></code> in the computation of the <code class="docutils literal notranslate"><span class="pre">output_tangent</span></code> in <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code>. The first call to transpose corresponds to the
last use of <code class="docutils literal notranslate"><span class="pre">multiply_add_prim</span></code>: <code class="docutils literal notranslate"><span class="pre">multiply_add_prim(xt,</span> <span class="pre">y,</span> <span class="pre">...)</span></code> where <code class="docutils literal notranslate"><span class="pre">y</span></code> is the constant 2.0.</p>
</section>
<section id="jit-of-reverse-differentiation">
<h4>JIT of reverse differentiation<a class="headerlink" href="#jit-of-reverse-differentiation" title="Link to this heading">#</a></h4>
<p>Notice that the abstract evaluation of the <code class="docutils literal notranslate"><span class="pre">multiply_add_value_and_jvp</span></code> is using only
abstract values, while in the absence of JIT we used <code class="docutils literal notranslate"><span class="pre">ConcreteArray</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">))(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">==</span> <span class="mf">4.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
    call multiply_add_value_and_jvp((Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;), (Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Zero(ShapedArray(float32[], weak_type=True))))
      Primal evaluation:
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
      Tangent evaluation:
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
      call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True), ShapedArray(float32[]))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
    |&lt;- multiply_add_value_and_jvp = (Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;)
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;
call multiply_add_transpose(Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, UndefinedPrimal(ShapedArray(float32[], weak_type=True)), Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, UndefinedPrimal(ShapedArray(float32[])))
  call multiply_add_prim(Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
    call multiply_add_abstract_eval(ShapedArray(float32[]), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True))
    |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
|&lt;- multiply_add_transpose = (Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, None, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
call multiply_add_transpose(Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, UndefinedPrimal(ShapedArray(float32[], weak_type=True)), Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
    call multiply_add_abstract_eval(ShapedArray(float32[], weak_type=True), ShapedArray(float32[]), ShapedArray(float32[], weak_type=True))
    |&lt;- multiply_add_abstract_eval = ShapedArray(float32[])
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
|&lt;- multiply_add_transpose = (None, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf41874b290&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf41875ab70&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf41875ae70&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf41875acf0&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4187599d0&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c6f0530&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/3085343041.py&quot;:1:7) at &quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 246): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;module&gt; at 0x7cf428881200, file &quot;/tmp/ipykernel_27185/3085343041.py&quot;, line 1&gt;, 90): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/3085343041.py&quot;:1:7)), (&lt;code object run_code at 0x5c205abc6990, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3541&gt;, 202): loc(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: &#39;/tmp/ipykernel_27185/3197095916.py&#39;, &#39;/tmp/ipykernel_27185/3085343041.py&#39;: &#39;/tmp/ipykernel_27185/3085343041.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/tmp/ipykernel_27185/3085343041.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: True}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(square_add_prim)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;transpose&#39;), Transform(name=&#39;jvp&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[]), ShapedArray(float32[], weak_type=True), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf41875bc50&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(%0 = &quot;stablehlo.constant&quot;() {value = dense&lt;1.000000e+00&gt; : tensor&lt;f32&gt;} : () -&gt; tensor&lt;f32&gt;), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(%1 = &quot;stablehlo.constant&quot;() {value = dense&lt;0.000000e+00&gt; : tensor&lt;f32&gt;} : () -&gt; tensor&lt;f32&gt;))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4397298f0&gt;]
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf41874b290&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf41875ab70&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf41875ae70&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf41875acf0&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf4187599d0&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c6f0530&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/3085343041.py&quot;:1:7) at &quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20))))))))))), &lt;jaxlib.xla_extension.Traceback object at 0x5c205c7a7fe0&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/3085343041.py&quot;:1:7) at &quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 246): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:19)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;module&gt; at 0x7cf428881200, file &quot;/tmp/ipykernel_27185/3085343041.py&quot;, line 1&gt;, 90): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/3085343041.py&quot;:1:7)), (&lt;code object run_code at 0x5c205abc6990, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3541&gt;, 202): loc(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)), (&lt;code object multiply_add_value_and_jvp at 0x7cf428991a70, file &quot;/tmp/ipykernel_27185/3197095916.py&quot;, line 4&gt;, 232): loc(&quot;multiply_add_value_and_jvp&quot;(&quot;/tmp/ipykernel_27185/3197095916.py&quot;:41:55))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: &#39;/tmp/ipykernel_27185/3197095916.py&#39;, &#39;/tmp/ipykernel_27185/3085343041.py&#39;: &#39;/tmp/ipykernel_27185/3085343041.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/3197095916.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/ad.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/tmp/ipykernel_27185/3085343041.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: True}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(square_add_prim)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;transpose&#39;), Transform(name=&#39;jvp&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[], weak_type=True), ShapedArray(float32[]), ShapedArray(float32[], weak_type=True)], avals_out=[ShapedArray(float32[])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf418760150&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;f32&gt;&#39; at index: 0), Value(%4 = &quot;stablehlo.constant&quot;() {value = dense&lt;1.000000e+00&gt; : tensor&lt;f32&gt;} : () -&gt; tensor&lt;f32&gt;), Value(%5 = &quot;stablehlo.constant&quot;() {value = dense&lt;0.000000e+00&gt; : tensor&lt;f32&gt;} : () -&gt; tensor&lt;f32&gt;))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4288a7af0&gt;]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="batching">
<h3>Batching<a class="headerlink" href="#batching" title="Link to this heading">#</a></h3>
<p>The batching transformation takes a point-wise computation and turns it
into a computation on vectors. If we try it right now, we get a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The arguments are two vectors instead of two scalars</span>
<span class="k">with</span> <span class="n">expectNotImplementedError</span><span class="p">():</span>
  <span class="n">api</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]),</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)

Found expected exception:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/tmp/ipykernel_27185/2641678767.py&quot;, line 3, in &lt;module&gt;
    api.vmap(square_add_prim, in_axes=0, out_axes=0)(np.array([2., 3.]),
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&quot;, line 179, in reraise_with_filtered_traceback
    return fun(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&quot;, line 1240, in vmap_f
    out_flat = batching.batch(
               ^^^^^^^^^^^^^^^
NotImplementedError: Batching rule for &#39;multiply_add&#39; not implemented
</pre></div>
</div>
</div>
</div>
<p>We need to tell JAX how to evaluate the batched version of the primitive. In this particular case, the <code class="docutils literal notranslate"><span class="pre">multiply_add_prim</span></code> already operates pointwise for any dimension of input vectors. So the batched version can use the same <code class="docutils literal notranslate"><span class="pre">multiply_add_prim</span></code> implementation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">batching</span>


<span class="nd">@trace</span><span class="p">(</span><span class="s2">&quot;multiply_add_batch&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_add_batch</span><span class="p">(</span><span class="n">vector_arg_values</span><span class="p">,</span> <span class="n">batch_axes</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Computes the batched version of the primitive.</span>
<span class="sd">  </span>
<span class="sd">  This must be a JAX-traceable function.</span>
<span class="sd">  </span>
<span class="sd">  Since the multiply_add primitive already operates pointwise on arbitrary</span>
<span class="sd">  dimension tensors, to batch it we can use the primitive itself. This works as</span>
<span class="sd">  long as both the inputs have the same dimensions and are batched along the</span>
<span class="sd">  same axes. The result is batched along the axis that the inputs are batched.</span>
<span class="sd">  </span>
<span class="sd">  Args:</span>
<span class="sd">    vector_arg_values: a tuple of two arguments, each being a tensor of matching</span>
<span class="sd">      shape.</span>
<span class="sd">    batch_axes: the axes that are being batched. See vmap documentation.</span>
<span class="sd">  Returns:</span>
<span class="sd">    a tuple of the result, and the result axis that was batched. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="n">batch_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">assert</span> <span class="n">batch_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch_axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">_trace</span><span class="p">(</span><span class="s2">&quot;Using multiply_add to compute the batch:&quot;</span><span class="p">)</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">multiply_add_prim</span><span class="p">(</span><span class="o">*</span><span class="n">vector_arg_values</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">batch_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">batching</span><span class="o">.</span><span class="n">primitive_batchers</span><span class="p">[</span><span class="n">multiply_add_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiply_add_batch</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]),</span>
  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">])),</span>
  <span class="p">[</span><span class="mf">14.</span><span class="p">,</span> <span class="mf">29.</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)
    call multiply_add_batch(([2. 3.], [2. 3.], [10. 20.]), (0, 0, 0))
      Using multiply_add to compute the batch:
      call multiply_add_prim([2. 3.], [2. 3.], [10. 20.])
        call multiply_add_impl([2. 3.], [2. 3.], [10. 20.])
        |&lt;- multiply_add_impl = [14. 29.]
      |&lt;- multiply_add_prim = [14. 29.]
    |&lt;- multiply_add_batch = ([14. 29.], 0)
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;
</pre></div>
</div>
</div>
</div>
<section id="jit-of-batching">
<h4>JIT of batching<a class="headerlink" href="#jit-of-batching" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">square_add_prim</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">]),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">])),</span>
                    <span class="p">[</span><span class="mf">14.</span><span class="p">,</span> <span class="mf">29.</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call square_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)
  call multiply_add_prim(Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;, Traced&lt;ShapedArray(float32[])&gt;)
    call multiply_add_batch((Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;), (0, 0, 0))
      Using multiply_add to compute the batch:
      call multiply_add_prim(Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;)
        call multiply_add_abstract_eval(ShapedArray(float32[2]), ShapedArray(float32[2]), ShapedArray(float32[2]))
        |&lt;- multiply_add_abstract_eval = ShapedArray(float32[2])
      |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
    |&lt;- multiply_add_batch = (Traced&lt;ShapedArray(float32[2])&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;, 0)
  |&lt;- multiply_add_prim = Traced&lt;ShapedArray(float32[])&gt;
|&lt;- square_add_prim = Traced&lt;ShapedArray(float32[])&gt;
call multiply_add_lowering(LoweringRuleContext(module_context=ModuleContext(context=&lt;jaxlib.mlir._mlir_libs._site_initialize.&lt;locals&gt;.Context object at 0x7cf41876c3b0&gt;, module=&lt;jaxlib.mlir._mlir_libs._mlir.ir.Module object at 0x7cf4187614b0&gt;, ip=&lt;jaxlib.mlir._mlir_libs._mlir.ir.InsertionPoint object at 0x7cf418761530&gt;, symbol_table=&lt;jaxlib.mlir._mlir_libs._mlir.ir.SymbolTable object at 0x7cf4187614f0&gt;, backend_or_name=&lt;jaxlib.xla_extension.Client object at 0x7cf42899a5c0&gt;, platforms=(&#39;cpu&#39;,), axis_context=ShardingContext(num_devices=1, device_assignment=None), keepalives=[], channel_iterator=count(1), host_callbacks=[], shape_poly_state=&lt;jax._src.interpreters.mlir.ShapePolyLoweringState object at 0x7cf418761190&gt;, cached_primitive_lowerings={}, traceback_caches=TracebackCaches(traceback_cache={&lt;jaxlib.xla_extension.Traceback object at 0x5c205c4a8d90&gt;: loc(callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_batch&quot;(&quot;/tmp/ipykernel_27185/184469370.py&quot;:25:8) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9) at callsite(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12) at callsite(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/1392464762.py&quot;:1:19) at &quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20)))))))))))}, location_cache={(&lt;code object multiply_add_prim at 0x7cf4288f5330, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 4&gt;, 54): loc(&quot;multiply_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:11:9)), (&lt;code object func_wrapper at 0x7cf433f765b0, file &quot;/tmp/ipykernel_27185/1393342955.py&quot;, line 45&gt;, 98): loc(&quot;trace.&lt;locals&gt;.trace_func.&lt;locals&gt;.func_wrapper&quot;(&quot;/tmp/ipykernel_27185/1393342955.py&quot;:48:12)), (&lt;code object multiply_add_batch at 0x7cf42899da70, file &quot;/tmp/ipykernel_27185/184469370.py&quot;, line 4&gt;, 126): loc(&quot;multiply_add_batch&quot;(&quot;/tmp/ipykernel_27185/184469370.py&quot;:25:8)), (&lt;code object square_add_prim at 0x7cf4288673d0, file &quot;/tmp/ipykernel_27185/1308506715.py&quot;, line 13&gt;, 32): loc(&quot;square_add_prim&quot;(&quot;/tmp/ipykernel_27185/1308506715.py&quot;:16:9)), (&lt;code object &lt;module&gt; at 0x7cf4380ee3a0, file &quot;/tmp/ipykernel_27185/1392464762.py&quot;, line 1&gt;, 204): loc(&quot;&lt;module&gt;&quot;(&quot;/tmp/ipykernel_27185/1392464762.py&quot;:1:19)), (&lt;code object run_code at 0x5c205abc6990, file &quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;, line 3541&gt;, 202): loc(&quot;InteractiveShell.run_code&quot;(&quot;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&quot;:3577:20))}, canonical_name_cache={&#39;/tmp/ipykernel_27185/1308506715.py&#39;: &#39;/tmp/ipykernel_27185/1308506715.py&#39;, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: &#39;/tmp/ipykernel_27185/1393342955.py&#39;, &#39;/tmp/ipykernel_27185/184469370.py&#39;: &#39;/tmp/ipykernel_27185/184469370.py&#39;, &#39;/tmp/ipykernel_27185/1392464762.py&#39;: &#39;/tmp/ipykernel_27185/1392464762.py&#39;, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;}, is_user_file_cache={&#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/source_info_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/partial_eval.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/core.py&#39;: False, &#39;/tmp/ipykernel_27185/1308506715.py&#39;: True, &#39;/tmp/ipykernel_27185/1393342955.py&#39;: True, &#39;/tmp/ipykernel_27185/184469370.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/batching.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/linear_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/api.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/traceback_util.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/profiler.py&#39;: False, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/pjit.py&#39;: False, &#39;/tmp/ipykernel_27185/1392464762.py&#39;: True, &#39;/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/IPython/core/interactiveshell.py&#39;: True}), lowering_parameters=LoweringParameters(override_lowering_rules=None, platforms=None, global_constant_computation=False, replace_tokens_with_dummy=True)), name_stack=NameStack(stack=(Scope(name=&#39;jit(square_add_prim)&#39;), Scope(name=&#39;jit(main)&#39;), Transform(name=&#39;vmap&#39;))), primitive=multiply_add, avals_in=[ShapedArray(float32[2]), ShapedArray(float32[2]), ShapedArray(float32[2])], avals_out=[ShapedArray(float32[2])], tokens_in=&lt;jax._src.interpreters.mlir.TokenSet object at 0x7cf418762650&gt;, tokens_out=None, axis_size_env=None, dim_var_values=[]), Value(&lt;block argument&gt; of type &#39;tensor&lt;2xf32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;2xf32&gt;&#39; at index: 0), Value(&lt;block argument&gt; of type &#39;tensor&lt;2xf32&gt;&#39; at index: 1))
|&lt;- multiply_add_lowering = [&lt;jaxlib.mlir._mlir_libs._mlir.ir.OpResult object at 0x7cf4187593b0&gt;]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="autodiff_remat.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Control autodiff‚Äôs saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</p>
      </div>
    </a>
    <a class="right-next"
       href="Writing_custom_interpreters_in_Jax.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Writing custom Jaxpr interpreters in JAX</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-existing-primitives">Using existing primitives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-new-jax-primitives">Defining new JAX primitives</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#primal-evaluation-rules">Primal evaluation rules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jit">JIT</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract-evaluation-rules">Abstract evaluation rules</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#xla-compilation-rules">XLA Compilation rules</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-differentiation">Forward differentiation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-forward-differentiation">JIT of forward differentiation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-differentiation">Reverse differentiation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#transposition">Transposition</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-reverse-differentiation">JIT of reverse differentiation</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#batching">Batching</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jit-of-batching">JIT of batching</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>