
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>🔪 JAX - The Sharp Bits 🔪 &#8212; JAX  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=02ed413a" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/Common_Gotchas_in_JAX';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="JAX Frequently Asked Questions (FAQ)" href="../faq.html" />
    <link rel="prev" title="How to Think in JAX" href="thinking_in_jax.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/jax_logo_250px.png" class="logo__image only-light" alt="JAX  documentation - Home"/>
    <script>document.write(`<img src="../_static/jax_logo_250px.png" class="logo__image only-dark" alt="JAX  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installing JAX</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">JAX Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="thinking_in_jax.html">How to Think in JAX</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">🔪 JAX - The Sharp Bits 🔪</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">JAX Frequently Asked Questions (FAQ)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax-101/index.html">Tutorial: JAX 101</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/01-jax-basics.html">JAX As Accelerated NumPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/02-jitting.html">Just In Time Compilation with JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/03-vectorization.html">Automatic Vectorization in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/04-advanced-autodiff.html">Advanced Automatic Differentiation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05-random-numbers.html">Pseudo Random Numbers in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/05.1-pytrees.html">Working with Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/06-parallelism.html">Parallel Evaluation in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax-101/07-state.html">Stateful Computations in JAX</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../user_guides.html">User Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../profiling.html">Profiling JAX programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_memory_profiling.html">Device Memory Profiling</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../debugging/index.html">Runtime value debugging in JAX</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../debugging/print_breakpoint.html"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/checkify_guide.html">The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugging/flags.html">JAX debugging flags</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_performance_tips.html">GPU performance tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="../persistent_compilation_cache.html">Persistent Compilation Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jaxpr.html">Understanding Jaxprs</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_callbacks.html">External Callbacks in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../type_promotion.html">Type promotion semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pytrees.html">Pytrees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aot.html">Ahead-of-time lowering and compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../errors.html">JAX Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transfer_guard.html">Transfer guard</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../pallas/index.html">Pallas: a JAX kernel language</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../pallas/design.html">Pallas Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pallas/quickstart.html">Pallas Quickstart</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../pallas/tpu/index.html">Pallas TPU</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/details.html">Writing TPU kernels with Pallas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pallas/tpu/pipelining.html">Pipelining and <code class="docutils literal notranslate"><span class="pre">BlockSpec</span></code>s</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced_guide.html">Advanced Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="neural_network_with_tfds_data.html">Training a Simple Neural Network, with tensorflow/datasets Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="Neural_Network_and_Data_Loading.html">Training a Simple Neural Network, with PyTorch Data Loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmapped_log_probs.html">Autobatching for Bayesian Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multi_process.html">Using JAX in multi-host and multi-process environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="Distributed_arrays_and_automatic_parallelization.html">Distributed arrays and automatic parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="shard_map.html">SPMD multi-device parallelism with <code class="docutils literal notranslate"><span class="pre">shard_map</span></code></a></li>



<li class="toctree-l2"><a class="reference internal" href="xmap_tutorial.html">Named axes and easy-to-revise parallelism with <code class="docutils literal notranslate"><span class="pre">xmap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="autodiff_cookbook.html">The Autodiff Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="Custom_derivative_rules_for_Python_code.html">Custom derivative rules for JAX-transformable Python functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="autodiff_remat.html">Control autodiff’s saved values with <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> (aka <code class="docutils literal notranslate"><span class="pre">jax.remat</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="How_JAX_primitives_work.html">How JAX primitives work</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing_custom_interpreters_in_Jax.html">Writing custom Jaxpr interpreters in JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Custom_Operation_for_GPUs.html">Custom operations for GPUs with C++ and CUDA</a></li>

<li class="toctree-l2"><a class="reference internal" href="convolutions.html">Generalized Convolutions in JAX</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor_guide.html">Developer Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributing.html">Contributing to JAX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developer.html">Building from source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_internal_api.html">Internal APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../autodidax.html">Autodidax: JAX core from scratch</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jep/index.html">JAX Enhancement Proposals (JEPs)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jep/263-prng.html">263: JAX PRNG Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/2026-custom-derivatives.html">2026: Custom JVP/VJP rules for JAX-transformable functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4008-custom-vjp-update.html">4008: Custom VJP and `nondiff_argnums` update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/4410-omnistaging.html">4410: Omnistaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9263-typed-keys.html">9263: Typed keys &amp; pluggable RNGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9407-type-promotion.html">9407: Design of Type Promotion Semantics for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/9419-jax-versioning.html">9419: Jax and Jaxlib versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/10657-sequencing-effects.html">10657: Sequencing side-effects in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">11830: `jax.remat` / `jax.checkpoint` new implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/12049-type-annotations.html">12049: Type Annotation Roadmap for JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/14273-shard-map.html">14273: `shard_map` (`shmap`) for simple per-device code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/15856-jex.html">15856: `jax.extend`, an extensions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/17111-shmap-transpose.html">17111: Efficient transposition of `shard_map` (and other maps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jep/18137-numpy-scipy-scope.html">18137: Scope of JAX NumPy &amp; SciPy Wrappers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../investigating_a_regression.html">Investigating a regression</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building_on_jax.html">Building on JAX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../notes.html">Notes</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_compatibility.html">API compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deprecation.html">Python and NumPy version support policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax_array_migration.html">jax.Array migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../async_dispatch.html">Asynchronous dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_memory_allocation.html">GPU memory allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rank_promotion_warning.html">Rank promotion warning</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../jax.html">Public API: jax package</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.numpy.html"><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft.html">jax.numpy.fft.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fft2.html">jax.numpy.fft.fft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftfreq.html">jax.numpy.fft.fftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftn.html">jax.numpy.fft.fftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.fftshift.html">jax.numpy.fft.fftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.hfft.html">jax.numpy.fft.hfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft.html">jax.numpy.fft.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifft2.html">jax.numpy.fft.ifft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftn.html">jax.numpy.fft.ifftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ifftshift.html">jax.numpy.fft.ifftshift</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.ihfft.html">jax.numpy.fft.ihfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft.html">jax.numpy.fft.irfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfft2.html">jax.numpy.fft.irfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.irfftn.html">jax.numpy.fft.irfftn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft.html">jax.numpy.fft.rfft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfft2.html">jax.numpy.fft.rfft2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftfreq.html">jax.numpy.fft.rfftfreq</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.numpy.fft.rfftn.html">jax.numpy.fft.rfftn</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.scipy.html"><code class="docutils literal notranslate"><span class="pre">jax.scipy</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.logpmf.html">jax.scipy.stats.bernoulli.logpmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.pmf.html">jax.scipy.stats.bernoulli.pmf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.cdf.html">jax.scipy.stats.bernoulli.cdf</a></li>
<li class="toctree-l3"><a class="reference internal" href="../_autosummary/jax.scipy.stats.bernoulli.ppf.html">jax.scipy.stats.bernoulli.ppf</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lax.html"><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.random.html"><code class="docutils literal notranslate"><span class="pre">jax.random</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.sharding.html"><code class="docutils literal notranslate"><span class="pre">jax.sharding</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.debug.html"><code class="docutils literal notranslate"><span class="pre">jax.debug</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dlpack.html"><code class="docutils literal notranslate"><span class="pre">jax.dlpack</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.distributed.html"><code class="docutils literal notranslate"><span class="pre">jax.distributed</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.dtypes.html"><code class="docutils literal notranslate"><span class="pre">jax.dtypes</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.flatten_util.html"><code class="docutils literal notranslate"><span class="pre">jax.flatten_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.image.html"><code class="docutils literal notranslate"><span class="pre">jax.image</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.nn.html"><code class="docutils literal notranslate"><span class="pre">jax.nn</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.nn.initializers.html"><code class="docutils literal notranslate"><span class="pre">jax.nn.initializers</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.ops.html"><code class="docutils literal notranslate"><span class="pre">jax.ops</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.profiler.html"><code class="docutils literal notranslate"><span class="pre">jax.profiler</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.stages.html"><code class="docutils literal notranslate"><span class="pre">jax.stages</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree.html"><code class="docutils literal notranslate"><span class="pre">jax.tree</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.tree_util.html"><code class="docutils literal notranslate"><span class="pre">jax.tree_util</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jax.typing.html"><code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.extend.html"><code class="docutils literal notranslate"><span class="pre">jax.extend</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.linear_util.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.linear_util</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.mlir.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.mlir</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.extend.random.html"><code class="docutils literal notranslate"><span class="pre">jax.extend.random</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.example_libraries.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.optimizers.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.optimizers</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.example_libraries.stax.html"><code class="docutils literal notranslate"><span class="pre">jax.example_libraries.stax</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../jax.experimental.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.array_api.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.array_api</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.checkify.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.host_callback.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.host_callback</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.maps.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.maps</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.pjit.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.pjit</span></code> module</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../jax.experimental.sparse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.sparse</span></code> module</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.BCOO.html">jax.experimental.sparse.BCOO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_broadcast_in_dim.html">jax.experimental.sparse.bcoo_broadcast_in_dim</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_concatenate.html">jax.experimental.sparse.bcoo_concatenate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general.html">jax.experimental.sparse.bcoo_dot_general</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dot_general_sampled.html">jax.experimental.sparse.bcoo_dot_general_sampled</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_dynamic_slice.html">jax.experimental.sparse.bcoo_dynamic_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_extract.html">jax.experimental.sparse.bcoo_extract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_fromdense.html">jax.experimental.sparse.bcoo_fromdense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_gather.html">jax.experimental.sparse.bcoo_gather</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_dense.html">jax.experimental.sparse.bcoo_multiply_dense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_multiply_sparse.html">jax.experimental.sparse.bcoo_multiply_sparse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_update_layout.html">jax.experimental.sparse.bcoo_update_layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reduce_sum.html">jax.experimental.sparse.bcoo_reduce_sum</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_reshape.html">jax.experimental.sparse.bcoo_reshape</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_slice.html">jax.experimental.sparse.bcoo_slice</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sort_indices.html">jax.experimental.sparse.bcoo_sort_indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_squeeze.html">jax.experimental.sparse.bcoo_squeeze</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_sum_duplicates.html">jax.experimental.sparse.bcoo_sum_duplicates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_todense.html">jax.experimental.sparse.bcoo_todense</a></li>
<li class="toctree-l4"><a class="reference internal" href="../_autosummary/jax.experimental.sparse.bcoo_transpose.html">jax.experimental.sparse.bcoo_transpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.jet.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.jet</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.custom_partitioning.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.custom_partitioning</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.multihost_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.multihost_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.compilation_cache.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.compilation_cache</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.key_reuse.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.key_reuse</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../jax.experimental.mesh_utils.html"><code class="docutils literal notranslate"><span class="pre">jax.experimental.mesh_utils</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../jax.lib.html"><code class="docutils literal notranslate"><span class="pre">jax.lib</span></code> module</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">JAX Glossary of Terms</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/google/jax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/Common_Gotchas_in_JAX.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>🔪 JAX - The Sharp Bits 🔪</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pure-functions">🔪 Pure functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-place-updates">🔪 In-Place Updates</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#array-updates-x-at-idx-set-y">Array updates: <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#array-updates-with-other-operations">Array updates with other operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#out-of-bounds-indexing">🔪 Out-of-Bounds Indexing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-array-inputs-numpy-vs-jax">🔪 Non-array inputs: NumPy vs. JAX</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-numbers">🔪 Random Numbers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rngs-and-state">RNGs and State</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-prng">JAX PRNG</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow">🔪 Control Flow</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-control-flow-autodiff">✔ python control_flow + autodiff ✔</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-control-flow-jit">python control flow + JIT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structured-control-flow-primitives">Structured control flow primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cond"><code class="docutils literal notranslate"><span class="pre">cond</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#while-loop"><code class="docutils literal notranslate"><span class="pre">while_loop</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fori-loop"><code class="docutils literal notranslate"><span class="pre">fori_loop</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-shapes">🔪 Dynamic Shapes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nans">🔪 NaNs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-nans">Debugging NaNs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#double-64bit-precision">🔪 Double (64bit) precision</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caveats">Caveats</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#miscellaneous-divergences-from-numpy">🔪 Miscellaneous Divergences from NumPy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fin">Fin.</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="jax-the-sharp-bits">
<h1>🔪 JAX - The Sharp Bits 🔪<a class="headerlink" href="#jax-the-sharp-bits" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/google/jax/blob/main/docs/notebooks/Common_Gotchas_in_JAX.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a> <a class="reference external" href="https://kaggle.com/kernels/welcome?src=https://github.com/google/jax/blob/main/docs/notebooks/Common_Gotchas_in_JAX.ipynb"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg" /></a></p>
<p><em>levskaya&#64; mattjj&#64;</em></p>
<p>When walking about the countryside of Italy, the people will not hesitate to tell you that <strong>JAX</strong> has <a class="reference external" href="https://www.sscardapane.it/iaml-backup/jax-intro/"><em>“una anima di pura programmazione funzionale”</em></a>.</p>
<p><strong>JAX</strong> is a language for <strong>expressing</strong> and <strong>composing</strong> <strong>transformations</strong> of numerical programs. <strong>JAX</strong> is also able to <strong>compile</strong> numerical programs for CPU or accelerators (GPU/TPU).
JAX works great for many numerical and scientific programs, but <strong>only if they are written with certain constraints</strong> that we describe below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">grad</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
</pre></div>
</div>
</div>
</div>
<section id="pure-functions">
<h2>🔪 Pure functions<a class="headerlink" href="#pure-functions" title="Link to this heading">#</a></h2>
<p>JAX transformation and compilation are designed to work only on Python functions that are functionally pure: all the input data is passed through the function parameters, all the results are output through the function results. A pure function will always return the same result if invoked with the same inputs.</p>
<p>Here are some examples of functions that are not functionally pure for which JAX behaves differently than the Python interpreter. Note that these behaviors are not guaranteed by the JAX system; the proper way to use JAX is to use it only on functionally pure Python functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impure_print_side_effect</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing function&quot;</span><span class="p">)</span>  <span class="c1"># This is a side-effect</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="c1"># The side-effects appear during the first run</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;First call: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>

<span class="c1"># Subsequent runs with parameters of same type and shape may not show the side-effect</span>
<span class="c1"># This is because JAX now invokes a cached compilation of the function</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Second call: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>

<span class="c1"># JAX re-runs the Python function when the type or shape of the argument changes</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Third call, different type: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Executing function
First call:  4.0
Second call:  5.0
Executing function
Third call, different type:  [5.]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="k">def</span> <span class="nf">impure_uses_globals</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">g</span>

<span class="c1"># JAX captures the value of the global during the first run</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;First call: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">10.</span>  <span class="c1"># Update the global</span>

<span class="c1"># Subsequent runs may silently use the cached value of the globals</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Second call: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>

<span class="c1"># JAX re-runs the Python function when the type or shape of the argument changes</span>
<span class="c1"># This will end up reading the latest value of the global</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Third call, different type: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First call:  4.0
Second call:  5.0
Third call, different type:  [14.]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="k">def</span> <span class="nf">impure_saves_global</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">g</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="c1"># JAX runs once the transformed function with special Traced values for arguments</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;First call: &quot;</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_saves_global</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Saved global: &quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>  <span class="c1"># Saved global has an internal JAX value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First call:  4.0
Saved global:  Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
</pre></div>
</div>
</div>
</div>
<p>A Python function can be functionally pure even if it actually uses stateful objects internally, as long as it does not read or write external state:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pure_uses_internal_state</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">even</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">odd</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;even&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">pure_uses_internal_state</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50.0
</pre></div>
</div>
</div>
</div>
<p>It is not recommended to use iterators in any JAX function you want to <code class="docutils literal notranslate"><span class="pre">jit</span></code> or in any control-flow primitive. The reason is that an iterator is a python object which introduces state to retrieve the next element. Therefore, it is incompatible with JAX functional programming model. In the code below, there are some examples of incorrect attempts to use iterators with JAX. Most of them return an error, but some give unexpected results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.lax</span> <span class="k">as</span> <span class="nn">lax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">make_jaxpr</span>

<span class="c1"># lax.fori_loop</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># expected result 45</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># unexpected result 0</span>

<span class="c1"># lax.scan</span>
<span class="k">def</span> <span class="nf">func11</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">aelems</span><span class="p">):</span>
        <span class="n">ae1</span><span class="p">,</span> <span class="n">ae2</span> <span class="o">=</span> <span class="n">aelems</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">carry</span> <span class="o">+</span> <span class="n">ae1</span> <span class="o">*</span> <span class="n">ae2</span> <span class="o">+</span> <span class="n">extra</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ones</span><span class="p">))</span>
<span class="n">make_jaxpr</span><span class="p">(</span><span class="n">func11</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="mf">5.</span><span class="p">)</span>
<span class="c1"># make_jaxpr(func11)(iter(range(16)), 5.) # throws error</span>

<span class="c1"># lax.cond</span>
<span class="n">array_operand</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_operand</span><span class="p">)</span>
<span class="n">iter_operand</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="c1"># lax.cond(True, lambda x: next(x)+1, lambda x: next(x)-1, iter_operand) # throws error</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>45
0
</pre></div>
</div>
</div>
</div>
</section>
<section id="in-place-updates">
<h2>🔪 In-Place Updates<a class="headerlink" href="#in-place-updates" title="Link to this heading">#</a></h2>
<p>In Numpy you’re used to doing this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original array:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>

<span class="c1"># In place, mutating update</span>
<span class="n">numpy_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;updated array:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array:
[[0. 0. 0.]
 [0. 0. 0.]
 [0. 0. 0.]]
updated array:
[[0. 0. 0.]
 [1. 1. 1.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>If we try to update a JAX device array in-place, however, we get an <strong>error</strong>!  (☉_☉)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">xmode</span> Minimal
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception reporting mode: Minimal
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># In place update of JAX&#39;s array will yield an error!</span>
<span class="n">jax_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">4</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1 </span>jax_array = jnp.zeros((<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>,<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>), dtype=jnp.float32)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">3 # In place update of JAX's array will yield an error!</span>                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>4 jax_array[<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>, :] = <span style="color: #0000ff; text-decoration-color: #0000ff">1.0</span>                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">5 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">array_me</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">thods.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">278</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_unimplemented_setitem</span>                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">275 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │    </span><span style="color: #808000; text-decoration-color: #808000">"immutable. Instead of ``x[idx] = y``, use ``x = x.at[idx].set(y)`` "</span>             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">276 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │    </span><span style="color: #808000; text-decoration-color: #808000">"or another .at[] method: "</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">277 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │    </span><span style="color: #808000; text-decoration-color: #808000">"https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html"</span>)    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>278 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(msg.format(<span style="color: #00ffff; text-decoration-color: #00ffff">type</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>)))                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">279 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">280 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_operator_round</span>(number: ArrayLike, ndigits: <span style="color: #00ffff; text-decoration-color: #00ffff">int</span> | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>) -&gt; Array:               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">281 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>out = lax_numpy.round(number, decimals=ndigits <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span><span style="color: #008000; text-decoration-color: #008000">'&lt;class '</span><span style="color: #000000; text-decoration-color: #000000">jaxlib.xla_extension.ArrayImpl'</span><span style="font-weight: bold">&gt;</span>' object does not support item assignment. JAX arrays are 
immutable. Instead of ``x<span style="font-weight: bold">[</span>idx<span style="font-weight: bold">]</span> = y``, use ``x = x.at<span style="font-weight: bold">[</span>idx<span style="font-weight: bold">]</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.set</span><span style="font-weight: bold">(</span>y<span style="font-weight: bold">)</span>`` or another .at<span style="font-weight: bold">[]</span> method: 
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html</span>
</pre>
</div></div>
</div>
<p>Allowing mutation of variables in-place makes program analysis and transformation difficult. JAX requires that programs are pure functions.</p>
<p>Instead, JAX offers a <em>functional</em> array update using the <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html#jax.numpy.ndarray.at"><code class="docutils literal notranslate"><span class="pre">.at</span></code> property on JAX arrays</a>.</p>
<p>️⚠️ inside <code class="docutils literal notranslate"><span class="pre">jit</span></code>’d code and <code class="docutils literal notranslate"><span class="pre">lax.while_loop</span></code> or <code class="docutils literal notranslate"><span class="pre">lax.fori_loop</span></code> the <strong>size</strong> of slices can’t be functions of argument <em>values</em> but only functions of argument <em>shapes</em> – the slice start indices have no such restriction.  See the below <strong>Control Flow</strong> Section for more information on this limitation.</p>
<section id="array-updates-x-at-idx-set-y">
<h3>Array updates: <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code><a class="headerlink" href="#array-updates-x-at-idx-set-y" title="Link to this heading">#</a></h3>
<p>For example, the update above can be written as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">updated_array</span> <span class="o">=</span> <span class="n">jax_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;updated array:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">updated_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>updated array:
 [[0. 0. 0.]
 [1. 1. 1.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>JAX’s array update functions, unlike their NumPy versions, operate out-of-place. That is, the updated array is returned as a new array and the original array is not modified by the update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original array unchanged:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">jax_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array unchanged:
 [[0. 0. 0.]
 [0. 0. 0.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>However, inside <strong>jit</strong>-compiled code, if the <strong>input value</strong> <code class="docutils literal notranslate"><span class="pre">x</span></code> of <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code> is not reused, the compiler will optimize the array update to occur <em>in-place</em>.</p>
</section>
<section id="array-updates-with-other-operations">
<h3>Array updates with other operations<a class="headerlink" href="#array-updates-with-other-operations" title="Link to this heading">#</a></h3>
<p>Indexed array updates are not limited simply to overwriting values. For example, we can perform indexed addition as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;original array:&quot;</span><span class="p">)</span>
<span class="n">jax_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jax_array</span><span class="p">)</span>

<span class="n">new_jax_array</span> <span class="o">=</span> <span class="n">jax_array</span><span class="o">.</span><span class="n">at</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">7.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new array post-addition:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_jax_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array:
[[1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]]
new array post-addition:
[[1. 1. 1. 8. 8. 8.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 8. 8. 8.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 8. 8. 8.]]
</pre></div>
</div>
</div>
</div>
<p>For more details on indexed array updates, see the <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html#jax.numpy.ndarray.at">documentation for the <code class="docutils literal notranslate"><span class="pre">.at</span></code> property</a>.</p>
</section>
</section>
<section id="out-of-bounds-indexing">
<h2>🔪 Out-of-Bounds Indexing<a class="headerlink" href="#out-of-bounds-indexing" title="Link to this heading">#</a></h2>
<p>In Numpy, you are used to errors being thrown when you index an array outside of its bounds, like this:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 np.arange(<span style="color: #0000ff; text-decoration-color: #0000ff">10</span>)[<span style="color: #0000ff; text-decoration-color: #0000ff">11</span>]                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">IndexError: </span>index <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span> is out of bounds for axis <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> with size <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>
</pre>
</div></div>
</div>
<p>However, raising an error from code running on an accelerator can be difficult or impossible. Therefore, JAX must choose some non-error behavior for out of bounds indexing (akin to how invalid floating point arithmetic results in <code class="docutils literal notranslate"><span class="pre">NaN</span></code>). When the indexing operation is an array index update (e.g. <code class="docutils literal notranslate"><span class="pre">index_add</span></code> or <code class="docutils literal notranslate"><span class="pre">scatter</span></code>-like primitives), updates at out-of-bounds indices will be skipped; when the operation is an array index retrieval (e.g. NumPy indexing or <code class="docutils literal notranslate"><span class="pre">gather</span></code>-like primitives) the index is clamped to the bounds of the array since <strong>something</strong> must be returned. For example, the last value of the array will be returned from this indexing operation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">9</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you would like finer-grained control over the behavior for out-of-bound indices, you can use the optional parameters of <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html"><code class="docutils literal notranslate"><span class="pre">ndarray.at</span></code></a>; for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">9</span>., <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">float32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span>nan, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">float32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that due to this behavior for index retrieval, functions like <code class="docutils literal notranslate"><span class="pre">jnp.nanargmin</span></code> and <code class="docutils literal notranslate"><span class="pre">jnp.nanargmax</span></code> return -1 for slices consisting of NaNs whereas Numpy would throw an error.</p>
<p>Note also that, as the two behaviors described above are not inverses of each other, reverse-mode automatic differentiation (which turns index updates into index retrievals and vice versa) <a class="reference external" href="https://github.com/google/jax/issues/5760">will not preserve the semantics of out of bounds indexing</a>. Thus it may be a good idea to think of out-of-bounds indexing in JAX as a case of <a class="reference external" href="https://en.wikipedia.org/wiki/Undefined_behavior">undefined behavior</a>.</p>
</section>
<section id="non-array-inputs-numpy-vs-jax">
<h2>🔪 Non-array inputs: NumPy vs. JAX<a class="headerlink" href="#non-array-inputs-numpy-vs-jax" title="Link to this heading">#</a></h2>
<p>NumPy is generally happy accepting Python lists or tuples as inputs to its API functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Cyan">6</span>
</pre></div>
</div>
</div>
</div>
<p>JAX departs from this, generally returning a helpful error:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 jnp.sum([<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">2</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">3</span>])                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">reductio</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">ns.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">226</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">sum</span>                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">223 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">sum</span>(a: ArrayLike, axis: Axis = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, dtype: DTypeLike | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>,                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">224 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>out: <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, keepdims: <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">False</span>, initial: ArrayLike | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>,        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">225 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>where: ArrayLike | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, promote_integers: <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) -&gt; Array:           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>226 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> _reduce_sum(a, axis=_ensure_optional_axes(axis), dtype=dtype, out=out,            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">227 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │    </span>keepdims=keepdims, initial=initial, where=where,                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">228 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │    </span>promote_integers=promote_integers)                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">229 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">298</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 295 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 296 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@api_boundary</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 297 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>(*args, **kwargs):                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 298 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 299 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>jit_info, *args, **kwargs)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 300 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>executable = _read_most_recent_pjit_call_executable(jaxpr)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 301 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>maybe_fastpath_data = _get_fastpath_data(                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">167</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>                                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 164 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 165 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>(jit_info, *args, **kwargs):                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>args_flat, _, params, _, out_tree, _, _, _, arg_names, attrs_tracked = \                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 167 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>_infer_params(jit_info, args, kwargs)                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args_flat:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 169 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dispatch.check_arg(arg)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 170 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">581</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_infer_params</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 578 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_shardings_treedef, in_shardings_leaves, hashable_pytree(in_layouts),             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 579 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_avals, in_tree, dbg, device_or_backend_set, have_kwargs)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 580 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 581 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, consts, out_shardings, out_layouts_flat, attrs_tracked = _pjit_jaxpr(            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 582 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>flat_fun, out_shardings_treedef, out_shardings_leaves,                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 583 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>hashable_pytree(out_layouts), in_type, dbg, device_or_backend_set,                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 584 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>HashableFunction(out_tree, closure=()),                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1202</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1199 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>(fun, out_shardings_treedef, out_shardings_leaves,                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1200 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_layouts_thunk, in_type, debug_info, device_or_backend_set,            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1201 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_tree, result_paths, inline):                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1202 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, final_consts, out_type, attrs_tracked = _create_pjit_jaxpr(                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1203 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, in_type, debug_info, result_paths, IgnoreKey(inline))                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1204 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>canonicalized_out_shardings_flat, out_layouts_flat = _check_and_canonicalize_out_shard  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1205 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>out_shardings_treedef, out_shardings_leaves, out_layouts_thunk, out_tree, <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>(ou  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">350</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">memoized_fun</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans, stores = result                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">348 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun.populate_stores(stores)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">349 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>350 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = call(fun, *args)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">351 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> explain <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> config.explain_cache_misses.value:                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">352 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>explain(fun.f, cache <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> new_cache, cache, key, ans)                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">353 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>cache[key] = (ans, fun.stores)                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1146</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_create_pjit_jaxpr</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1143 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>lu.annotate(fun, in_type), debug_info=pe_debug)                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1144 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>attrs_tracked = []                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1145 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1146 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>jaxpr, global_out_avals, consts, attrs_tracked = pe.trace_to_jaxpr_dynamic(         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1147 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>fun, in_type, debug_info=pe_debug)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1148 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1149 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(dougalm,mattjj): enable debug info with attrs_tracked</span>                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">profiler.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">33</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">5</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">332 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@wraps</span>(func)                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">333 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>(*args, **kwargs):                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">334 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> TraceAnnotation(name, **decorator_kwargs):                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>335 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> func(*args, **kwargs)                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">336 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">337 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">338 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2322</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_jaxpr_dynamic</span>                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2319 </span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Jaxpr, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[AbstractValue], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[Any], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[<span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Any, <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>]]]:                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> core.new_main(DynamicJaxprTrace, dynamic=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> main:  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2321 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>main.jaxpr_stack = ()  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2322 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, out_avals, consts, attrs_tracked = trace_to_subjaxpr_dynamic(                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2323 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, main, in_avals, keep_inputs=keep_inputs, debug_info=debug_info)                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2324 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> main, fun                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2325 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> jaxpr, out_avals, consts, attrs_tracked                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2344</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_subjaxpr_dynamic</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2341 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>trace = DynamicJaxprTrace(main, core.cur_sublevel())                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2342 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers = _input_type_to_tracers(trace.new_arg, in_avals)                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2343 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers_ = [t <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> t, keep <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(in_tracers, keep_inputs) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> keep]                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2344 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>ans = fun.call_wrapped(*in_tracers_)                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2345 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_tracers = <span style="color: #00ffff; text-decoration-color: #00ffff">map</span>(trace.full_raise, ans)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, consts, attrs_tracked = frame.to_jaxpr(out_tracers)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> fun, main, trace, frame, in_tracers, out_tracers, ans                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">192</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">call_wrapped</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">189 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>gen = gen_static_args = out_store = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">190 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">191 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>192 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = <span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.f(*args, **<span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.params, **kwargs))                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">193 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span>:                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">194 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Some transformations yield from inside context managers, so we have to</span>             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">195 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># interrupt them before reraising the exception. Otherwise they will only</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">reductio</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">ns.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">216</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_reduce_sum</span>                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">213 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out: <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, keepdims: <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">False</span>,                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">214 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>initial: ArrayLike | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, where: ArrayLike | <span style="color: #0000ff; text-decoration-color: #0000ff">None</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>,          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">215 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>promote_integers: <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span> = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) -&gt; Array:                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>216 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> _reduction(a, <span style="color: #808000; text-decoration-color: #808000">"sum"</span>, np.sum, lax.add, <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>, preproc=_cast_to_numeric,                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">217 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span>bool_op=lax.bitwise_or, upcast_f16_for_computation=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>,               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">218 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span>axis=axis, dtype=dtype, out=out, keepdims=keepdims,                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">219 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span>initial=initial, where_=where, parallel_reduce=lax.psum,               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">reductio</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">ns.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">86</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_reduction</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 83 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># exists, passing along all its arguments.</span>                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 84 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> out <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>:                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 85 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">NotImplementedError</span>(<span style="color: #808000; text-decoration-color: #808000">f"The 'out' argument to jnp.{</span>name<span style="color: #808000; text-decoration-color: #808000">} is not supported."</span>)       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 86 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>check_arraylike(name, a)                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 87 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes.check_user_dtype_supported(dtype, name)                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 88 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>axis = core.concrete_or_error(<span style="color: #0000ff; text-decoration-color: #0000ff">None</span>, axis, <span style="color: #808000; text-decoration-color: #808000">f"axis argument to jnp.{</span>name<span style="color: #808000; text-decoration-color: #808000">}()."</span>)             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 89 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">util.py</span>: <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">335</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">check_arraylike</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">332 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>warnings.warn(msg + <span style="color: #808000; text-decoration-color: #808000">" In a future JAX release this will be an error."</span>,               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">333 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │   </span>category=<span style="color: #00ffff; text-decoration-color: #00ffff">DeprecationWarning</span>, stacklevel=stacklevel)                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">334 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>335 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(msg.format(fun_name, <span style="color: #00ffff; text-decoration-color: #00ffff">type</span>(arg), pos))                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">336 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">337 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">338 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">check_arraylike_or_none</span>(fun_name: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>, *args: Any):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>sum requires ndarray or scalar arguments, got <span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">class</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'list'</span><span style="font-weight: bold">&gt;</span> at position <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>.
</pre>
</div></div>
</div>
<p>This is a deliberate design choice, because passing lists or tuples to traced functions can lead to silent performance degradation that might otherwise be difficult to detect.</p>
<p>For example, consider the following permissive version of <code class="docutils literal notranslate"><span class="pre">jnp.sum</span></code> that allows list inputs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">permissive_sum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">permissive_sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">45</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>The output is what we would expect, but this hides potential performance issues under the hood. In JAX’s tracing and JIT compilation model, each element in a Python list or tuple is treated as a separate JAX variable, and individually processed and pushed to device. This can be seen in the jaxpr for the <code class="docutils literal notranslate"><span class="pre">permissive_sum</span></code> function above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">make_jaxpr</span><span class="p">(</span><span class="n">permissive_sum</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">{</span> lambda ; a:i32<span class=" -Color -Color-Bold">[]</span> b:i32<span class=" -Color -Color-Bold">[]</span> c:i32<span class=" -Color -Color-Bold">[]</span> d:i32<span class=" -Color -Color-Bold">[]</span> e:i32<span class=" -Color -Color-Bold">[]</span> f:i32<span class=" -Color -Color-Bold">[]</span> g:i32<span class=" -Color -Color-Bold">[]</span> h:i32<span class=" -Color -Color-Bold">[]</span> i:i32<span class=" -Color -Color-Bold">[]</span>
    j:i32<span class=" -Color -Color-Bold">[]</span>. let
    k:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> a
    l:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> b
    m:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> c
    n:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> d
    o:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> e
    p:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> f
    q:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> g
    r:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> h
    s:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> i
    t:i32<span class=" -Color -Color-Bold">[]</span> = convert_element_type<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">new_dtype</span>=<span class=" -Color -Color-Magenta">int32</span> <span class=" -Color -Color-Yellow">weak_type</span>=False<span class=" -Color -Color-Bold">]</span> j
    u:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> k
    v:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> l
    w:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> m
    x:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> n
    y:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> o
    z:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> p
    ba:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> q
    bb:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> r
    bc:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> s
    bd:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span><span class=" -Color -Color-Bold">]</span> = broadcast_in_dim<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">broadcast_dimensions</span>=<span class=" -Color -Color-Bold">()</span> <span class=" -Color -Color-Yellow">shape</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">1</span>,<span class=" -Color -Color-Bold">)]</span> t
    be:i32<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">10</span><span class=" -Color -Color-Bold">]</span> = concatenate<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">dimension</span>=<span class=" -Color -Color-Bold -Color-Bold-Cyan">0</span><span class=" -Color -Color-Bold">]</span> u v w x y z ba bb bc bd
    bf:i32<span class=" -Color -Color-Bold">[]</span> = reduce_sum<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Yellow">axes</span>=<span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">0</span>,<span class=" -Color -Color-Bold">)]</span> be
  in <span class=" -Color -Color-Bold">(</span>bf,<span class=" -Color -Color-Bold">)</span> <span class=" -Color -Color-Bold">}</span>
</pre></div>
</div>
</div>
</div>
<p>Each entry of the list is handled as a separate input, resulting in a tracing &amp; compilation overhead that grows linearly with the size of the list. To prevent surprises like this, JAX avoids implicit conversions of lists and tuples to arrays.</p>
<p>If you would like to pass a tuple or list to a JAX function, you can do so by first explicitly converting it to an array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">45</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="random-numbers">
<h2>🔪 Random Numbers<a class="headerlink" href="#random-numbers" title="Link to this heading">#</a></h2>
<blockquote>
<div><p><em>If all scientific papers whose results are in doubt because of bad
<code class="docutils literal notranslate"><span class="pre">rand()</span></code>s were to disappear from library shelves, there would be a
gap on each shelf about as big as your fist.</em> - Numerical Recipes</p>
</div></blockquote>
<section id="rngs-and-state">
<h3>RNGs and State<a class="headerlink" href="#rngs-and-state" title="Link to this heading">#</a></h3>
<p>You’re used to <em>stateful</em> pseudorandom number generators (PRNGs) from numpy and other libraries, which helpfully hide a lot of details under the hood to give you a ready fountain of pseudorandomness:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.09298684448485517
0.1894044906292982
0.5030108108612741
</pre></div>
</div>
</div>
</div>
<p>Underneath the hood, numpy uses the <a class="reference external" href="https://en.wikipedia.org/wiki/Mersenne_Twister">Mersenne Twister</a> PRNG to power its pseudorandom functions.  The PRNG has a period of <span class="math notranslate nohighlight">\(2^{19937}-1\)</span> and at any point can be described by <strong>624 32-bit unsigned ints</strong> and a <strong>position</strong> indicating how much of this  “entropy” has been used up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1"># print(rng_state)</span>
<span class="c1"># --&gt; (&#39;MT19937&#39;, array([0, 1, 1812433255, 1900727105, 1208447044,</span>
<span class="c1">#       2481403966, 4042607538,  337614300, ... 614 more numbers...,</span>
<span class="c1">#       3048484911, 1796872496], dtype=uint32), 624, 0, 0.0)</span>
</pre></div>
</div>
</div>
</div>
<p>This pseudorandom state vector is automagically updated behind the scenes every time a random number is needed, “consuming” 2 of the uint32s in the Mersenne twister state vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1">#print(rng_state)</span>
<span class="c1"># --&gt; (&#39;MT19937&#39;, array([2443250962, 1093594115, 1878467924,</span>
<span class="c1">#       ..., 2648828502, 1678096082], dtype=uint32), 2, 0, 0.0)</span>

<span class="c1"># Let&#39;s exhaust the entropy in this PRNG statevector</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">311</span><span class="p">):</span>
  <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1">#print(rng_state)</span>
<span class="c1"># --&gt; (&#39;MT19937&#39;, array([2443250962, 1093594115, 1878467924,</span>
<span class="c1">#       ..., 2648828502, 1678096082], dtype=uint32), 624, 0, 0.0)</span>

<span class="c1"># Next call iterates the RNG state for a new batch of fake &quot;entropy&quot;.</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1"># print(rng_state)</span>
<span class="c1"># --&gt; (&#39;MT19937&#39;, array([1499117434, 2949980591, 2242547484,</span>
<span class="c1">#      4162027047, 3277342478], dtype=uint32), 2, 0, 0.0)</span>
</pre></div>
</div>
</div>
</div>
<p>The problem with magic PRNG state is that it’s hard to reason about how it’s being used and updated across different threads, processes, and devices, and it’s <em>very easy</em> to screw up when the details of entropy production and consumption are hidden from the end user.</p>
<p>The Mersenne Twister PRNG is also known to have a <a class="reference external" href="https://cs.stackexchange.com/a/53475">number</a> of problems, it has a large 2.5kB state size, which leads to problematic <a class="reference external" href="https://dl.acm.org/citation.cfm?id=1276928">initialization issues</a>.  It <a class="reference external" href="http://www.pcg-random.org/pdf/toms-oneill-pcg-family-v1.02.pdf">fails</a> modern BigCrush tests, and is generally slow.</p>
</section>
<section id="jax-prng">
<h3>JAX PRNG<a class="headerlink" href="#jax-prng" title="Link to this heading">#</a></h3>
<p>JAX instead implements an <em>explicit</em> PRNG where entropy production and consumption are handled by explicitly passing and iterating PRNG state.  JAX uses a modern <a class="reference external" href="https://github.com/google/jax/blob/main/docs/jep/263-prng.md">Threefry counter-based PRNG</a> that’s <strong>splittable</strong>.  That is, its design allows us to <strong>fork</strong> the PRNG state into new PRNGs for use with parallel stochastic generation.</p>
<p>The random state is described by a special array element that we call a <strong>key</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">key</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(()</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">key</span><span class=" -Color -Color-Bold">&lt;fry&gt;)</span> overlaying:
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">0</span> <span class=" -Color -Color-Bold -Color-Bold-Cyan">0</span><span class=" -Color -Color-Bold">]</span>
</pre></div>
</div>
</div>
</div>
<p>JAX’s random functions produce pseudorandom numbers from the PRNG state, but <strong>do not</strong> change the state!</p>
<p>Reusing the same state will cause <strong>sadness</strong> and <strong>monotony</strong>, depriving the end user of <strong>lifegiving chaos</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="c1"># No no no!</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.20584226]
Array((), dtype=key&lt;fry&gt;) overlaying:
[0 0]
[-0.20584226]
Array((), dtype=key&lt;fry&gt;) overlaying:
[0 0]
</pre></div>
</div>
</div>
</div>
<p>Instead, we <strong>split</strong> the PRNG to get usable <strong>subkeys</strong> every time we need a new pseudorandom number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;old key&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">normal_pseudorandom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    \---SPLIT --&gt; new key   &quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             \--&gt; new subkey&quot;</span><span class="p">,</span> <span class="n">subkey</span><span class="p">,</span> <span class="s2">&quot;--&gt; normal&quot;</span><span class="p">,</span> <span class="n">normal_pseudorandom</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>old key Array((), dtype=key&lt;fry&gt;) overlaying:
[0 0]
    \---SPLIT --&gt; new key    Array((), dtype=key&lt;fry&gt;) overlaying:
[4146024105  967050713]
             \--&gt; new subkey Array((), dtype=key&lt;fry&gt;) overlaying:
[2718843009 1272950319] --&gt; normal [-1.2515389]
</pre></div>
</div>
</div>
</div>
<p>We propagate the <strong>key</strong> and make new <strong>subkeys</strong> whenever we need a new random number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;old key&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">normal_pseudorandom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    \---SPLIT --&gt; new key   &quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             \--&gt; new subkey&quot;</span><span class="p">,</span> <span class="n">subkey</span><span class="p">,</span> <span class="s2">&quot;--&gt; normal&quot;</span><span class="p">,</span> <span class="n">normal_pseudorandom</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>old key Array((), dtype=key&lt;fry&gt;) overlaying:
[4146024105  967050713]
    \---SPLIT --&gt; new key    Array((), dtype=key&lt;fry&gt;) overlaying:
[2384771982 3928867769]
             \--&gt; new subkey Array((), dtype=key&lt;fry&gt;) overlaying:
[1278412471 2182328957] --&gt; normal [-0.58665055]
</pre></div>
</div>
</div>
</div>
<p>We can generate more than one <strong>subkey</strong> at a time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">subkeys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="n">subkeys</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.37533438]
[0.98645043]
[0.14553197]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="control-flow">
<h2>🔪 Control Flow<a class="headerlink" href="#control-flow" title="Link to this heading">#</a></h2>
<section id="python-control-flow-autodiff">
<h3>✔ python control_flow + autodiff ✔<a class="headerlink" href="#python-control-flow-autodiff" title="Link to this heading">#</a></h3>
<p>If you just want to apply <code class="docutils literal notranslate"><span class="pre">grad</span></code> to your python functions, you can use regular python control-flow constructs with no problems, as if you were using <a class="reference external" href="https://github.com/hips/autograd">Autograd</a> (or Pytorch or TF Eager).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">))</span>  <span class="c1"># ok!</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>  <span class="c1"># ok!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
-4.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="python-control-flow-jit">
<h3>python control flow + JIT<a class="headerlink" href="#python-control-flow-jit" title="Link to this heading">#</a></h3>
<p>Using control flow with <code class="docutils literal notranslate"><span class="pre">jit</span></code> is more complicated, and by default it has more constraints.</p>
<p>This works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<p>So does this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.0
</pre></div>
</div>
</div>
</div>
<p>But this doesn’t, at least by default:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># This will fail!</span>
<span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">9</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> -<span style="color: #0000ff; text-decoration-color: #0000ff">4</span> * x                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 7 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 8 # This will fail!</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 9 f(<span style="color: #0000ff; text-decoration-color: #0000ff">2</span>)                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">10 </span>                                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">298</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 295 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 296 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@api_boundary</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 297 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>(*args, **kwargs):                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 298 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 299 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>jit_info, *args, **kwargs)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 300 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>executable = _read_most_recent_pjit_call_executable(jaxpr)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 301 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>maybe_fastpath_data = _get_fastpath_data(                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">167</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>                                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 164 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 165 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>(jit_info, *args, **kwargs):                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>args_flat, _, params, _, out_tree, _, _, _, arg_names, attrs_tracked = \                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 167 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>_infer_params(jit_info, args, kwargs)                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args_flat:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 169 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dispatch.check_arg(arg)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 170 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">581</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_infer_params</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 578 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_shardings_treedef, in_shardings_leaves, hashable_pytree(in_layouts),             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 579 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_avals, in_tree, dbg, device_or_backend_set, have_kwargs)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 580 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 581 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, consts, out_shardings, out_layouts_flat, attrs_tracked = _pjit_jaxpr(            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 582 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>flat_fun, out_shardings_treedef, out_shardings_leaves,                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 583 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>hashable_pytree(out_layouts), in_type, dbg, device_or_backend_set,                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 584 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>HashableFunction(out_tree, closure=()),                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1202</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1199 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>(fun, out_shardings_treedef, out_shardings_leaves,                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1200 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_layouts_thunk, in_type, debug_info, device_or_backend_set,            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1201 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_tree, result_paths, inline):                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1202 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, final_consts, out_type, attrs_tracked = _create_pjit_jaxpr(                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1203 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, in_type, debug_info, result_paths, IgnoreKey(inline))                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1204 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>canonicalized_out_shardings_flat, out_layouts_flat = _check_and_canonicalize_out_shard  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1205 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>out_shardings_treedef, out_shardings_leaves, out_layouts_thunk, out_tree, <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>(ou  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">350</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">memoized_fun</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans, stores = result                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">348 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun.populate_stores(stores)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">349 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>350 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = call(fun, *args)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">351 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> explain <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> config.explain_cache_misses.value:                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">352 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>explain(fun.f, cache <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> new_cache, cache, key, ans)                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">353 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>cache[key] = (ans, fun.stores)                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1146</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_create_pjit_jaxpr</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1143 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>lu.annotate(fun, in_type), debug_info=pe_debug)                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1144 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>attrs_tracked = []                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1145 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1146 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>jaxpr, global_out_avals, consts, attrs_tracked = pe.trace_to_jaxpr_dynamic(         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1147 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>fun, in_type, debug_info=pe_debug)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1148 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1149 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(dougalm,mattjj): enable debug info with attrs_tracked</span>                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">profiler.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">33</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">5</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">332 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@wraps</span>(func)                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">333 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>(*args, **kwargs):                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">334 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> TraceAnnotation(name, **decorator_kwargs):                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>335 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> func(*args, **kwargs)                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">336 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">337 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">338 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2322</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_jaxpr_dynamic</span>                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2319 </span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Jaxpr, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[AbstractValue], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[Any], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[<span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Any, <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>]]]:                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> core.new_main(DynamicJaxprTrace, dynamic=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> main:  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2321 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>main.jaxpr_stack = ()  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2322 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, out_avals, consts, attrs_tracked = trace_to_subjaxpr_dynamic(                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2323 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, main, in_avals, keep_inputs=keep_inputs, debug_info=debug_info)                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2324 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> main, fun                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2325 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> jaxpr, out_avals, consts, attrs_tracked                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2344</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_subjaxpr_dynamic</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2341 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>trace = DynamicJaxprTrace(main, core.cur_sublevel())                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2342 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers = _input_type_to_tracers(trace.new_arg, in_avals)                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2343 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers_ = [t <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> t, keep <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(in_tracers, keep_inputs) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> keep]                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2344 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>ans = fun.call_wrapped(*in_tracers_)                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2345 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_tracers = <span style="color: #00ffff; text-decoration-color: #00ffff">map</span>(trace.full_raise, ans)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, consts, attrs_tracked = frame.to_jaxpr(out_tracers)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> fun, main, trace, frame, in_tracers, out_tracers, ans                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">192</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">call_wrapped</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">189 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>gen = gen_static_args = out_store = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">190 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">191 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>192 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = <span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.f(*args, **<span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.params, **kwargs))                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">193 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span>:                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">194 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Some transformations yield from inside context managers, so we have to</span>             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">195 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># interrupt them before reraising the exception. Otherwise they will only</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">f</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 1 </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@jit</span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 2 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">f</span>(x):                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 3 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> x &lt; <span style="color: #0000ff; text-decoration-color: #0000ff">3</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 4 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> <span style="color: #0000ff; text-decoration-color: #0000ff">3.</span> * x ** <span style="color: #0000ff; text-decoration-color: #0000ff">2</span>                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 5 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 6 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> -<span style="color: #0000ff; text-decoration-color: #0000ff">4</span> * x                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">core.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">746</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">__bool__</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 743 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 744 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">__bool__</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>):                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 745 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>check_bool_conversion(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>)                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 746 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> <span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.aval._bool(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 747 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 748 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">__int__</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>):                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 749 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>check_scalar_conversion(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>)                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">core.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1492</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">error</span>                                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1489 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   │     </span><span style="color: #808000; text-decoration-color: #808000">f"or `jnp.array(x, {</span>fun.<span style="color: #ff0000; text-decoration-color: #ff0000">__name__</span><span style="color: #808000; text-decoration-color: #808000">})` instead."</span>)                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1490 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> fun <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> <span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>:                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1491 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">error</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, arg):                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1492 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> TracerBoolConversionError(arg)                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1493 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">elif</span> fun <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> (<span style="color: #00ffff; text-decoration-color: #00ffff">hex</span>, <span style="color: #00ffff; text-decoration-color: #00ffff">oct</span>, operator.index):                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1494 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">error</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, arg):                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1495 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> TracerIntegerConversionError(arg)                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TracerBoolConversionError: </span>Attempted boolean conversion of traced array with shape bool<span style="font-weight: bold">[]</span>..
The error occurred while tracing the function f at <span style="color: #800080; text-decoration-color: #800080">/tmp/ipykernel_11740/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">3402096563.py</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> for jit. This concrete 
value was not available in Python because it depends on the value of the argument x.
See <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError</span>
</pre>
</div></div>
</div>
<p><strong>What gives!?</strong></p>
<p>When we <code class="docutils literal notranslate"><span class="pre">jit</span></code>-compile a function, we usually want to compile a version of the function that works for many different argument values, so that we can cache and reuse the compiled code. That way we don’t have to re-compile on each function evaluation.</p>
<p>For example, if we evaluate an <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> function on the array <code class="docutils literal notranslate"><span class="pre">jnp.array([1.,</span> <span class="pre">2.,</span> <span class="pre">3.],</span> <span class="pre">jnp.float32)</span></code>, we might want to compile code that we can reuse to evaluate the function on <code class="docutils literal notranslate"><span class="pre">jnp.array([4.,</span> <span class="pre">5.,</span> <span class="pre">6.],</span> <span class="pre">jnp.float32)</span></code> to save on compile time.</p>
<p>To get a view of your Python code that is valid for many different argument values, JAX traces it on <em>abstract values</em> that represent sets of possible inputs. There are <a class="reference external" href="https://github.com/google/jax/blob/main/jax/_src/abstract_arrays.py">multiple different levels of abstraction</a>, and different transformations use different abstraction levels.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">jit</span></code> traces your code on the <code class="docutils literal notranslate"><span class="pre">ShapedArray</span></code> abstraction level, where each abstract value represents the set of all array values with a fixed shape and dtype. For example, if we trace using the abstract value <code class="docutils literal notranslate"><span class="pre">ShapedArray((3,),</span> <span class="pre">jnp.float32)</span></code>, we get a view of the function that can be reused for any concrete value in the corresponding set of arrays. That means we can save on compile time.</p>
<p>But there’s a tradeoff here: if we trace a Python function on a <code class="docutils literal notranslate"><span class="pre">ShapedArray((),</span> <span class="pre">jnp.float32)</span></code> that isn’t committed to a specific concrete value, when we hit a line like <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">3</span></code>, the expression <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">3</span></code> evaluates to an abstract <code class="docutils literal notranslate"><span class="pre">ShapedArray((),</span> <span class="pre">jnp.bool_)</span></code> that represents the set <code class="docutils literal notranslate"><span class="pre">{True,</span> <span class="pre">False}</span></code>. When Python attempts to coerce that to a concrete <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>, we get an error: we don’t know which branch to take, and can’t continue tracing! The tradeoff is that with higher levels of abstraction we gain a more general view of the Python code (and thus save on re-compilations), but we require more constraints on the Python code to complete the trace.</p>
<p>The good news is that you can control this tradeoff yourself. By having <code class="docutils literal notranslate"><span class="pre">jit</span></code> trace on more refined abstract values, you can relax the traceability constraints. For example, using the <code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> argument to <code class="docutils literal notranslate"><span class="pre">jit</span></code>, we can specify to trace on concrete values of some arguments. Here’s that example function again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
</pre></div>
</div>
</div>
</div>
<p>Here’s another example, this time involving a loop:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">y</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

<span class="n">f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">5</span>., <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">float32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>In effect, the loop gets statically unrolled.  JAX can also trace at <em>higher</em> levels of abstraction, like <code class="docutils literal notranslate"><span class="pre">Unshaped</span></code>, but that’s not currently the default for any transformation</p>
<p>️⚠️ <strong>functions with argument-<strong>value</strong> dependent shapes</strong></p>
<p>These control-flow issues also come up in a more subtle way: numerical functions we want to <strong>jit</strong> can’t specialize the shapes of internal arrays on argument <em>values</em> (specializing on argument <strong>shapes</strong> is ok).  As a trivial example, let’s make a function whose output happens to depend on the input variable <code class="docutils literal notranslate"><span class="pre">length</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">example_fun</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">length</span><span class="p">,))</span> <span class="o">*</span> <span class="n">val</span>
<span class="c1"># un-jit&#39;d works fine</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example_fun</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4. 4. 4. 4. 4.]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_example_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">example_fun</span><span class="p">)</span>
<span class="c1"># this will fail:</span>
<span class="n">bad_example_jit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1 </span>bad_example_jit = jit(example_fun)                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 # this will fail:</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>3 bad_example_jit(<span style="color: #0000ff; text-decoration-color: #0000ff">10</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">4</span>)                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">298</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 295 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 296 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@api_boundary</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 297 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>(*args, **kwargs):                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 298 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 299 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>jit_info, *args, **kwargs)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 300 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>executable = _read_most_recent_pjit_call_executable(jaxpr)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 301 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>maybe_fastpath_data = _get_fastpath_data(                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">167</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>                                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 164 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 165 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>(jit_info, *args, **kwargs):                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>args_flat, _, params, _, out_tree, _, _, _, arg_names, attrs_tracked = \                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 167 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>_infer_params(jit_info, args, kwargs)                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args_flat:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 169 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dispatch.check_arg(arg)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 170 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">581</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_infer_params</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 578 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_shardings_treedef, in_shardings_leaves, hashable_pytree(in_layouts),             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 579 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_avals, in_tree, dbg, device_or_backend_set, have_kwargs)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 580 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 581 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, consts, out_shardings, out_layouts_flat, attrs_tracked = _pjit_jaxpr(            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 582 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>flat_fun, out_shardings_treedef, out_shardings_leaves,                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 583 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>hashable_pytree(out_layouts), in_type, dbg, device_or_backend_set,                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 584 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>HashableFunction(out_tree, closure=()),                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1202</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1199 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>(fun, out_shardings_treedef, out_shardings_leaves,                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1200 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_layouts_thunk, in_type, debug_info, device_or_backend_set,            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1201 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_tree, result_paths, inline):                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1202 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, final_consts, out_type, attrs_tracked = _create_pjit_jaxpr(                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1203 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, in_type, debug_info, result_paths, IgnoreKey(inline))                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1204 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>canonicalized_out_shardings_flat, out_layouts_flat = _check_and_canonicalize_out_shard  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1205 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>out_shardings_treedef, out_shardings_leaves, out_layouts_thunk, out_tree, <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>(ou  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">350</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">memoized_fun</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans, stores = result                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">348 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun.populate_stores(stores)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">349 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>350 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = call(fun, *args)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">351 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> explain <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> config.explain_cache_misses.value:                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">352 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>explain(fun.f, cache <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> new_cache, cache, key, ans)                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">353 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>cache[key] = (ans, fun.stores)                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1146</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_create_pjit_jaxpr</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1143 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>lu.annotate(fun, in_type), debug_info=pe_debug)                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1144 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>attrs_tracked = []                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1145 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1146 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>jaxpr, global_out_avals, consts, attrs_tracked = pe.trace_to_jaxpr_dynamic(         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1147 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>fun, in_type, debug_info=pe_debug)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1148 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1149 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(dougalm,mattjj): enable debug info with attrs_tracked</span>                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">profiler.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">33</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">5</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">332 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@wraps</span>(func)                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">333 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>(*args, **kwargs):                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">334 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> TraceAnnotation(name, **decorator_kwargs):                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>335 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> func(*args, **kwargs)                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">336 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">337 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">338 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2322</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_jaxpr_dynamic</span>                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2319 </span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Jaxpr, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[AbstractValue], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[Any], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[<span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Any, <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>]]]:                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> core.new_main(DynamicJaxprTrace, dynamic=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> main:  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2321 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>main.jaxpr_stack = ()  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2322 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, out_avals, consts, attrs_tracked = trace_to_subjaxpr_dynamic(                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2323 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, main, in_avals, keep_inputs=keep_inputs, debug_info=debug_info)                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2324 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> main, fun                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2325 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> jaxpr, out_avals, consts, attrs_tracked                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2344</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_subjaxpr_dynamic</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2341 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>trace = DynamicJaxprTrace(main, core.cur_sublevel())                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2342 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers = _input_type_to_tracers(trace.new_arg, in_avals)                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2343 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers_ = [t <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> t, keep <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(in_tracers, keep_inputs) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> keep]                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2344 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>ans = fun.call_wrapped(*in_tracers_)                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2345 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_tracers = <span style="color: #00ffff; text-decoration-color: #00ffff">map</span>(trace.full_raise, ans)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, consts, attrs_tracked = frame.to_jaxpr(out_tracers)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> fun, main, trace, frame, in_tracers, out_tracers, ans                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">192</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">call_wrapped</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">189 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>gen = gen_static_args = out_store = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">190 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">191 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>192 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = <span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.f(*args, **<span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.params, **kwargs))                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">193 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span>:                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">194 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Some transformations yield from inside context managers, so we have to</span>             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">195 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># interrupt them before reraising the exception. Otherwise they will only</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">example_fun</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2</span>                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">example_fun</span>(length, val):                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> jnp.ones((length,)) * val                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">3 # un-jit'd works fine</span>                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4 </span><span style="color: #00ffff; text-decoration-color: #00ffff">print</span>(example_fun(<span style="color: #0000ff; text-decoration-color: #0000ff">5</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">4</span>))                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">5 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2349</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">ones</span>                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #00ffff; text-decoration-color: #00ffff">isinstance</span>(shape, types.GeneratorType):                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(<span style="color: #808000; text-decoration-color: #808000">"expected sequence object with len &gt;= 0 or a single integer"</span>)         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2348 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> (m := _check_forgot_shape_tuple(<span style="color: #808000; text-decoration-color: #808000">"ones"</span>, shape, dtype)): <span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>(m)           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2349 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>shape = canonicalize_shape(shape)                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2350 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dtypes.check_user_dtype_supported(dtype, <span style="color: #808000; text-decoration-color: #808000">"ones"</span>)                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2351 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> lax.full(shape, <span style="color: #0000ff; text-decoration-color: #0000ff">1</span>, _jnp_dtype(dtype), sharding=_normalize_to_sharding(device))   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2352 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">86</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">canonicalize_shape</span>                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  83 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>(<span style="color: #00ffff; text-decoration-color: #00ffff">getattr</span>(shape, <span style="color: #808000; text-decoration-color: #808000">'ndim'</span>, <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>) == <span style="color: #0000ff; text-decoration-color: #0000ff">0</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> ndim(shape) == <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>)):                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  84 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> core.canonicalize_shape((shape,), context)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  85 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>  86 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> core.canonicalize_shape(shape, context)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  87 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  88 # Common docstring additions:</span>                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  89 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">core.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2142</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">canonicalize_shape</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2139 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>(unsafe_map(_canonicalize_dimension, shape))                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2140 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">TypeError</span>:                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2141 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">pass</span>                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2142 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> _invalid_shape_error(shape, context)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2143 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2144 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">canonicalize_dim</span>(d: DimSize, context: <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>=<span style="color: #808000; text-decoration-color: #808000">""</span>) -&gt; DimSize:                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2145 </span><span style="color: #bfbfbf; text-decoration-color: #bfbfbf">  </span><span style="color: #808000; text-decoration-color: #808000">"""Canonicalizes and checks for errors in a user-provided shape dimension value.</span>        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">TypeError: </span>Shapes must be 1D sequences of concrete values of integer type, got <span style="font-weight: bold">(</span>Traced<span style="font-weight: bold">&lt;</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">ShapedArray</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">(</span><span style="color: #000000; text-decoration-color: #000000">int32</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">[]</span><span style="color: #000000; text-decoration-color: #000000">, </span>
<span style="color: #808000; text-decoration-color: #808000">weak_type</span><span style="color: #000000; text-decoration-color: #000000">=</span><span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">)</span><span style="color: #000000; text-decoration-color: #000000">&gt;with&lt;</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">DynamicJaxprTrace</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">(</span><span style="color: #808000; text-decoration-color: #808000">level</span><span style="color: #000000; text-decoration-color: #000000">=</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="color: #000000; text-decoration-color: #000000">/</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">)</span><span style="font-weight: bold">&gt;</span>,<span style="font-weight: bold">)</span>.
If using `jit`, try using `static_argnums` or applying `jit` to smaller subfunctions.
The error occurred while tracing the function example_fun at <span style="color: #800080; text-decoration-color: #800080">/tmp/ipykernel_11740/</span><span style="color: #ff00ff; text-decoration-color: #ff00ff">1210496444.py</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> for jit. This 
concrete value was not available in Python because it depends on the value of the argument length.
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># static_argnums tells JAX to recompile on changes at these argument positions:</span>
<span class="n">good_example_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">example_fun</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="c1"># first compile</span>
<span class="nb">print</span><span class="p">(</span><span class="n">good_example_jit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1"># recompiles</span>
<span class="nb">print</span><span class="p">(</span><span class="n">good_example_jit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4. 4. 4. 4. 4. 4. 4. 4. 4. 4.]
[4. 4. 4. 4. 4.]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> can be handy if <code class="docutils literal notranslate"><span class="pre">length</span></code> in our example rarely changes, but it would be disastrous if it changed a lot!</p>
<p>Lastly, if your function has global side-effects, JAX’s tracer can cause weird things to happen. A common gotcha is trying to print arrays inside <strong>jit</strong>’d functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span>
<span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=1/0)&gt;
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">4</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span>, <span class=" -Color -Color-Yellow">weak_type</span>=True<span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="structured-control-flow-primitives">
<h3>Structured control flow primitives<a class="headerlink" href="#structured-control-flow-primitives" title="Link to this heading">#</a></h3>
<p>There are more options for control flow in JAX. Say you want to avoid re-compilations but still want to use control flow that’s traceable, and that avoids un-rolling large loops. Then you can use these 4 structured control flow primitives:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lax.cond</span></code>  <em>differentiable</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.while_loop</span></code> <strong>fwd-mode-differentiable</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.fori_loop</span></code> <strong>fwd-mode-differentiable</strong> in general; <strong>fwd and rev-mode differentiable</strong> if endpoints are static.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.scan</span></code> <em>differentiable</em></p></li>
</ul>
<section id="cond">
<h4><code class="docutils literal notranslate"><span class="pre">cond</span></code><a class="headerlink" href="#cond" title="Link to this heading">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true_fun</span><span class="p">,</span> <span class="n">false_fun</span><span class="p">,</span> <span class="n">operand</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">true_fun</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">false_fun</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>

<span class="n">operand</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
<span class="c1"># --&gt; array([1.], dtype=float32)</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
<span class="c1"># --&gt; array([-1.], dtype=float32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">([</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">-1</span>.<span class=" -Color -Color-Bold">]</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">float32</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> provides two other functions that allow branching on dynamic predicates:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.select.html"><code class="docutils literal notranslate"><span class="pre">lax.select</span></code></a> is
like a batched version of <code class="docutils literal notranslate"><span class="pre">lax.cond</span></code>, with the choices expressed as pre-computed arrays
rather than as functions.</p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.switch.html"><code class="docutils literal notranslate"><span class="pre">lax.switch</span></code></a> is
like <code class="docutils literal notranslate"><span class="pre">lax.cond</span></code>, but allows switching between any number of callable choices.</p></li>
</ul>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> provides several numpy-style interfaces to these functions:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.where.html"><code class="docutils literal notranslate"><span class="pre">jnp.where</span></code></a> with
three arguments is the numpy-style wrapper of <code class="docutils literal notranslate"><span class="pre">lax.select</span></code>.</p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.piecewise.html"><code class="docutils literal notranslate"><span class="pre">jnp.piecewise</span></code></a>
is a numpy-style wrapper of <code class="docutils literal notranslate"><span class="pre">lax.switch</span></code>, but switches on a list of boolean conditions rather than a single scalar index.</p></li>
<li><p><a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.select.html"><code class="docutils literal notranslate"><span class="pre">jnp.select</span></code></a> has
an API similar to <code class="docutils literal notranslate"><span class="pre">jnp.piecewise</span></code>, but the choices are given as pre-computed arrays rather
than as functions. It is implemented in terms of multiple calls to <code class="docutils literal notranslate"><span class="pre">lax.select</span></code>.</p></li>
</ul>
</section>
<section id="while-loop">
<h4><code class="docutils literal notranslate"><span class="pre">while_loop</span></code><a class="headerlink" href="#while-loop" title="Link to this heading">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">init_val</span>
  <span class="k">while</span> <span class="n">cond_fun</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">body_fun</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_val</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cond_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">&lt;</span><span class="mi">10</span>
<span class="n">body_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
<span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
<span class="c1"># --&gt; array(10, dtype=int32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">10</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span>, <span class=" -Color -Color-Yellow">weak_type</span>=True<span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fori-loop">
<h4><code class="docutils literal notranslate"><span class="pre">fori_loop</span></code><a class="headerlink" href="#fori-loop" title="Link to this heading">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fori_loop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">init_val</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">body_fun</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_val</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stop</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">body_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">i</span>
<span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
<span class="c1"># --&gt; array(45, dtype=int32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">Array</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Bold -Color-Bold-Cyan">45</span>, <span class=" -Color -Color-Yellow">dtype</span>=<span class=" -Color -Color-Magenta">int32</span>, <span class=" -Color -Color-Yellow">weak_type</span>=True<span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array} {r|rr}
\hline \
\textrm{construct}
&amp; \textrm{jit}
&amp; \textrm{grad} \\
\hline \
\textrm{if} &amp; ❌ &amp; ✔ \\
\textrm{for} &amp; ✔* &amp; ✔\\
\textrm{while} &amp; ✔* &amp; ✔\\
\textrm{lax.cond} &amp; ✔ &amp; ✔\\
\textrm{lax.while_loop} &amp; ✔ &amp; \textrm{fwd}\\
\textrm{lax.fori_loop} &amp; ✔ &amp; \textrm{fwd}\\
\textrm{lax.scan} &amp; ✔ &amp; ✔\\
\hline
\end{array}
\end{split}\]</div>
<center>
<p><span class="math notranslate nohighlight">\(\ast\)</span> = argument-<b>value</b>-independent loop condition - unrolls the loop</p>
</center></section>
</section>
</section>
<section id="dynamic-shapes">
<h2>🔪 Dynamic Shapes<a class="headerlink" href="#dynamic-shapes" title="Link to this heading">#</a></h2>
<p>JAX code used within transforms like <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code>, <code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code>, <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code>, etc. requires all output arrays and intermediate arrays to have static shape: that is, the shape cannot depend on values within other arrays.</p>
<p>For example, if you were implementing your own version of <code class="docutils literal notranslate"><span class="pre">jnp.nansum</span></code>, you might start with something like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nansum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># boolean mask selecting non-nan values</span>
  <span class="n">x_without_nans</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">x_without_nans</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Outside JIT and other transforms, this works as expected:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nansum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.0
</pre></div>
</div>
</div>
</div>
<p>If you attempt to apply <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code> or another transform to this function, it will error:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nansum</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800000; text-decoration-color: #800000">╭─────────────────────────────── </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">Traceback </span><span style="color: #bf7f7f; text-decoration-color: #bf7f7f; font-weight: bold">(most recent call last)</span><span style="color: #800000; text-decoration-color: #800000"> ────────────────────────────────╮</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">&lt;module&gt;</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1 jax.jit(nansum)(x)                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">traceback_util</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">179</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">176 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">reraise_with_filtered_traceback</span>(*args, **kwargs):                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">177 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>__tracebackhide__ = <span style="color: #0000ff; text-decoration-color: #0000ff">True</span>                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">178 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>179 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> fun(*args, **kwargs)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">180 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span> <span style="color: #00ffff; text-decoration-color: #00ffff">Exception</span> <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> e:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">181 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>mode = _filtering_mode()                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">182 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> _is_under_reraiser(e) <span style="color: #ff00ff; text-decoration-color: #ff00ff">or</span> mode == <span style="color: #808000; text-decoration-color: #808000">"off"</span>:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">298</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 295 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 296 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@api_boundary</span>                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 297 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">cache_miss</span>(*args, **kwargs):                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 298 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>outs, out_flat, out_tree, args_flat, jaxpr, attrs_tracked = _python_pjit_helper(      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 299 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>jit_info, *args, **kwargs)                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 300 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>executable = _read_most_recent_pjit_call_executable(jaxpr)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 301 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>maybe_fastpath_data = _get_fastpath_data(                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">167</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>                                                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 164 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 165 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_python_pjit_helper</span>(jit_info, *args, **kwargs):                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 166 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>args_flat, _, params, _, out_tree, _, _, _, arg_names, attrs_tracked = \                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 167 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>_infer_params(jit_info, args, kwargs)                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 168 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">for</span> arg <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> args_flat:                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 169 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>dispatch.check_arg(arg)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 170 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">581</span> in <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_infer_params</span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 578 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_shardings_treedef, in_shardings_leaves, hashable_pytree(in_layouts),             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 579 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>in_avals, in_tree, dbg, device_or_backend_set, have_kwargs)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 580 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span> 581 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, consts, out_shardings, out_layouts_flat, attrs_tracked = _pjit_jaxpr(            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 582 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>flat_fun, out_shardings_treedef, out_shardings_leaves,                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 583 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>hashable_pytree(out_layouts), in_type, dbg, device_or_backend_set,                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"> 584 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>HashableFunction(out_tree, closure=()),                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1202</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1199 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_pjit_jaxpr</span>(fun, out_shardings_treedef, out_shardings_leaves,                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1200 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_layouts_thunk, in_type, debug_info, device_or_backend_set,            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1201 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │   </span>out_tree, result_paths, inline):                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1202 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>jaxpr, final_consts, out_type, attrs_tracked = _create_pjit_jaxpr(                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1203 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, in_type, debug_info, result_paths, IgnoreKey(inline))                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1204 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>canonicalized_out_shardings_flat, out_layouts_flat = _check_and_canonicalize_out_shard  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1205 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>out_shardings_treedef, out_shardings_leaves, out_layouts_thunk, out_tree, <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>(ou  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">350</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">memoized_fun</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans, stores = result                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">348 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun.populate_stores(stores)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">349 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>350 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = call(fun, *args)                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">351 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> explain <span style="color: #ff00ff; text-decoration-color: #ff00ff">and</span> config.explain_cache_misses.value:                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">352 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>explain(fun.f, cache <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> new_cache, cache, key, ans)                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">353 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>cache[key] = (ans, fun.stores)                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">pjit.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">1146</span>   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_create_pjit_jaxpr</span>                                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1143 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>lu.annotate(fun, in_type), debug_info=pe_debug)                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1144 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>attrs_tracked = []                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1145 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>1146 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>jaxpr, global_out_avals, consts, attrs_tracked = pe.trace_to_jaxpr_dynamic(         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1147 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span>fun, in_type, debug_info=pe_debug)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1148 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1149 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(dougalm,mattjj): enable debug info with attrs_tracked</span>                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">profiler.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">33</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #0000ff; text-decoration-color: #0000ff">5</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>                                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">332 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">@wraps</span>(func)                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">333 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">wrapper</span>(*args, **kwargs):                                                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">334 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> TraceAnnotation(name, **decorator_kwargs):                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>335 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> func(*args, **kwargs)                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">336 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">337 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> wrapper                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">338 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2322</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_jaxpr_dynamic</span>                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2319 </span>) -&gt; <span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Jaxpr, <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[AbstractValue], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[Any], <span style="color: #00ffff; text-decoration-color: #00ffff">list</span>[<span style="color: #00ffff; text-decoration-color: #00ffff">tuple</span>[Any, <span style="color: #00ffff; text-decoration-color: #00ffff">str</span>]]]:                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2320 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">with</span> core.new_main(DynamicJaxprTrace, dynamic=<span style="color: #0000ff; text-decoration-color: #0000ff">True</span>) <span style="color: #0000ff; text-decoration-color: #0000ff">as</span> main:  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2321 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>main.jaxpr_stack = ()  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># type: ignore</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2322 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, out_avals, consts, attrs_tracked = trace_to_subjaxpr_dynamic(                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2323 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>fun, main, in_avals, keep_inputs=keep_inputs, debug_info=debug_info)                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2324 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> main, fun                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2325 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> jaxpr, out_avals, consts, attrs_tracked                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/interpreters/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">p</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">artial_eval.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">2344</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">trace_to_subjaxpr_dynamic</span>                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2341 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>trace = DynamicJaxprTrace(main, core.cur_sublevel())                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2342 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers = _input_type_to_tracers(trace.new_arg, in_avals)                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2343 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>in_tracers_ = [t <span style="color: #0000ff; text-decoration-color: #0000ff">for</span> t, keep <span style="color: #ff00ff; text-decoration-color: #ff00ff">in</span> <span style="color: #00ffff; text-decoration-color: #00ffff">zip</span>(in_tracers, keep_inputs) <span style="color: #0000ff; text-decoration-color: #0000ff">if</span> keep]                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>2344 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>ans = fun.call_wrapped(*in_tracers_)                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2345 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>out_tracers = <span style="color: #00ffff; text-decoration-color: #00ffff">map</span>(trace.full_raise, ans)                                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>jaxpr, consts, attrs_tracked = frame.to_jaxpr(out_tracers)                            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2347 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">del</span> fun, main, trace, frame, in_tracers, out_tracers, ans                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">linear_util.py</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> :<span style="color: #0000ff; text-decoration-color: #0000ff">192</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">call_wrapped</span>                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">189 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>gen = gen_static_args = out_store = <span style="color: #0000ff; text-decoration-color: #0000ff">None</span>                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">190 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span>                                                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">191 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">try</span>:                                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>192 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>ans = <span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.f(*args, **<span style="color: #00ffff; text-decoration-color: #00ffff">dict</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.params, **kwargs))                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">193 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">except</span>:                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">194 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Some transformations yield from inside context managers, so we have to</span>             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">195 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># interrupt them before reraising the exception. Otherwise they will only</span>            <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">nansum</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">3</span>                                                                                      <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">nansum</span>(x):                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">2 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>mask = ~jnp.isnan(x)  <span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># boolean mask selecting non-nan values</span>                              <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>3 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>x_without_nans = x[mask]                                                                   <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> x_without_nans.sum()                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">5 </span>                                                                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">array_me</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">thods.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">736</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">op</span>                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">733 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">734 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_forward_operator_to_aval</span>(name):                                                       <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">735 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">op</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, *args):                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>736 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> <span style="color: #00ffff; text-decoration-color: #00ffff">getattr</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>.aval, <span style="color: #808000; text-decoration-color: #808000">f"_{</span>name<span style="color: #808000; text-decoration-color: #808000">}"</span>)(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, *args)                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">737 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> op                                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">738 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">739 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_forward_method_to_aval</span>(name):                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">array_me</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">thods.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">349</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_getitem</span>                                                                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">346 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">yield</span> lax.dynamic_slice_in_dim(x, num_chunks * size, tail)                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">347 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">348 </span><span style="color: #0000ff; text-decoration-color: #0000ff">def</span> <span style="color: #00ff00; text-decoration-color: #00ff00">_getitem</span>(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, item):                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>349 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> lax_numpy._rewriting_take(<span style="color: #00ffff; text-decoration-color: #00ffff">self</span>, item)                                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">350 </span>                                                                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">351 # Syntactic sugar for scatter operations.</span>                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">352 </span><span style="color: #0000ff; text-decoration-color: #0000ff">class</span> <span style="color: #00ff00; text-decoration-color: #00ff00; text-decoration: underline">_IndexUpdateHelper</span>:                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">4603</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_rewriting_take</span>                                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4600 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │     </span><span style="color: #00ffff; text-decoration-color: #00ffff">isinstance</span>(arr.shape[<span style="color: #0000ff; text-decoration-color: #0000ff">0</span>], <span style="color: #00ffff; text-decoration-color: #00ffff">int</span>)):                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4601 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> lax.dynamic_index_in_dim(arr, idx, keepdims=<span style="color: #0000ff; text-decoration-color: #0000ff">False</span>)                         <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4602 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>4603 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>treedef, static_idx, dynamic_idx = _split_index_for_jit(idx, arr.shape)                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4604 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #0000ff; text-decoration-color: #0000ff">return</span> _gather(arr, treedef, static_idx, dynamic_idx, indices_are_sorted,               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4605 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   │   │    </span>unique_indices, mode, fill_value)                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4606 </span>                                                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">4688</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_split_index_for_jit</span>                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4685 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4686 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># Expand any (concrete) boolean indices. We can then use advanced integer</span>               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4687 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># indexing logic to handle them.</span>                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>4688 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>idx = _expand_bool_indices(idx, shape)                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4689 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>                                                                                        <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4690 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>leaves, treedef = tree_flatten(idx)                                                     <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4691 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">  </span>dynamic = [<span style="color: #0000ff; text-decoration-color: #0000ff">None</span>] * <span style="color: #00ffff; text-decoration-color: #00ffff">len</span>(leaves)                                                          <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #bfbf7f; text-decoration-color: #bfbf7f">/home/evan/.pyenv/versions/3.11.9/envs/zeal/lib/python3.11/site-packages/jax/_src/numpy/</span><span style="color: #808000; text-decoration-color: #808000; font-weight: bold">lax_nump</span> <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #808000; text-decoration-color: #808000; font-weight: bold">y.py</span>:<span style="color: #0000ff; text-decoration-color: #0000ff">4986</span> in <span style="color: #00ff00; text-decoration-color: #00ff00">_expand_bool_indices</span>                                                                <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>                                                                                                  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4983 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span>                                                                                    <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4984 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">if</span> <span style="color: #ff00ff; text-decoration-color: #ff00ff">not</span> <span style="color: #00ffff; text-decoration-color: #00ffff">type</span>(abstract_i) <span style="color: #ff00ff; text-decoration-color: #ff00ff">is</span> ConcreteArray:                                           <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4985 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f"># TODO(mattjj): improve this error by tracking _why_ the indices are not concret</span>  <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span> <span style="color: #800000; text-decoration-color: #800000">❱ </span>4986 <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span><span style="color: #0000ff; text-decoration-color: #0000ff">raise</span> errors.NonConcreteBooleanIndexError(abstract_i)                             <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4987 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">elif</span> _ndim(i) == <span style="color: #0000ff; text-decoration-color: #0000ff">0</span>:                                                                 <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4988 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│   │   </span>out.append(<span style="color: #00ffff; text-decoration-color: #00ffff">bool</span>(i))                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">│</span>   <span style="color: #7f7f7f; text-decoration-color: #7f7f7f">4989 </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">│     </span><span style="color: #0000ff; text-decoration-color: #0000ff">else</span>:                                                                               <span style="color: #800000; text-decoration-color: #800000">│</span>
<span style="color: #800000; text-decoration-color: #800000">╰──────────────────────────────────────────────────────────────────────────────────────────────────╯</span>
<span style="color: #ff0000; text-decoration-color: #ff0000; font-weight: bold">NonConcreteBooleanIndexError: </span>Array boolean indices must be concrete; got <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">ShapedArray</span><span style="font-weight: bold">(</span>bool<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span><span style="font-weight: bold">])</span>

See <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://jax.readthedocs.io/en/latest/errors.html#jax.errors.NonConcreteBooleanIndexError</span>
</pre>
</div></div>
</div>
<p>The problem is that the size of <code class="docutils literal notranslate"><span class="pre">x_without_nans</span></code> is dependent on the values within <code class="docutils literal notranslate"><span class="pre">x</span></code>, which is another way of saying its size is <em>dynamic</em>.
Often in JAX it is possible to work-around the need for dynamically-sized arrays via other means.
For example, here it is possible to use the three-argument form of  <code class="docutils literal notranslate"><span class="pre">jnp.where</span></code> to replace the NaN values with zeros, thus computing the same result while avoiding dynamic shapes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">nansum_2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># boolean mask selecting non-nan values</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">nansum_2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.0
</pre></div>
</div>
</div>
</div>
<p>Similar tricks can be played in other situations where dynamically-shaped arrays occur.</p>
</section>
<section id="nans">
<h2>🔪 NaNs<a class="headerlink" href="#nans" title="Link to this heading">#</a></h2>
<section id="debugging-nans">
<h3>Debugging NaNs<a class="headerlink" href="#debugging-nans" title="Link to this heading">#</a></h3>
<p>If you want to trace where NaNs are occurring in your functions or gradients, you can turn on the NaN-checker by:</p>
<ul class="simple">
<li><p>setting the <code class="docutils literal notranslate"><span class="pre">JAX_DEBUG_NANS=True</span></code> environment variable;</p></li>
<li><p>adding <code class="docutils literal notranslate"><span class="pre">jax.config.update(&quot;jax_debug_nans&quot;,</span> <span class="pre">True)</span></code> near the top of your main file;</p></li>
<li><p>adding <code class="docutils literal notranslate"><span class="pre">jax.config.parse_flags_with_absl()</span></code> to your main file, then set the option using a command-line flag like <code class="docutils literal notranslate"><span class="pre">--jax_debug_nans=True</span></code>;</p></li>
</ul>
<p>This will cause computations to error-out immediately on production of a NaN. Switching this option on adds a nan check to every floating point type value produced by XLA. That means values are pulled back to the host and checked as ndarrays for every primitive operation not under an <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code>. For code under an <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code>, the output of every <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> function is checked and if a nan is present it will re-run the function in de-optimized op-by-op mode, effectively removing one level of <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> at a time.</p>
<p>There could be tricky situations that arise, like nans that only occur under a <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> but don’t get produced in de-optimized mode. In that case you’ll see a warning message print out but your code will continue to execute.</p>
<p>If the nans are being produced in the backward pass of a gradient evaluation, when an exception is raised several frames up in the stack trace you will be in the backward_pass function, which is essentially a simple jaxpr interpreter that walks the sequence of primitive operations in reverse. In the example below, we started an ipython repl with the command line <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">JAX_DEBUG_NANS=True</span> <span class="pre">ipython</span></code>, then ran this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="ne">FloatingPointError</span>                        <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">f2e2c413b437</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">jnp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">343</span>     <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">344</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">345</span>     <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">346</span>
    <span class="mi">347</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">332</span>   <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">333</span>   <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">334</span>                  <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">))</span>
    <span class="mi">335</span>
    <span class="mi">336</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">lax</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">244</span> <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="mi">245</span>   <span class="sa">r</span><span class="s2">&quot;&quot;&quot;Elementwise division: :math:`x \over y`.&quot;&quot;&quot;</span>
<span class="o">--&gt;</span> <span class="mi">246</span>   <span class="k">return</span> <span class="n">div_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">247</span>
    <span class="mi">248</span> <span class="k">def</span> <span class="nf">rem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

<span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">interpreters</span><span class="o">/</span><span class="n">xla</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">handle_result</span><span class="p">(</span><span class="n">device_buffer</span><span class="p">)</span>
    <span class="mi">103</span>         <span class="n">py_val</span> <span class="o">=</span> <span class="n">device_buffer</span><span class="o">.</span><span class="n">to_py</span><span class="p">()</span>
    <span class="mi">104</span>         <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">py_val</span><span class="p">)):</span>
<span class="o">--&gt;</span> <span class="mi">105</span>           <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="s2">&quot;invalid value&quot;</span><span class="p">)</span>
    <span class="mi">106</span>         <span class="k">else</span><span class="p">:</span>
    <span class="mi">107</span>           <span class="k">return</span> <span class="n">Array</span><span class="p">(</span><span class="n">device_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">result_shape</span><span class="p">)</span>

<span class="ne">FloatingPointError</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">value</span>
</pre></div>
</div>
<p>The nan generated was caught. By running <code class="docutils literal notranslate"><span class="pre">%debug</span></code>, we can get a post-mortem debugger. This also works with functions under <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code>, as the example below shows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nd">@jit</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">Invalid</span> <span class="n">value</span> <span class="n">encountered</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">a</span> <span class="n">jit</span> <span class="n">function</span><span class="o">.</span> <span class="n">Calling</span> <span class="n">the</span> <span class="n">de</span><span class="o">-</span><span class="n">optimized</span> <span class="n">version</span><span class="o">.</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="ne">FloatingPointError</span>                        <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">811</span><span class="n">b7ddb3300</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

 <span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">619</span><span class="n">b39acbaac</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
      <span class="mi">2</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
      <span class="mi">3</span>     <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<span class="o">----&gt;</span> <span class="mi">4</span>     <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
      <span class="mi">5</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="mi">6</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">343</span>     <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">344</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">345</span>     <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">346</span>
    <span class="mi">347</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">332</span>   <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">333</span>   <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">334</span>                  <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">))</span>
    <span class="mi">335</span>
    <span class="mi">336</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">lax</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">244</span> <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="mi">245</span>   <span class="sa">r</span><span class="s2">&quot;&quot;&quot;Elementwise division: :math:`x \over y`.&quot;&quot;&quot;</span>
<span class="o">--&gt;</span> <span class="mi">246</span>   <span class="k">return</span> <span class="n">div_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">247</span>
    <span class="mi">248</span> <span class="k">def</span> <span class="nf">rem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

 <span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>
</pre></div>
</div>
<p>When this code sees a nan in the output of an <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> function, it calls into the de-optimized code, so we still get a clear stack trace. And we can run a post-mortem debugger with <code class="docutils literal notranslate"><span class="pre">%debug</span></code> to inspect all the values to figure out the error.</p>
<p>⚠️ You shouldn’t have the NaN-checker on if you’re not debugging, as it can introduce lots of device-host round-trips and performance regressions!</p>
<p>⚠️ The NaN-checker doesn’t work with <code class="docutils literal notranslate"><span class="pre">pmap</span></code>. To debug nans in <code class="docutils literal notranslate"><span class="pre">pmap</span></code> code, one thing to try is replacing <code class="docutils literal notranslate"><span class="pre">pmap</span></code> with <code class="docutils literal notranslate"><span class="pre">vmap</span></code>.</p>
</section>
</section>
<section id="double-64bit-precision">
<h2>🔪 Double (64bit) precision<a class="headerlink" href="#double-64bit-precision" title="Link to this heading">#</a></h2>
<p>At the moment, JAX by default enforces single-precision numbers to mitigate the Numpy API’s tendency to aggressively promote operands to <code class="docutils literal notranslate"><span class="pre">double</span></code>.  This is the desired behavior for many machine-learning applications, but it may catch you by surprise!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_11740/1258726447.py:1: UserWarning: Explicitly requested dtype &lt;class &#39;jax.numpy.float64&#39;&gt;  is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  x = random.uniform(random.key(0), (1000,), dtype=jnp.float64)
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">dtype</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Green">&#39;float32&#39;</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>To use double-precision numbers, you need to set the <code class="docutils literal notranslate"><span class="pre">jax_enable_x64</span></code> configuration variable <strong>at startup</strong>.</p>
<p>There are a few ways to do this:</p>
<ol class="arabic">
<li><p>You can enable 64-bit mode by setting the environment variable <code class="docutils literal notranslate"><span class="pre">JAX_ENABLE_X64=True</span></code>.</p></li>
<li><p>You can manually set the <code class="docutils literal notranslate"><span class="pre">jax_enable_x64</span></code> configuration flag at startup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># again, this only works on startup!</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>You can parse command-line flags with <code class="docutils literal notranslate"><span class="pre">absl.app.run(main)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config_with_absl</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>If you want JAX to run absl parsing for you, i.e. you don’t want to do <code class="docutils literal notranslate"><span class="pre">absl.app.run(main)</span></code>, you can instead use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="c1"># calls jax.config.config_with_absl() *and* runs absl parsing</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parse_flags_with_absl</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
<p>Note that #2-#4 work for <em>any</em> of JAX’s configuration options.</p>
<p>We can then confirm that <code class="docutils literal notranslate"><span class="pre">x64</span></code> mode is enabled:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="c1"># --&gt; dtype(&#39;float64&#39;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_11740/2819792939.py:3: UserWarning: Explicitly requested dtype &lt;class &#39;jax.numpy.float64&#39;&gt;  is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  x = random.uniform(random.key(0), (1000,), dtype=jnp.float64)
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">dtype</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Green">&#39;float32&#39;</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<section id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Link to this heading">#</a></h3>
<p>⚠️ XLA doesn’t support 64-bit convolutions on all backends!</p>
</section>
</section>
<section id="miscellaneous-divergences-from-numpy">
<h2>🔪 Miscellaneous Divergences from NumPy<a class="headerlink" href="#miscellaneous-divergences-from-numpy" title="Link to this heading">#</a></h2>
<p>While <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> makes every attempt to replicate the behavior of numpy’s API, there do exist corner cases where the behaviors differ.
Many such cases are discussed in detail in the sections above; here we list several other known places where the APIs diverge.</p>
<ul>
<li><p>For binary operations, JAX’s type promotion rules differ somewhat from those used by NumPy. See <a class="reference external" href="https://jax.readthedocs.io/en/latest/type_promotion.html">Type Promotion Semantics</a> for more details.</p></li>
<li><p>When performing unsafe type casts (i.e. casts in which the target dtype cannot represent the input value), JAX’s behavior may be backend dependent, and in general may diverge from NumPy’s behavior. Numpy allows control over the result in these scenarios via the <code class="docutils literal notranslate"><span class="pre">casting</span></code> argument (see <a class="reference external" href="https://numpy.org/devdocs/reference/generated/numpy.ndarray.astype.html"><code class="docutils literal notranslate"><span class="pre">np.ndarray.astype</span></code></a>); JAX does not provide any such configuration, instead directly inheriting the behavior of <a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics#convertelementtype">XLA:ConvertElementType</a>.</p>
<p>Here is an example of an unsafe cast with differing results between NumPy and JAX:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">254.0</span><span class="p">,</span> <span class="mf">258.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
<span class="go">array([254, 255,   0,   1], dtype=uint8)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">254.0</span><span class="p">,</span> <span class="mf">258.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
<span class="go">Array([254, 255, 255, 255], dtype=uint8)</span>
</pre></div>
</div>
<p>This sort of mismatch would typically arise when casting extreme values from floating to integer types or vice versa.</p>
</li>
</ul>
</section>
<section id="fin">
<h2>Fin.<a class="headerlink" href="#fin" title="Link to this heading">#</a></h2>
<p>If something’s not covered here that has caused you weeping and gnashing of teeth, please let us know and we’ll extend these introductory <em>advisos</em>!</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="thinking_in_jax.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">How to Think in JAX</p>
      </div>
    </a>
    <a class="right-next"
       href="../faq.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">JAX Frequently Asked Questions (FAQ)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pure-functions">🔪 Pure functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-place-updates">🔪 In-Place Updates</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#array-updates-x-at-idx-set-y">Array updates: <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#array-updates-with-other-operations">Array updates with other operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#out-of-bounds-indexing">🔪 Out-of-Bounds Indexing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-array-inputs-numpy-vs-jax">🔪 Non-array inputs: NumPy vs. JAX</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-numbers">🔪 Random Numbers</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rngs-and-state">RNGs and State</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jax-prng">JAX PRNG</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#control-flow">🔪 Control Flow</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-control-flow-autodiff">✔ python control_flow + autodiff ✔</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-control-flow-jit">python control flow + JIT</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structured-control-flow-primitives">Structured control flow primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cond"><code class="docutils literal notranslate"><span class="pre">cond</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#while-loop"><code class="docutils literal notranslate"><span class="pre">while_loop</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fori-loop"><code class="docutils literal notranslate"><span class="pre">fori_loop</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-shapes">🔪 Dynamic Shapes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nans">🔪 NaNs</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-nans">Debugging NaNs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#double-64bit-precision">🔪 Double (64bit) precision</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#caveats">Caveats</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#miscellaneous-divergences-from-numpy">🔪 Miscellaneous Divergences from NumPy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fin">Fin.</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The JAX authors
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>